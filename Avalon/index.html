{% extends "base.html" %}

{% block title %}é˜¿ç“¦éš† - é˜µè¥æ¨ç† Â· èº«ä»½éšè—{% endblock %}

{% block extra_head %}
<style>

            @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Serif+SC:wght@700;900&display=swap');

            /* åŠ¨ç”»å…³é”®å¸§å®šä¹‰ */
            @keyframes swordDrop {
                0% {
                    transform: translateY(-200px);
                    opacity: 0;
                    filter: drop-shadow(0 0 0px rgba(255, 255, 255, 0));
                }

                60% {
                    transform: translateY(10px);
                    opacity: 1;
                }

                80% {
                    transform: translateY(-5px);
                }

                100% {
                    transform: translateY(0);
                    opacity: 1;
                    filter: drop-shadow(0 0 15px rgba(226, 232, 240, 0.4));
                }
            }

            @keyframes shieldFadeIn {
                0% {
                    transform: scale(0.9);
                    opacity: 0;
                }

                50% {
                    opacity: 0;
                }

                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            @keyframes bannerExpand {
                0% {
                    transform: scaleX(0);
                    opacity: 0;
                }

                70% {
                    transform: scaleX(0);
                    opacity: 0;
                }

                100% {
                    transform: scaleX(1);
                    opacity: 1;
                }
            }

            @keyframes textReveal {
                0% {
                    opacity: 0;
                    filter: blur(10px);
                    transform: translateY(10px);
                }

                80% {
                    opacity: 0;
                    filter: blur(10px);
                    transform: translateY(10px);
                }

                100% {
                    opacity: 1;
                    filter: blur(0px);
                    transform: translateY(0);
                }
            }

            @keyframes pulseBlue {

                0%,
                100% {
                    fill-opacity: 0.6;
                    filter: drop-shadow(0 0 10px rgba(37, 99, 235, 0.5));
                }

                50% {
                    fill-opacity: 0.9;
                    filter: drop-shadow(0 0 25px rgba(37, 99, 235, 0.9));
                }
            }

            @keyframes pulseRed {

                0%,
                100% {
                    fill-opacity: 0.6;
                    filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.5));
                }

                50% {
                    fill-opacity: 0.9;
                    filter: drop-shadow(0 0 25px rgba(220, 38, 38, 0.9));
                }
            }

            @keyframes particleFloat {
                0% {
                    transform: translateY(0) scale(1);
                    opacity: 0;
                }

                20% {
                    opacity: 0.8;
                }

                80% {
                    opacity: 0.6;
                }

                100% {
                    transform: translateY(-80px) scale(0.3);
                    opacity: 0;
                }
            }

            /* å…ƒç´ ç±»æ ·å¼åˆ†é… */
            .anim-sword {
                animation: swordDrop 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
                transform-origin: center;
            }

            .anim-shield {
                animation: shieldFadeIn 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
                transform-origin: center;
            }

            .anim-banner {
                animation: bannerExpand 2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
                transform-origin: center;
            }

            .anim-text {
                animation: textReveal 2.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            }

            .shield-blue-side {
                animation: pulseBlue 4s infinite alternate ease-in-out;
            }

            .shield-red-side {
                animation: pulseRed 4s infinite alternate ease-in-out;
            }

            .particle {
                opacity: 0;
                animation: particleFloat 3s infinite linear;
            }

            /* æ–‡æœ¬æ ·å¼ */
            .text-eng-sub {
                font-family: 'Cinzel', serif;
                font-weight: 700;
                font-size: 16px;
                fill: #94a3b8;
                letter-spacing: 12px;
                text-anchor: middle;
            }

            .text-eng-main {
                font-family: 'Cinzel', serif;
                font-weight: 900;
                font-size: 56px;
                fill: url(#gold-grad);
                letter-spacing: 20px;
                text-anchor: middle;
                /* ä¿®å¤letter-spacingå¯¼è‡´çš„åç§» */
                transform: translateX(10px);
            }

            .text-zh-main {
                font-family: 'Noto Serif SC', serif;
                font-weight: 900;
                font-size: 32px;
                fill: url(#gold-grad-light);
                letter-spacing: 24px;
                text-anchor: middle;
                transform: translateX(12px);
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
            }
        
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Serif+SC:wght@700;900&display=swap" rel="stylesheet">
<style>
    body {
        padding-bottom: 80px;
    }

    /* ---- Page Hero ---- */

    .role-img {
        max-height: 280px;
        border-radius: 16px;
        margin-bottom: var(--space-md);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s;
    }

    .role-img:hover {
        transform: scale(1.03) translateY(-4px);
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.25);
    }

    .vision-intel-card {
        position: relative;
        overflow: hidden;
        border-radius: 28px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(18, 18, 18, 0.72);
        backdrop-filter: saturate(180%) blur(24px);
        -webkit-backdrop-filter: saturate(180%) blur(24px);
        box-shadow: 
            inset 0 1px 1px rgba(255, 255, 255, 0.1),
            0 24px 48px rgba(0, 0, 0, 0.5);
        animation: visionReveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    @keyframes visionReveal {
        0% { opacity: 0; transform: translateY(20px) scale(0.98); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .vision-intel-card::before,
    .vision-intel-card::after {
        content: "";
        position: absolute;
        border-radius: 999px;
        filter: blur(60px);
        pointer-events: none;
        opacity: 0;
        z-index: 1;
    }

    .vision-intel-content {
        position: relative;
        z-index: 2;
        min-height: 240px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 32px 24px 20px;
    }

    .vision-intel-title {
        margin-top: auto;
        color: #f5f5f7;
        font-size: clamp(1.8rem, 5vw, 2.4rem);
        line-height: 1.05;
        font-weight: 900;
        letter-spacing: -0.02em;
        font-family: "Noto Serif SC", serif;
        text-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        background: linear-gradient(180deg, #ffffff 0%, rgba(255,255,255,0.8) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .vision-intel-subtitle {
        margin-top: 10px;
        color: rgba(245, 245, 247, 0.6);
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .vision-intel-names {
        margin-top: auto;
        color: #ffffff;
        font-size: 1.05rem;
        letter-spacing: -0.01em;
        font-weight: 700;
        padding: 12px 12px 4px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* ---- Character Themes (Refined) ---- */

    .vision-theme-evil-team::before {
        width: 380px;
        height: 380px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(255, 69, 58, 0.7) 0%, rgba(255, 69, 58, 0.2) 40%, rgba(255, 69, 58, 0) 70%);
        opacity: 1;
    }

    .vision-theme-merlin::before {
        width: 380px;
        height: 380px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(255, 214, 10, 0.6) 0%, rgba(255, 159, 10, 0.2) 45%, rgba(255, 159, 10, 0) 70%);
        opacity: 1;
    }

    .vision-theme-percival::before {
        width: 320px;
        height: 320px;
        left: -40px;
        top: -60px;
        background: radial-gradient(circle, rgba(191, 90, 242, 0.6) 0%, rgba(191, 90, 242, 0.2) 40%, rgba(191, 90, 242, 0) 70%);
        opacity: 1;
    }

    .vision-theme-percival::after {
        width: 340px;
        height: 340px;
        right: -60px;
        bottom: -80px;
        background: radial-gradient(circle, rgba(10, 132, 255, 0.6) 0%, rgba(10, 132, 255, 0.2) 45%, rgba(10, 132, 255, 0) 70%);
        opacity: 1;
    }

    .vision-theme-oberon::before {
        width: 380px;
        height: 380px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(142, 142, 147, 0.3) 0%, rgba(142, 142, 147, 0.1) 40%, rgba(142, 142, 147, 0) 70%);
        opacity: 1;
    }

    .vision-theme-loyal::before {
        width: 360px;
        height: 360px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(245, 245, 247, 0.15) 0%, rgba(245, 245, 247, 0.05) 30%, rgba(245, 245, 247, 0) 70%);
        opacity: 1;
    }

    .vision-theme-lancelot-good::before {
        width: 380px;
        height: 380px;
        left: 45%;
        top: 45%;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(10, 132, 255, 0.65) 0%, rgba(10, 132, 255, 0.2) 40%, rgba(10, 132, 255, 0) 70%);
        opacity: 1;
    }

    .vision-theme-lancelot-good::after {
        width: 200px;
        height: 200px;
        right: -60px;
        bottom: -60px;
        background: radial-gradient(circle, rgba(255, 69, 58, 0.3) 0%, rgba(255, 69, 58, 0.1) 40%, rgba(255, 69, 58, 0) 70%);
        opacity: 1;
    }

    .vision-theme-lancelot-evil::before {
        width: 360px;
        height: 360px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: radial-gradient(circle, rgba(255, 59, 48, 0.65) 0%, rgba(255, 59, 48, 0.2) 40%, rgba(255, 59, 48, 0) 70%);
        opacity: 1;
    }

    .vision-theme-lancelot-evil::after {
        width: 300px;
        height: 300px;
        right: -50px;
        top: -60px;
        background: radial-gradient(circle, rgba(94, 92, 230, 0.5) 0%, rgba(48, 176, 199, 0.2) 40%, rgba(94, 92, 230, 0) 70%);
        opacity: 1;
    }

    .vision-alert-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 0.8rem;
        color: #ffffff;
    }

    .team-display {
        background: var(--apple-bg);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        text-align: center;
        margin: var(--space-md) 0;
    }

    .team-display .names {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--apple-black);
        letter-spacing: -0.02em;
    }

    .vote-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: var(--space-lg);
    }

    .vote-overlay h2 {
        color: white;
        margin-bottom: var(--space-xl);
        font-size: 1.8rem;
        letter-spacing: -0.04em;
    }

    .vote-team-box,
    .lady-result-box {
        background: rgba(40, 40, 44, 0.85);
        backdrop-filter: blur(20px);
        padding: var(--space-lg) var(--space-xl);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-xl);
        text-align: center;
        width: 85%;
        max-width: 340px;
        box-shadow: var(--shadow-lg);
        color: white;
    }

    .vote-team-box strong {
        font-size: 1.4rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: white;
    }

    .lady-result-box .alignment-good {
        color: var(--apple-blue);
        font-size: 2rem;
        font-weight: 800;
        margin-top: 10px;
    }

    .lady-result-box .alignment-evil {
        color: var(--apple-red);
        font-size: 2rem;
        font-weight: 800;
        margin-top: 10px;
    }

    .vote-btn-big {
        width: 85%;
        max-width: 320px;
        padding: 16px;
        border-radius: var(--radius-xl);
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.01em;
        border: none;
        margin: 8px 0;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-family: var(--font-family);
        background: rgba(255, 255, 255, 0.15);
        color: white;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }

    .vote-btn-big.green {
        background: var(--apple-green);
    }

    .vote-btn-big.red {
        background: var(--apple-red);
    }

    .vote-btn-big.blue {
        background: var(--apple-blue);
    }

    .vote-btn-big:active {
        transform: scale(0.96);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .vote-btn-big:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    }

    .vote-btn-big:disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    .lady-target-btn {
        padding: 16px;
        border-radius: 20px;
        font-size: 1.15rem;
        font-weight: 700;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        width: 100%;
    }

    .lady-target-btn:not(:disabled):hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
    }

    .lady-target-btn:not(:disabled):active {
        transform: scale(0.96);
    }

    .lady-target-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 85%;
        max-width: 320px;
    }

    .error-toast {
        position: fixed;
        top: 24px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20000;
        padding: 14px 28px;
        border-radius: 30px;
        background: rgba(255, 59, 48, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 0.95rem;
        font-weight: 600;
        box-shadow: 0 12px 24px rgba(255, 59, 48, 0.3);
        letter-spacing: -0.01em;
    }

    .count-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-lg);
        margin: var(--space-lg) 0;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 24px;
        padding: 12px;
    }

    .count-control .count-display {
        font-size: 2.5rem;
        font-weight: 800;
        min-width: 60px;
        text-align: center;
        letter-spacing: -0.04em;
        color: var(--apple-black);
    }

    .count-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: var(--apple-white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        font-size: 1.5rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        color: var(--apple-blue);
    }

    .count-btn:active {
        transform: scale(0.9);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .config-preview {
        background: rgba(0, 0, 0, 0.03);
        border-radius: 16px;
        padding: var(--space-lg);
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--apple-gray);
        margin-bottom: var(--space-lg);
        line-height: 1.6;
    }

    .status-box {
        text-align: center;
        padding: var(--space-2xl) 0;
    }

    .status-count {
        font-size: 4rem;
        font-weight: 800;
        color: var(--apple-black);
        letter-spacing: -0.04em;
    }

    .status-count .total {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--apple-gray);
    }

    .chips-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .apple-chip {
        padding: 8px 16px;
        font-size: 0.9rem;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        font-weight: 600;
    }

    .lb-section {
        padding: var(--space-xl) 0;
    }

    .lb-title {
        font-size: 1.4rem;
        font-weight: 800;
        text-align: center;
        margin-bottom: var(--space-md);
        letter-spacing: -0.03em;
    }



    .lancelot-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        margin: var(--space-md) 0;
        font-size: 0.9rem;
    }

    .lancelot-toggle label {
        cursor: pointer;
        color: var(--apple-gray);
        font-weight: 600;
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        inset: 0;
        background: var(--apple-gray-light);
        border-radius: 30px;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked+.toggle-slider {
        background: var(--apple-blue);
    }

    .toggle-switch input:checked+.toggle-slider::before {
        transform: translateX(20px);
    }

    .apple-dot {
        position: relative;
    }

    .swap-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        font-size: 0.6rem;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--apple-orange);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .swap-badge.no-swap {
        background: var(--apple-gray-light);
        color: var(--apple-gray);
    }

    .alignment-swap-indicator {
        display: inline-block;
        animation: pulse-glow 1.5s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    @keyframes pulseSwap {
        0% { box-shadow: 0 0 0 0 rgba(255, 149, 0, 0.6); }
        70% { box-shadow: 0 0 0 12px rgba(255, 149, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 149, 0, 0); }
    }

    .apple-dot.swap-active {
        animation: pulseSwap 2s infinite;
    }

    /* åªæœ‰åœ¨æ²¡æœ‰ç»“æœæ—¶æ‰æ˜¾ç¤ºæ©™è‰²è¾¹æ¡† */
    .apple-dot.swap-active:not(.success):not(.fail) {
        border-color: var(--apple-orange) !important;

    }

    .reveal-list {
        list-style: none;
        padding: 0;
    }

    .reveal-list li {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.06);
        font-size: 1rem;
    }

    .reveal-list li:last-child {
        border-bottom: none;
    }

    .apple-toggle-input:checked+.apple-toggle-btn {
        background: var(--apple-blue);
        border-color: var(--apple-blue);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
    }

    .apple-btn-primary {
        box-shadow: 0 4px 14px rgba(0, 113, 227, 0.3);
    }

    .apple-btn-success {
        box-shadow: 0 4px 14px rgba(52, 199, 89, 0.3);
    }

    /* Transitions */
    .fade-enter-active,
    .fade-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .fade-enter-from,
    .fade-leave-to {
        opacity: 0;
        transform: translateY(12px) scale(0.98);
    }

    .overlay-enter-active,
    .overlay-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), backdrop-filter 0.4s;
    }

    .overlay-enter-from,
    .overlay-leave-to {
        opacity: 0;
        backdrop-filter: blur(0px);
    }

    .slide-up-enter-active,
    .slide-up-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .slide-up-enter-from,
    .slide-up-leave-to {
        opacity: 0;
        transform: translateY(20px);
    }

    /* ---- ç»“ç®—ç•Œé¢ Apple é£æ ¼ä¼˜åŒ– ---- */
    .victory-hero {
        font-size: 4.5rem;
        margin-bottom: 8px;
        filter: drop-shadow(0 8px 16px rgba(0,0,0,0.1));
    }

    .victory-title {
        font-size: clamp(2.2rem, 6vw, 3.2rem);
        font-weight: 900;
        letter-spacing: -0.04em;
        margin-bottom: 8px;
        background-clip: text;
        -webkit-background-clip: text;
    }

    .victory-blue {
        background-image: linear-gradient(135deg, #0071e3 0%, #4facfe 100%);
        color: transparent;
    }

    .victory-red {
        background-image: linear-gradient(135deg, #ff3b30 0%, #ff8008 100%);
        color: transparent;
    }

    .assassin-result {
        display: inline-flex;
        align-items: center;
        padding: 10px 24px;
        background: rgba(255, 59, 48, 0.08);
        border-radius: 30px;
        color: var(--apple-red);
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: var(--space-xl);
        box-shadow: inset 0 0 0 1px rgba(255, 59, 48, 0.15), 0 8px 16px rgba(255, 59, 48, 0.08);
    }

    .reveal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 12px;
        margin-bottom: var(--space-2xl);
    }

    .reveal-card {
        background: rgba(128, 128, 128, 0.06);
        border-radius: 20px;
        padding: 20px 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), background 0.4s;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .reveal-card:hover {
        transform: translateY(-4px) scale(1.02);
        background: rgba(128, 128, 128, 0.1);
    }

    .reveal-card .name {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--apple-black);
        letter-spacing: -0.01em;
    }

    .reveal-card .role {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    @media (prefers-color-scheme: dark) {
        .reveal-card .role { background: rgba(0, 0, 0, 0.25); }
        .reveal-card .name { color: #f5f5f7; }
    }

    .apple-btn-pill {
        border-radius: 999px;
        padding: 16px 24px;
        font-weight: 600;
        font-size: 1.15rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .action-buttons-group {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-bottom: var(--space-xl);
    }

    @media (max-width: 480px) {
        .action-buttons-group { flex-direction: column; }
    }
</style>
{% endblock %}

{% block nav_title %}
<i class="ph-fill ph-shield-check text-blue" style="margin-right: 4px;"></i> é˜¿ç“¦éš†
{% endblock %}

{% block content %}
{% raw %}
<div id="app" class="bg-transition-slow" :class="{'bg-phase-vote': voteTeamActive, 'bg-phase-mission': missionActive}" v-cloak>

    <!-- Hero -->
    <div class="game-header-wrapper" v-pre>
        {% endraw %}
        {% include 'header.svg' %}
        {% raw %}
    </div>

    <!-- Error Toast -->
    <transition name="slide-up">
        <div v-if="errorMsg" class="error-toast">{{ errorMsg }}</div>
    </transition>

    <style>
        /* Setup switch style specific overrides */
        #lady-toggle-input:checked+.toggle-slider {
            background: var(--apple-purple, #af52de) !important;
        }
    </style>

    <!-- Step 1: Join / Setup -->
    <div v-if="step === 1" class="apple-section">

        <div v-if="status === 'empty' || status === 'ended'" class="apple-card">
            <h4 class="mb-md">åˆ›å»ºæ–°æˆ¿é—´</h4>
            <p class="text-sm text-muted mb-md">æ ‡å‡†åŒ…é…ç½®</p>

            <div class="count-control">
                <button class="count-btn" @click="decrementPlayerCount()">âˆ’</button>
                <div class="count-display">{{ playerCount }}</div>
                <button class="count-btn" @click="incrementPlayerCount()">+</button>
            </div>

            <!-- æ¹–ä¸­ä»™å¥³å¼€å…³ (8äººå±€åŠä»¥ä¸Š) -->
            <div v-if="playerCount >= 8" class="lancelot-toggle">
                <span>ğŸ§š å¯ç”¨æ¹–ä¸­ä»™å¥³</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="lady-toggle-input" v-model="ladyOfLakeEnabled">
                    <label for="lady-toggle-input" class="toggle-slider"></label>
                </div>
            </div>

            <!-- ç‹è€…ä¹‹å‰‘å¼€å…³ (8-12äººå±€å¯é€‰) -->
            <div v-if="playerCount >= 8" class="lancelot-toggle">
                <span>ğŸ—¡ï¸ å¯ç”¨ç‹è€…ä¹‹å‰‘</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="excalibur-toggle-input" v-model="excaliburEnabled">
                    <label for="excalibur-toggle-input" class="toggle-slider"></label>
                </div>
            </div>

            <!-- å…°æ–¯æ´›ç‰¹å¼€å…³ (10äººå’Œ12äººå±€) -->
            <div v-if="playerCount === 10 || playerCount === 12" class="lancelot-toggle">
                <span>âš”ï¸ å¯ç”¨å…°æ–¯æ´›ç‰¹</span>
                <div class="toggle-switch" :style="playerCount === 12 ? 'opacity: 0.6; pointer-events: none;' : ''">
                    <input type="checkbox" id="lancelot-toggle-input" v-model="lancelotEnabled"
                        :disabled="playerCount === 12">
                    <label for="lancelot-toggle-input" class="toggle-slider"></label>
                </div>
            </div>

            <div class="config-preview" v-html="getConfigPreview()"></div>

            <button class="apple-btn apple-btn-success apple-btn-block apple-btn-lg" @click="createGame">å¼€æ–°å±€</button>
        </div>

        <div class="apple-card">
            <h4 class="mb-md">åŠ å…¥æ¸¸æˆ</h4>
            <input v-model="myName" class="apple-input mb-md" placeholder="è¾“å…¥ä½ çš„å§“å">

            <div v-if="status === 'joining'" class="apple-alert apple-alert-info mb-md">
                <div class="d-flex justify-between items-center">
                    <span class="apple-tag apple-tag-blue">ç­‰å¾…ä¸­</span>
                    <span class="fw-700">{{ currentCount }} / {{ targetCount }} äºº</span>
                </div>
                <div class="text-muted text-sm mt-sm">å·²åŠ å…¥: {{ allPlayers.join(', ') }}</div>
            </div>

            <div v-if="status === 'joining'">
                <button class="apple-btn apple-btn-primary apple-btn-block" @click="joinGame"
                    :disabled="!myName">åŠ å…¥æˆ¿é—´</button>
            </div>
            <div v-if="status === 'active' || status === 'assassin' || status === 'ended'">
                <div class="apple-alert apple-alert-info mb-md">æ¸¸æˆå·²å¼€å§‹æˆ–å·²ç»“æŸï¼Œè¾“å…¥åå­—è¿›å…¥</div>
                <button class="apple-btn apple-btn-primary apple-btn-block" style="background: var(--apple-orange);"
                    @click="joinGame" :disabled="!myName">è¿›å…¥æˆ¿é—´</button>
            </div>
            <div v-if="status === 'empty'" class="text-center text-muted" style="padding: var(--space-lg) 0;">
                å½“å‰æ— æˆ¿é—´ï¼Œè¯·å…ˆåˆ›å»º
            </div>
        </div>
    </div>

    <!-- Avalon Leaderboard -->
    <div v-if="step === 1" id="inline-leaderboard-section">
        <div class="section-title" style="margin-top: var(--space-xl); margin-bottom: var(--space-md);">ğŸ† å†å²æ’è¡Œæ¦œ
        </div>
        <div class="apple-list mb-xl">
            <div v-if="lbData.length === 0" class="text-center text-muted" style="padding: var(--space-xl);">
                <div class="empty-state">
                    <span class="empty-icon">ğŸ‘»</span>
                    è¿˜æ²¡äººç©è¿‡å‘¢ï¼Œå¿«å»å¼€ä¸€å±€ï¼
                </div>
            </div>
            <div v-else>
                <div v-for="(p, i) in lbData" :key="p.name" class="apple-list-item">
                    <div class="rank-num"
                        :class="i === 0 ? 'rank-1' : (i === 1 ? 'rank-2' : (i === 2 ? 'rank-3' : 'rank-other'))">
                        {{ i === 0 ? 'ğŸ‘‘' : i + 1 }}
                    </div>

                    <div class="apple-list-item-content">
                        <div class="apple-list-item-title">{{ p.name }}</div>
                    </div>

                    <div style="text-align: right; display: flex; align-items: center; gap: 16px;">
                        <div style="text-align: right;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">èƒœè´Ÿ</div>
                            <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">{{ p.wins
                                }}-{{ p.total - p.wins }}</div>
                        </div>
                        <div style="text-align: right; width: 60px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">èƒœç‡</div>
                            <div class="score-badge" style="font-size: 1.2rem; color: var(--apple-green);">{{ p.win_rate
                                }}%</div>
                        </div>
                        <div style="text-align: right; width: 40px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">åœºæ¬¡</div>
                            <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">{{ p.total }}å±€
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Lobby -->
    <div v-if="step === 2" class="apple-section">
        <div class="apple-card">
            <div v-if="status === 'joining'" class="status-box">
                <p class="text-muted mb-sm">ç­‰å¾…ç©å®¶åŠ å…¥...</p>
                <div class="status-count">{{ currentCount }} <span class="total">/ {{ targetCount }}</span>
                </div>
                <div class="d-flex justify-center mt-md">
                    <div class="apple-spinner"></div>
                </div>
                <p class="text-sm text-muted mt-md">æ»¡å‘˜åè‡ªåŠ¨å‘ç‰Œå¼€å§‹</p>
            </div>
            <div v-else-if="status === 'active'" class="status-box">
                <h3 class="text-green">æ¸¸æˆå¼€å§‹!</h3>
            </div>

            <div class="chips-wrap mt-md">
                <span v-for="p in allPlayers" class="apple-chip" :class="{me: p===myName}">{{ p }}</span>
            </div>

            <div class="text-center mt-lg"
                style="border-top: 0.5px solid rgba(0,0,0,0.06); padding-top: var(--space-md);">
                <button class="apple-btn apple-btn-sm apple-btn-outline"
                    style="color: var(--apple-red); border-color: rgba(255,59,48,0.3);" @click="resetGame">é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <!-- Step 3: Main Game -->
    <div v-if="step === 3 && status !== 'ended'" class="apple-section" style="padding-top: var(--space-md);">

        <!-- Identity -->
        <div class="apple-card mb-md">
            <div class="d-flex justify-between items-center mb-md">
                <h5 style="margin:0;">ä½ çš„èº«ä»½</h5>
                <button class="apple-btn apple-btn-sm apple-btn-secondary" @click="showRole=!showRole">{{
                    showRole?'éšè—':'æ˜¾ç¤º' }}</button>
            </div>
            <div v-if="showRole">
                <div class="apple-role" :class="isCurrentlyEvil() ? 'evil' : 'good'">
                    <img :src="getRoleImage(myRole)" class="role-img role-card-anim" v-if="myRole"
                        style="display:block; margin:0 auto;">
                    <div style="font-size:1.2rem;">{{ roleMap[myRole] || myRole }}</div>
                    <!-- å…°æ–¯æ´›ç‰¹é˜µè¥çŠ¶æ€ -->
                    <div v-if="currentAlignment" class="mt-sm text-sm"
                        :class="currentAlignment === 'evil' ? 'text-red' : 'text-blue'">
                        <span :class="{'alignment-swap-indicator': lancelotSwapped}">
                            {{ currentAlignment === 'evil' ? 'âš¡ å½“å‰é˜µè¥: é‚ªæ¶' : 'ğŸ›¡ï¸ å½“å‰é˜µè¥: æ­£ä¹‰' }}
                        </span>
                    </div>
                </div>
                <div class="mt-md">
                    <div class="fw-600 text-sm mb-sm">ä½ çš„è§†é‡</div>
                    <div class="vision-intel-card" :class="getVisionThemeClass()">
                        <div class="vision-intel-content">
                            <div class="vision-intel-title">{{ getVisionPanelMeta().title }}</div>
                            <div class="vision-intel-subtitle">
                                {{ getVisionPanelMeta().subtitle }}
                            </div>
                            <div class="vision-intel-names">{{ getVisionNamesText() }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assassin Phase -->
        <div v-if="status === 'assassin'" class="apple-card text-center mb-md" style="border: 2px solid var(--apple-red);">
            <h3 class="text-red mb-lg"><i class="ph-fill ph-skull"></i> åˆºæ€é˜¶æ®µ</h3>
            <p class="text-muted mb-lg">å¥½äººå®Œæˆäº†3ä¸ªä»»åŠ¡ï¼{{ getAssassinRoleName() }}æ­£åœ¨é€‰æ‹©åˆºæ€ç›®æ ‡...</p>

            <div v-if="canAssassinate()">
                <h5 class="mb-md">é€‰æ‹©åˆºæ€ç›®æ ‡ (çŒœæµ‹æ¢…æ—)</h5>
                <div class="apple-toggle-grid">
                    <template v-for="p in allPlayers" :key="'kill-'+p">
                        <button class="apple-btn apple-btn-outline"
                            style="color: var(--apple-red); border-color: rgba(255,59,48,0.3);" @click="assassinate(p)">
                            {{ p }}
                        </button>
                    </template>
                </div>
            </div>
            <div v-else class="text-muted">ç­‰å¾…{{ getAssassinRoleName() }}é€‰æ‹©...</div>
        </div>

        <!-- Mission Progress -->
        <div class="apple-card mb-md text-center">
            <div class="apple-dots mb-md">
                <div v-for="i in 5" class="apple-dot"
                    :class="[getMissionStatusClass(i), {current: i === missionHistory.length + 1}, {'swap-active': lancelotSwapReveal[i-1] === true}]">
                    <span>{{ i }}</span>
                    <span class="sub" v-if="missionHistory[i-1]">{{ missionHistory[i-1].fail_count }}å</span>
                    <!-- å…°æ–¯æ´›ç‰¹è½¬æ¢ç‰Œå¾½æ ‡ -->
                    <span
                        v-if="lancelotEnabled && lancelotSwapReveal[i-1] !== null && lancelotSwapReveal[i-1] !== undefined"
                        class="swap-badge" :class="{'no-swap': !lancelotSwapReveal[i-1]}">
                        <i v-if="lancelotSwapReveal[i-1]" class="ph-bold ph-arrows-clockwise"></i>
                        <i v-else class="ph-bold ph-minus"></i>
                    </span>
                </div>
            </div>
            <div class="text-sm text-muted">
                æµå±€: <span class="fw-700 text-red">{{ voteFailCount }}/5</span>
                &nbsp;|&nbsp; ç¬¬ {{ missionHistory.length + 1 }} è½®éœ€ <span class="fw-700">{{ requiredTeamSize
                    }}</span> äºº
            </div>
            <div class="text-sm mt-xs" v-if="captain">
                ğŸ‘‘ å½“å‰é˜Ÿé•¿: <span class="fw-700 text-orange">{{ captain }}</span>
            </div>
            <!-- æ¹–ä¸­ä»™å¥³æŒæœ‰è€… -->
            <div class="text-sm mt-xs" v-if="ladyOfLakeHolder">
                ğŸ§š æ¹–ä¸­ä»™å¥³: <span class="fw-700" style="color: var(--apple-purple, #af52de);">{{ ladyOfLakeHolder
                    }}</span>
            </div>
            <!-- Lancelot Swap Alert -->
            <div v-if="lancelotEnabled && getLatestSwapStatus() === true" 
                 class="apple-alert mt-md" 
                 style="background: var(--apple-orange-light); border: 1px solid rgba(255,149,0,0.3); color: #c27000; border-radius: 12px; padding: 10px;">
                <i class="ph-bold ph-arrows-clockwise"></i> é˜µè¥å·²è½¬æ¢ï¼è¯·ç•™æ„ä½ çš„èº«ä»½å˜åŒ–
            </div>
        </div>

        <!-- Lady of the Lake Result (ä»…æŒæœ‰è€…å¯è§) -->
        <div v-if="ladyOfLakeResult && ladyOfLakeInspector === myName" class="apple-card mb-md"
            style="border: 2px solid var(--apple-purple, #af52de);">
            <h6 class="text-center mb-sm" style="color: var(--apple-purple, #af52de);">ğŸ§š æŸ¥éªŒç»“æœ</h6>
            <div class="text-center">
                <strong>{{ ladyOfLakeResult.target }}</strong> çš„é˜µè¥æ˜¯:
                <span :class="ladyOfLakeResult.alignment === 'good' ? 'text-blue fw-700' : 'text-red fw-700'">
                    {{ ladyOfLakeResult.alignment === 'good' ? 'ğŸ›¡ï¸ å¥½äºº' : 'ğŸ—¡ï¸ åäºº' }}
                </span>
            </div>
            <div class="text-sm text-muted text-center mt-sm">ä½ å¯ä»¥é€‰æ‹©å…¬å¸ƒçœŸç›¸æˆ–è¿›è¡Œä¼ªè£…</div>
        </div>

        <!-- Last Vote Snapshot -->
        <div v-if="Object.keys(lastVoteSnapshot).length" class="apple-card mb-md">
            <h6 class="mb-sm text-sm text-muted fw-600">ä¸Šè½®æŠ•ç¥¨ç¥¨å‹</h6>
            <div class="chips-wrap">
                <span v-for="(vote, name) in lastVoteSnapshot" class="apple-chip"
                    :class="{'approve': vote==='approve', 'reject': vote==='reject'}">
                    {{ name }} <i class="fas" :class="vote==='approve'?'fa-check text-green':'fa-times text-red'"
                        style="margin-left:4px;"></i>
                </span>
            </div>
        </div>

        <!-- Vote Team Phase -->
        <div v-if="voteTeamActive" class="apple-card mb-md" style="border: 2px solid var(--apple-blue);">
            <h5 class="text-center text-blue mb-md">ğŸ—³ï¸ ç»„é˜ŸæŠ•ç¥¨ä¸­</h5>
            <div class="team-display">
                <div class="text-sm text-muted">æè®®é˜Ÿä¼</div>
                <div class="names">{{ missionTeam.join('ã€') }}</div>
            </div>
            <div class="chips-wrap mt-md">
                <span v-for="p in allPlayers" class="apple-chip"
                    :class="{'approve': teamVotes[p]==='approve', 'reject': teamVotes[p]==='reject'}"
                    :style="!teamVotes[p] ? 'opacity:0.4' : ''">
                    {{ p }} <i v-if="teamVotes[p]" class="fas" :class="teamVotes[p]==='approve'?'fa-check':'fa-times'"
                        style="margin-left:4px;"></i>
                </span>
            </div>
            <div v-if="lastVoteResult" class="mt-md apple-alert"
                :class="lastVoteResult==='approved'?'apple-alert-success':'apple-alert-danger'">
                æŠ•ç¥¨ç»“æœ: {{ lastVoteResult==='approved'?'âœ… é€šè¿‡':'âŒ æ‹’ç»' }}
            </div>
        </div>

        <!-- Propose Team -->
        <div v-if="!voteTeamActive && !missionActive && !ladyOfLakeActive && status==='active'"
            class="apple-card mb-md">
            <div class="d-flex justify-between items-center mb-md">
                <h5 style="margin:0;">å‘èµ·ç»„é˜Ÿ</h5>
                <span class="apple-tag apple-tag-orange">éœ€ {{ requiredTeamSize }} äºº</span>
            </div>
            <div class="apple-toggle-grid mb-md">
                <template v-for="p in allPlayers" :key="p">
                    <input type="checkbox" :id="'chk-'+p" :value="p" v-model="selectedTeam" class="apple-toggle-input">
                    <label :for="'chk-'+p" class="apple-toggle-btn">
                        {{ p === captain ? 'ğŸ‘‘' : '' }}{{ p }}
                    </label>
                </template>
            </div>
            <button class="apple-btn apple-btn-primary apple-btn-block apple-btn-lg" @click="proposeTeam"
                :disabled="selectedTeam.length !== requiredTeamSize">
                ğŸš€ å‘è½¦ ({{ selectedTeam.length }}/{{ requiredTeamSize }})
            </button>
        </div>

        <!-- Mission Execution -->
        <div v-if="missionActive" class="apple-card mb-md" style="border: 2px solid var(--apple-green);">
            <h5 class="text-center text-green mb-md">âš”ï¸ ä»»åŠ¡æ‰§è¡Œä¸­</h5>
            <p class="text-center">é˜Ÿå‘˜: <strong>{{ missionTeam.join('ã€') }}</strong></p>
            <div v-if="!missionTeam.includes(myName)" class="text-center text-muted text-sm mt-md">ç­‰å¾…é˜Ÿå‘˜å‡ºç¥¨...
            </div>
        </div>

        <!-- Lady of the Lake Active (ç­‰å¾…ä»™å¥³æŸ¥éªŒ) -->
        <div v-if="ladyOfLakeActive && ladyOfLakeHolder !== myName" class="apple-card mb-md"
            style="border: 2px solid var(--apple-purple, #af52de);">
            <h5 class="text-center mb-md" style="color: var(--apple-purple, #af52de);">ğŸ§š æ¹–ä¸­ä»™å¥³æŸ¥éªŒä¸­</h5>
            <p class="text-center text-muted">ç­‰å¾… <strong>{{ ladyOfLakeHolder }}</strong> é€‰æ‹©æŸ¥éªŒç›®æ ‡...</p>
        </div>

        <!-- Overlay: Vote Team -->
        <transition name="overlay">
            <div v-if="voteTeamActive && !teamVotes[myName]" class="vote-overlay">
                <h2>åŒæ„è¿™ä¸ªé˜Ÿä¼å—?</h2>
                <div class="vote-team-box"><strong>{{ missionTeam.join('ã€') }}</strong></div>
                <button class="vote-btn-big green" @click="submitTeamVote('approve')">ğŸ‘ åŒæ„</button>
                <button class="vote-btn-big red" @click="submitTeamVote('reject')">ğŸ‘ åå¯¹</button>
            </div>
        </transition>

        <!-- Overlay: Mission Vote -->
        <transition name="overlay">
            <div v-if="missionActive && missionTeam.includes(myName) && !hasActed" class="vote-overlay">
                <h2>æ‰§è¡Œä»»åŠ¡</h2>
                <button class="vote-btn-big blue" @click="voteMission('success')" :disabled="isLancelotMustFail()"
                    :style="isLancelotMustFail()?'opacity:0.35':''">ğŸ›¡ï¸
                    æˆåŠŸ</button>
                <button class="vote-btn-big red" @click="voteMission('fail')" :disabled="!isCurrentlyEvil()"
                    :style="!isCurrentlyEvil()?'opacity:0.35':''">ğŸ—¡ï¸ å¤±è´¥</button>
                <div v-if="!isCurrentlyEvil()"
                    style="color: rgba(255,255,255,0.5); margin-top: var(--space-sm); font-size: 0.85rem;">
                    å¥½äººåªèƒ½æŠ•æˆåŠŸ
                </div>
                <div v-if="isLancelotMustFail()"
                    style="color: rgba(255,255,255,0.5); margin-top: var(--space-sm); font-size: 0.85rem;">
                    å½“å‰é˜µè¥ä¸ºé‚ªæ¶çš„å…°æ–¯æ´›ç‰¹å¿…é¡»æŠ•å¤±è´¥
                </div>
            </div>
        </transition>

        <!-- Overlay: Lady of the Lake -->
        <transition name="overlay">
            <div v-if="ladyOfLakeActive && ladyOfLakeHolder === myName" class="vote-overlay">
                <h2>ğŸ§š æ¹–ä¸­ä»™å¥³</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: var(--space-lg); text-align: center;">
                    é€‰æ‹©ä¸€åç©å®¶æŸ¥éªŒå…¶é˜µè¥
                </p>
                <div class="lady-target-list">
                    <button v-for="p in allPlayers" :key="'lady-'+p" class="lady-target-btn"
                        :disabled="ladyOfLakeHistory.includes(p) || p === myName" @click="inspectPlayer(p)">
                        {{ p }}
                        <span v-if="ladyOfLakeHistory.includes(p)" style="font-size:0.75rem; opacity:0.5;">
                            (å·²æŸ¥éªŒ)</span>
                    </button>
                </div>
            </div>
        </transition>

        <!-- Overlay: Lady of Lake Result -->
        <transition name="overlay">
            <div v-if="showLadyResult" class="vote-overlay" @click="showLadyResult = false">
                <h2>ğŸ§š æŸ¥éªŒç»“æœ</h2>
                <div class="lady-result-box">
                    <div class="fw-700 mb-md" style="font-size:1.1rem;">{{ ladyResultData.target }}</div>
                    <div :class="ladyResultData.alignment === 'good' ? 'alignment-good' : 'alignment-evil'">
                        {{ ladyResultData.alignment === 'good' ? 'ğŸ›¡ï¸ å¥½äºº' : 'ğŸ—¡ï¸ åäºº' }}
                    </div>
                    <p class="text-sm text-muted mt-md">ä½ å¯ä»¥è‡ªç”±é€‰æ‹©å…¬å¸ƒæˆ–éšç’æ­¤ç»“æœ</p>
                </div>
                <p style="color: rgba(255,255,255,0.4); margin-top: var(--space-lg); font-size: 0.85rem;">
                    ç‚¹å‡»ä»»æ„å¤„å…³é—­
                </p>
            </div>
        </transition>

        <!-- Overlay: Excalibur Assign (é˜Ÿé•¿åˆ†é…ç‹è€…ä¹‹å‰‘) -->
        <transition name="overlay">
            <div v-if="excaliburPhase === 'assign' && myName === teamProposer" class="vote-overlay">
                <h2>ğŸ—¡ï¸ åˆ†é…ç‹è€…ä¹‹å‰‘</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: var(--space-lg); text-align: center;">
                    é€‰æ‹©ä¸€åé˜Ÿå‘˜æŒæœ‰ç‹è€…ä¹‹å‰‘
                </p>
                <div class="lady-target-list">
                    <button v-for="p in missionTeam" :key="'exc-'+p" class="lady-target-btn" :disabled="p === myName"
                        @click="assignExcalibur(p)">
                        {{ p }}
                        <span v-if="p === myName" style="font-size:0.75rem; opacity:0.5;">(è‡ªå·±)</span>
                    </button>
                </div>
            </div>
        </transition>

        <!-- Excalibur Assign waiting (non-captain sees waiting) -->
        <div v-if="excaliburPhase === 'assign' && myName !== teamProposer" class="apple-card mb-md"
            style="border: 2px solid var(--apple-orange);">
            <h5 class="text-center mb-md" style="color: var(--apple-orange);">ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘åˆ†é…ä¸­</h5>
            <p class="text-center text-muted">ç­‰å¾…å‘èµ·äºº <strong>{{ teamProposer }}</strong> åˆ†é…ç‹è€…ä¹‹å‰‘...</p>
        </div>

        <!-- Excalibur holder badge during mission -->
        <div v-if="excaliburHolder && excaliburPhase === 'mission' && !missionActive"
            class="apple-card mb-md text-center" style="border: 2px solid var(--apple-orange);">
            <p>ğŸ—¡ï¸ <strong>{{ excaliburHolder }}</strong> æŒæœ‰ç‹è€…ä¹‹å‰‘</p>
        </div>

        <!-- Overlay: Excalibur Decide (æŒå‰‘è€…å†³ç­–) -->
        <transition name="overlay">
            <div v-if="excaliburPhase === 'decide' && myName === excaliburHolder" class="vote-overlay">
                <h2>ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: var(--space-lg); text-align: center;">
                    é€‰æ‹©ä¸€åé˜Ÿå‘˜æ›¿æ¢å…¶æŠ•ç¥¨å¹¶æŸ¥çœ‹ç»“æœï¼Œæˆ–è·³è¿‡
                </p>
                <div class="lady-target-list">
                    <button v-for="p in missionTeam" :key="'excu-'+p" class="lady-target-btn" @click="useExcalibur(p)">
                        ğŸ—¡ï¸ {{ p }}
                    </button>
                    <button class="lady-target-btn" style="background: rgba(255,255,255,0.08); margin-top: 8px;"
                        @click="useExcalibur(null)">
                        âœ• ä¸ä½¿ç”¨
                    </button>
                </div>
            </div>
        </transition>

        <!-- Excalibur decide waiting (non-holder) -->
        <div v-if="excaliburPhase === 'decide' && myName !== excaliburHolder" class="apple-card mb-md"
            style="border: 2px solid var(--apple-orange);">
            <h5 class="text-center mb-md" style="color: var(--apple-orange);">ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘å†³ç­–ä¸­</h5>
            <p class="text-center text-muted">ç­‰å¾… <strong>{{ excaliburHolder }}</strong> å†³å®šæ˜¯å¦ä½¿ç”¨ç‹è€…ä¹‹å‰‘...</p>
        </div>

        <!-- Overlay: Excalibur Result (æŒå‰‘è€…æŸ¥çœ‹ç»“æœ) -->
        <transition name="overlay">
            <div v-if="showExcaliburResult" class="vote-overlay" @click="showExcaliburResult = false">
                <h2>ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘ç»“æœ</h2>
                <div class="lady-result-box">
                    <div class="fw-700 mb-md" style="font-size:1.1rem;">{{ excaliburResultData.target }}</div>
                    <div :class="excaliburResultData.original_vote === 'fail' ? 'alignment-evil' : 'alignment-good'">
                        {{ excaliburResultData.original_vote === 'fail' ? 'ğŸ—¡ï¸ åŸå§‹æŠ•ç¥¨ï¼šå¤±è´¥' : 'ğŸ›¡ï¸ åŸå§‹æŠ•ç¥¨ï¼šæˆåŠŸ' }}
                    </div>
                    <div style="margin-top: var(--space-md); font-size: 0.85rem; color: rgba(255,255,255,0.5);">
                        å·²æ›¿æ¢ä¸º{{ excaliburResultData.original_vote === 'fail' ? 'æˆåŠŸ' : 'å¤±è´¥' }}ç¥¨ï¼Œç‚¹å‡»ä»»æ„å¤„å…³é—­
                    </div>
                </div>
            </div>
        </transition>
    </div>



    <!-- Game Over -->
    <div v-if="status === 'ended' && revealedPlayers.length > 0" class="apple-section">
        <div class="apple-card" style="padding: var(--space-2xl) var(--space-lg); text-align: center; overflow: hidden; position: relative;">
            
            <div class="victory-hero">
                {{ gameWinner === 'good' ? 'ğŸ›¡ï¸' : 'ğŸ—¡ï¸' }}
            </div>
            
            <h2 class="victory-title" :class="gameWinner==='good' ? 'victory-blue' : 'victory-red'">
                {{ gameWinner === 'good' ? 'æ­£ä¹‰é•¿å­˜' : 'æš—å½±é™ä¸´' }}
            </h2>
            
            <div class="text-muted" style="font-size: 1.25rem; font-weight: 600; letter-spacing: -0.02em; margin-bottom: var(--space-lg);">
                {{ gameWinner === 'good' ? 'å¥½äººé˜µè¥å–å¾—æœ€ç»ˆèƒœåˆ©' : 'é‚ªæ¶é˜µè¥å¤ºå–æœ€ç»ˆèƒœåˆ©' }}
            </div>

            <div v-if="assassinTarget" class="assassin-result">
                <span>åˆºå®¢æœ€ç»ˆåˆºæ€äº† <strong style="margin-left: 4px; font-size: 1.15rem;">{{ assassinTarget }}</strong></span>
            </div>

            <div style="text-align: left; max-width: 800px; margin: 0 auto;">
                <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: var(--space-md); color: var(--apple-black); padding-left: 4px; letter-spacing: -0.02em;">å…¨å‘˜èº«ä»½æ­æ™“</h3>
                <div class="reveal-grid">
                    <div v-for="p in revealedPlayers" :key="p.name" class="reveal-card">
                        <div class="name">{{ p.name }}</div>
                        <div class="role" :class="isEvil(p.role) ? 'text-red' : 'text-blue'">
                            {{ roleMap[p.role] }}
                        </div>
                    </div>
                </div>

                <div class="action-buttons-group">
                    <button class="apple-btn apple-btn-primary apple-btn-pill" style="flex: 1;" @click="quickRestart">
                        ğŸ”„ä¸€é”®é‡å¼€
                    </button>
                    <button class="apple-btn apple-btn-secondary apple-btn-pill" style="flex: 1;" @click="resetGame">
                        âš™ï¸ æ›´æ¢äººæ•°
                    </button>
                </div>
            </div>

            <div id="dashboard-chart" style="width: 100%; height: 400px; margin-top: var(--space-2xl);"></div>
        </div>
    </div>

    <!-- Game Controls -->
    <div v-if="(step === 3 || status === 'assassin' || status === 'active') && status !== 'ended'" class="apple-card text-center"
        style="background: var(--apple-bg); box-shadow: none; margin-top: var(--space-lg);">
        <div class="game-controls">
            <button class="apple-btn apple-btn-sm" style="background: var(--apple-orange); color: white;"
                @click="quickRestart">ğŸ”„ é‡å¼€</button>
            <button class="apple-btn apple-btn-sm apple-btn-outline"
                style="color: var(--apple-red); border-color: rgba(255,59,48,0.3);" @click="endGame">ğŸšª ç»“æŸ
        </div>

        <footer class="apple-footer">
            <p>Avalon Â© 2026</p>
        </footer>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/echarts@5.5.0/dist/echarts.min.js"></script>
<script>
    const {
        createApp
    } = Vue;
    createApp({
        data() {
            return {
                step: 1,
                status: 'empty',
                errorMsg: '',
                myName: localStorage.getItem('avalon_name') || '',
                playerCount: 5,
                lancelotEnabled: false,
                ladyOfLakeEnabled: true,
                targetCount: 0,
                currentCount: 0,
                allPlayers: [],
                missionHistory: [],
                voteFailCount: 0,
                missionActive: false,
                missionTeam: [],
                hasActed: false,
                myRole: '',
                visionData: [],
                showRole: true,
                voteTeamActive: false,
                teamVotes: {},
                lastVoteResult: null,
                lastVoteSnapshot: {},
                selectedTeam: [],
                revealedPlayers: [],
                captain: null,
                teamProposer: null,
                requiredTeamSize: 2,
                gameWinner: null,
                assassinTarget: null,
                // æ¹–ä¸­ä»™å¥³
                ladyOfLakeHolder: null,
                ladyOfLakeActive: false,
                ladyOfLakeResult: null,
                ladyOfLakeInspector: null,
                ladyOfLakeHistory: [],
                showLadyResult: false,
                ladyResultData: {},
                // å…°æ–¯æ´›ç‰¹
                lancelotSwapped: false,
                lancelotSwapReveal: [],
                currentAlignment: null,
                // åˆºæ€è§’è‰²
                assassinRole: null,
                // ç‹è€…ä¹‹å‰‘
                excaliburEnabled: false,
                excaliburHolder: null,
                excaliburPhase: 'none',
                excaliburResult: null,
                showExcaliburResult: false,
                excaliburResultData: {},
                // æ’è¡Œæ¦œ
                lbData: [],
                history: [],
                chartRendered: false,
                cacheBuster: Date.now(),
                roleMap: {
                    'Merlin': 'æ¢…æ—',
                    'Percival': 'æ´¾è¥¿ç»´å°”',
                    'Loyal Servant': 'å¿ è‡£',
                    'Morgana': 'è«ç”˜å¨œ',
                    'Assassin': 'åˆºå®¢',
                    'Mordred': 'è«å¾·é›·å¾·',
                    'Oberon': 'å¥¥ä¼¯ä¼¦',
                    'Minion': 'çˆªç‰™',
                    'Lancelot Good': 'å…°æ–¯æ´›ç‰¹(æ­£ä¹‰)',
                    'Lancelot Evil': 'å…°æ–¯æ´›ç‰¹(é‚ªæ¶)'
                },
                configPresets: {
                    5: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢',
                    6: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—2<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢',
                    7: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—2<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, å¥¥ä¼¯ä¼¦',
                    8: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—3<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, çˆªç‰™',
                    9: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—4<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, è«å¾·é›·å¾·',
                    10: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—4<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, å¥¥ä¼¯ä¼¦, è«å¾·é›·å¾·',
                    '10_lancelot': 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—3, å…°æ–¯æ´›ç‰¹(æ­£ä¹‰)<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, è«å¾·é›·å¾·, å¥¥ä¼¯ä¼¦, å…°æ–¯æ´›ç‰¹(é‚ªæ¶)<br><br><small style="color:var(--apple-orange)">âš ï¸ æ— åˆºå®¢ï¼Œè«ç”˜å¨œæ‰§è¡Œåˆºæ€</small>',
                    12: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—4, å…°æ–¯æ´›ç‰¹(æ­£ä¹‰)<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, è«å¾·é›·å¾·, å¥¥ä¼¯ä¼¦, å…°æ–¯æ´›ç‰¹(é‚ªæ¶)',
                }
            }
        },
        watch: {
            myName(val) {
                localStorage.setItem('avalon_name', val);
            }
        },
        mounted() {
            this.startPolling();
            this.fetchLeaderboard();
        },
        methods: {
            incrementPlayerCount() {
                if (this.playerCount === 10) {
                    this.playerCount = 12;
                    this.lancelotEnabled = true;
                } else if (this.playerCount < 10) {
                    this.playerCount++;
                }
            },
            decrementPlayerCount() {
                if (this.playerCount === 12) this.playerCount = 10;
                else if (this.playerCount > 5) this.playerCount--;
            },
            getConfigPreview() {
                let preview;
                if ((this.playerCount === 10 || this.playerCount === 12) && this.lancelotEnabled) {
                    preview = this.playerCount === 10 ? this.configPresets['10_lancelot'] : this
                        .configPresets[12];
                } else {
                    preview = this.configPresets[this.playerCount] || this.configPresets[6];
                }
                let extraProps = [];
                if (this.ladyOfLakeEnabled && this.playerCount >= 8) {
                    extraProps.push('<span style="color:var(--apple-purple,#af52de)">ğŸ§š æ¹–ä¸­ä»™å¥³</span>');
                }
                if (this.excaliburEnabled && this.playerCount >= 8) {
                    extraProps.push('<span style="color:var(--apple-orange)">ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘</span>');
                }
                if (this.lancelotEnabled && this.playerCount >= 10) {
                    extraProps.push('<span style="color:var(--apple-red)">âš”ï¸ å…°æ–¯æ´›ç‰¹</span>');
                }
                if (extraProps.length > 0) {
                    preview +=
                        '<br><div style="margin-top:8px; font-weight:600; font-size: 0.85em;">é™„åŠ é€‰é¡¹: ' +
                        extraProps.join(' | ') + '</div>';
                }
                return preview;
            },
            async createGame() {
                try {
                    await axios.post('/avalon/reset_game', {
                        player_count: this.playerCount,
                        lancelot_enabled: this.lancelotEnabled && (this.playerCount ===
                            10 || this.playerCount === 12),
                        excalibur_enabled: this.excaliburEnabled && this.playerCount >= 8,
                        lady_of_lake_enabled: this.ladyOfLakeEnabled && this.playerCount >=
                            8
                    });
                    this.joinGame();
                } catch (e) {
                    this.showError(e);
                }
            },
            async joinGame() {
                if (!this.myName) return;
                try {
                    await axios.post('/avalon/join', {
                        player_name: this.myName
                    });
                    this.step = 2;
                } catch (e) {
                    this.showError(e);
                }
            },
            async resetGame() {
                if (!confirm("ç¡®å®šé‡ç½®å¹¶æ›´æ¢äººæ•°?")) return;
                try {
                    await axios.post('/avalon/clear_game');
                    this.step = 1;
                    this.status = 'empty';
                    this.history = [];
                    this.chartRendered = false;
                    this.fetchLeaderboard();
                } catch (e) { }
            },
            async proposeTeam() {
                if (this.selectedTeam.length !== this.requiredTeamSize) {
                    return alert(`æœ¬è½®éœ€è¦ ${this.requiredTeamSize} äºº`);
                }
                try {
                    await axios.post('/avalon/propose_team', {
                        player_name: this.myName,
                        team: this.selectedTeam
                    });
                    this.selectedTeam = [];
                } catch (e) {
                    this.showError(e);
                }
            },
            async submitTeamVote(vote) {
                try {
                    await axios.post('/avalon/vote_team', {
                        player_name: this.myName,
                        vote
                    });
                } catch (e) {
                    this.showError(e);
                }
            },
            async voteMission(action) {
                try {
                    await axios.post('/avalon/vote_mission', {
                        player_name: this.myName,
                        action
                    });
                    this.hasActed = true;
                } catch (e) {
                    this.showError(e);
                }
            },
            async assassinate(target) {
                if (!confirm(`ç¡®å®šåˆºæ€ ${target}?`)) return;
                try {
                    await axios.post('/avalon/assassinate', {
                        target
                    });
                } catch (e) {
                    this.showError(e);
                }
            },
            async inspectPlayer(target) {
                if (!confirm(`ç¡®å®šæŸ¥éªŒ ${target}?`)) return;
                try {
                    const res = await axios.post('/avalon/lady_of_lake', {
                        target
                    });
                    this.ladyResultData = {
                        target,
                        alignment: res.data.alignment
                    };
                    this.showLadyResult = true;
                } catch (e) {
                    this.showError(e);
                }
            },
            async quickRestart() {
                if (!confirm("ç¡®å®šé‡å¼€ï¼Ÿæ‰€æœ‰ç©å®¶å°†è‡ªåŠ¨åŠ å…¥æ–°å±€")) return;
                try {
                    await axios.post('/avalon/reset_game', {
                        player_count: this.targetCount || this.playerCount,
                        lancelot_enabled: this.lancelotEnabled,
                        excalibur_enabled: this.excaliburEnabled,
                        lady_of_lake_enabled: this.ladyOfLakeEnabled
                    });
                    this.step = 1;
                    this.history = [];
                    this.chartRendered = false;
                } catch (e) {
                    this.showError(e);
                }
            },
            async endGame() {
                if (!confirm("ç¡®å®šç»“æŸå½“å‰æ¸¸æˆï¼Ÿ")) return;
                try {
                    await axios.post('/avalon/end_game');
                } catch (e) {
                    this.showError(e);
                }
            },
            isCurrentlyEvil() {
                if (this.currentAlignment) {
                    return this.currentAlignment === 'evil';
                }
                return this.isEvil(this.myRole);
            },
            isLancelotMustFail() {
                // å½“å‰å¤„äºé‚ªæ¶é˜µè¥çš„å…°æ–¯æ´›ç‰¹å¿…é¡»æŠ•å¤±è´¥
                if ((this.myRole === 'Lancelot Good' || this.myRole === 'Lancelot Evil') && this
                    .isCurrentlyEvil()) {
                    return true;
                }
                return false;
            },
            getVisionPanelMeta() {
                if (["Morgana", "Assassin", "Mordred", "Minion"].includes(this.myRole)) {
                    return {
                        theme: "evil-team",
                        title: "æš—å½±ç›Ÿå‹",
                        subtitle: "å·²çŸ¥é‚ªæ¶é˜µè¥"
                    };
                }
                if (this.myRole === "Merlin") {
                    return {
                        theme: "merlin",
                        title: "é‚ªæ¶å°è®°",
                        subtitle: "èº«ä»½æœªçŸ¥çš„çˆªç‰™"
                    };
                }
                if (this.myRole === "Percival") {
                    return {
                        theme: "percival",
                        title: "çœŸå‡å…ˆçŸ¥",
                        subtitle: "æ¢…æ—æˆ–è«ç”˜å¨œï¼Œè¯·è°¨æ…æŠ‰æ‹©"
                    };
                }
                if (this.myRole === "Lancelot Good") {
                    return {
                        theme: "lancelot-good",
                        title: "èª“çº¦ä¹‹å‰‘",
                        subtitle: "ç­‰å¾…å¤©æ˜ï¼Œè­¦æƒ•å‘½è¿çš„è¯•ç‚¼"
                    };
                }
                if (this.myRole === "Lancelot Evil") {
                    return {
                        theme: "lancelot-evil",
                        title: "å •è½ä¹‹åˆƒ",
                        subtitle: "æ²‰æ½œæš—å¤œï¼Œè¿æ¥æš—å½±çš„å‡è§†"
                    };
                }
                if (this.myRole === "Oberon") {
                    return {
                        theme: "oberon",
                        title: "å­¤å†›å¥‹æˆ˜",
                        subtitle: "æ— æ³•ç¡®è®¤ç›Ÿå‹ï¼Œè¯·éšè”½è¡ŒåŠ¨"
                    };
                }
                return {
                    theme: "loyal",
                    title: "é•¿å¤œæ— æ˜",
                    subtitle: "é˜¿ç“¦éš†ç­‰å¾…é»æ˜ï¼Œè¯·ä¿æŒé—­çœ¼"
                };
            },
            getVisionThemeClass() {
                return `vision-theme-${this.getVisionPanelMeta().theme}`;
            },
            getVisionNamesText() {
                if (!this.visionData.length) {
                    return "æš‚æ— å¯è§ç›®æ ‡";
                }
                return this.visionData.map(v => {
                    if ((v.identity || "").includes("å…°æ–¯æ´›ç‰¹") || (v.identity || "").includes("Lancelot")) {
                        return `${v.name}ï¼ˆå…°æ–¯æ´›ç‰¹ï¼‰`;
                    }
                    return v.name;
                }).join("ã€");
            },
            canAssassinate() {
                // åˆ¤æ–­å½“å‰ç©å®¶æ˜¯å¦å¯ä»¥æ‰§è¡Œåˆºæ€
                if (this.assassinRole === this.myRole) return true;
                // å…¼å®¹ï¼šåŸå§‹é€»è¾‘
                if (!this.assassinRole && this.myRole === 'Assassin') return true;
                return false;
            },
            getAssassinRoleName() {
                if (this.assassinRole) {
                    return this.roleMap[this.assassinRole] || this.assassinRole;
                }
                return 'åˆºå®¢';
            },
            async assignExcalibur(target) {
                try {
                    await axios.post('/avalon/assign_excalibur', {
                        target
                    });
                } catch (e) {
                    this.showError(e);
                }
            },
            async useExcalibur(target) {
                if (target && !confirm(`ç¡®å®šå¯¹ ${target} ä½¿ç”¨ç‹è€…ä¹‹å‰‘ï¼Ÿå°†æ›¿æ¢å…¶æŠ•ç¥¨å¹¶æŸ¥çœ‹ç»“æœ`)) return;
                try {
                    const res = await axios.post('/avalon/use_excalibur', {
                        target
                    });
                    if (res.data.excalibur_result) {
                        this.excaliburResultData = res.data.excalibur_result;
                        this.showExcaliburResult = true;
                    }
                } catch (e) {
                    this.showError(e);
                }
            },
            startPolling() {
                setInterval(async () => {
                    if (this.step === 1) {
                        try {
                            const res = await axios.get('/avalon/lobby');
                            const d = res.data;
                            this.status = d.status;
                            this.currentCount = d.current_count;
                            this.allPlayers = d.players || [];
                            
                            // Only sync config from server if a game is actually in progress or joining
                            // This prevents local creation settings from being reset by polling
                            if (d.status === 'joining' || d.status === 'active' || d.status === 'assassin') {
                                this.targetCount = d.target_count;
                                this.lancelotEnabled = d.lancelot_enabled || false;
                                this.excaliburEnabled = d.excalibur_enabled || false;
                                if (d.lady_of_lake_enabled !== undefined) {
                                    this.ladyOfLakeEnabled = d.lady_of_lake_enabled;
                                }
                            }

                            const prevPlayers = d.previous_players || [];
                            if (this.myName && prevPlayers.includes(this.myName) && !d
                                .players.includes(this.myName) && d.status === 'joining') {
                                this.joinGame();
                            }

                            if (this.myName && d.players.includes(this.myName) && d
                                .status === 'active') {
                                this.step = 3;
                            }
                        } catch (e) { }
                        return;
                    }

                    if (!this.myName) return;
                    try {
                        const res = await axios.get(`/avalon/status/${this.myName}`);
                        const d = res.data;
                        this.status = d.status;

                        if (d.status === 'joining') {
                            const prevPlayers = d.last_vote_snapshot ? [] : (d
                                .previous_players || []);
                            if (this.myName && !d.players_list.includes(this.myName)) {
                                this.step = 1;
                                this.joinGame();
                            } else if (this.step > 2) {
                                this.step = 2;
                            }
                        } else if (d.status === 'active' || d.status === 'assassin') {
                            if (this.step === 2) this.step = 3;
                        } else if (d.status === 'ended') {
                            this.revealedPlayers = d.revealed_players;
                            this.gameWinner = d.game_winner;
                            this.assassinTarget = d.assassin_target;
                            this.history = d.history || [];
                            if (!this.chartRendered && this.history.length > 0) {
                                this.chartRendered = true;
                                this.$nextTick(() => { this.renderDashboard(); });
                            }
                        } else if (d.status === 'empty') {
                            this.step = 1;
                            this.gameWinner = null;
                            this.assassinTarget = null;
                            this.revealedPlayers = [];
                            this.history = [];
                            this.chartRendered = false;
                        }

                        this.currentCount = d.current_count;
                        this.targetCount = d.target_count;
                        this.allPlayers = d.players_list;

                        if (d.status === 'active' || d.status === 'assassin') {
                            this.myRole = d.your_role;
                            this.visionData = d.vision || [];
                            this.missionHistory = d.mission_history || [];
                            this.voteFailCount = d.vote_fail_count;
                            this.missionActive = d.mission_active;
                            this.missionTeam = d.mission_team || [];
                            this.hasActed = d.has_acted;
                            this.voteTeamActive = d.vote_team_active;
                            this.teamVotes = d.team_votes || {};
                            this.lastVoteResult = d.last_vote_result;
                            this.lastVoteSnapshot = d.last_vote_snapshot || {};
                            this.captain = d.captain;
                            this.teamProposer = d.team_proposer || d.captain;
                            this.requiredTeamSize = d.required_team_size;

                            // æ¹–ä¸­ä»™å¥³
                            this.ladyOfLakeHolder = d.lady_of_lake_holder;
                            this.ladyOfLakeActive = d.lady_of_lake_active;
                            this.ladyOfLakeResult = d.lady_of_lake_result;
                            this.ladyOfLakeInspector = d.lady_of_lake_inspector || null;
                            this.ladyOfLakeHistory = d.lady_of_lake_history || [];

                            // å…°æ–¯æ´›ç‰¹
                            this.lancelotEnabled = d.lancelot_enabled;
                            this.lancelotSwapped = d.lancelot_swapped;
                            this.lancelotSwapReveal = d.lancelot_swap_reveal || [];
                            this.currentAlignment = d.current_alignment;

                            // åˆºæ€è§’è‰²
                            this.assassinRole = d.assassin_role;

                            // ç‹è€…ä¹‹å‰‘
                            this.excaliburEnabled = d.excalibur_enabled;
                            this.excaliburHolder = d.excalibur_holder;
                            this.excaliburPhase = d.excalibur_phase || 'none';
                            if (d.excalibur_result) {
                                this.excaliburResult = d.excalibur_result;
                            }
                        }

                    } catch (e) { }
                }, 1000);
            },
            getMissionStatusClass(i) {
                const r = this.missionHistory[i - 1];
                return r ? (r.result === 'success' ? 'success' : 'fail') : '';
            },
            getLatestSwapStatus() {
                if (!this.lancelotEnabled) return null;
                const reveals = this.lancelotSwapReveal.filter(r => r !== null && r !== undefined);
                if (reveals.length === 0) return null;
                return reveals[reveals.length - 1];
            },
            isEvil(role) {
                return ['Morgana', 'Assassin', 'Mordred', 'Oberon', 'Minion', 'Lancelot Evil'].includes(
                    role);
            },
            getRoleImage(role) {
                if (!role) return '';
                const map = {
                    'Merlin': 'MERLIN.jpg',
                    'Percival': 'PERCIVAL.jpg',
                    'Loyal Servant': 'SERVANT.jpg',
                    'Morgana': 'MORGANA.jpg',
                    'Assassin': 'ASSASSIN.jpg',
                    'Mordred': 'MORDRED.jpg',
                    'Oberon': 'OBERON.jpg',
                    'Minion': 'MINION.jpg',
                    'Lancelot Good': 'LANCELOT(GOOD).jpg',
                    'Lancelot Evil': 'LANCELOT(EVIL).jpg'
                };
                return '/avalon/assets/' + (map[role] || 'SERVANT.jpg') + '?v=' + this.cacheBuster;
            },
            showError(e) {
                this.errorMsg = e.response?.data?.detail || "Error";
                setTimeout(() => this.errorMsg = '', 3000);
            },
            async fetchLeaderboard() {
                try {
                    const res = await axios.get('/avalon/leaderboard');
                    this.lbData = res.data.leaderboard || [];
                } catch (e) { }
            },
            renderDashboard() {
                const dom = document.getElementById('dashboard-chart');
                if (!dom) return;
                const myChart = echarts.init(dom, this.isDarkMode() ? 'dark' : 'light');
                const players = this.revealedPlayers.map(p => p.name);
                let xAxisData = [];
                let seriesDataVotes = [];
                let seriesDataMissions = [];
                let seriesDataMissionFails = []; // ç”¨äº effectScatter
                this.history.forEach((h, idx) => {
                    const label = `R${h.round_num}.${h.proposal_index}`;
                    xAxisData.push(label);
                    players.forEach((p, yIndex) => {
                        const vote = h.votes[p];
                        if (vote) seriesDataVotes.push([idx, yIndex, vote === 'approve' ? 1 : -1, h.team.includes(p)]);
                        const mVote = h.mission_votes[p];
                        if (mVote) {
                            if (mVote === 'fail') {
                                seriesDataMissionFails.push([idx, yIndex, -1]);
                            } else {
                                seriesDataMissions.push([idx, yIndex, 1]);
                            }
                        }
                    });
                });
                myChart.setOption({
                    backgroundColor: 'transparent',
                    textStyle: {
                        fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
                    },
                    title: { 
                        text: 'å¯¹å±€è®°å½•', 
                        left: 'center', 
                        top: 15,
                        textStyle: { 
                            fontSize: 20, 
                            fontWeight: 800, 
                            letterSpacing: 1.5,
                            color: this.isDarkMode() ? '#ffffff' : '#1d1d1f',
                            textShadowBlur: 10,
                            textShadowColor: this.isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'
                        } 
                    },
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: this.isDarkMode() ? 'rgba(28, 28, 30, 0.75)' : 'rgba(255, 255, 255, 0.85)',
                        borderColor: this.isDarkMode() ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.08)',
                        borderWidth: 1,
                        padding: 0,
                        textStyle: {
                            color: this.isDarkMode() ? '#f5f5f7' : '#1d1d1f',
                        },
                        extraCssText: 'border-radius: 12px; box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15); backdrop-filter: saturate(150%) blur(20px); -webkit-backdrop-filter: saturate(150%) blur(20px); overflow: hidden;',
                        formatter: function(params) {
                            const isDark = this.isDarkMode ? this.isDarkMode() : false;
                            const textColor = isDark ? '#e5e5ea' : '#333333';
                            const subTextColor = '#86868b';
                            
                            if (params.seriesName === 'ç»„é˜ŸæŠ•ç¥¨') {
                                const isApprove = params.value[2] === 1;
                                const headerColor = isApprove ? 'rgba(52, 199, 89, 0.15)' : 'rgba(255, 59, 48, 0.15)';
                                const iconColor = isApprove ? '#34c759' : '#ff3b30';
                                
                                return `
                                    <div style="background: ${headerColor}; padding: 10px 16px; border-bottom: 1px solid ${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'};">
                                        <span style="font-weight:700; font-size: 14px; color: ${textColor}">${params.name}</span>
                                    </div>
                                    <div style="padding: 12px 16px; display:flex; flex-direction: column; gap: 8px;">
                                        <div style="display:flex; align-items:center; justify-content: space-between; gap: 16px;">
                                            <span style="color: ${subTextColor}; font-size: 12px;">æŠ•ç¥¨ç«‹åœº</span>
                                            <span style="font-weight: 600; color: ${iconColor};">
                                                ${isApprove ? 'â— èµæˆ' : 'â–  åå¯¹'}
                                            </span>
                                        </div>
                                        ${params.value[3] ? `<div style="display:flex; align-items:center; justify-content: space-between; gap: 16px;">
                                            <span style="color: ${subTextColor}; font-size: 12px;">èº«ä»½çŠ¶æ€</span>
                                            <span style="font-weight: 500; color: ${textColor};">ğŸ›¸ åœ¨è½¦ä¸Š</span>
                                        </div>` : ''}
                                    </div>`;
                            } else if (params.seriesName === 'ä»»åŠ¡' || params.seriesName === 'å…³é”®å¤±è´¥') {
                                const isSuccess = params.value[2] === 1;
                                const headerColor = isSuccess ? 'rgba(0, 113, 227, 0.15)' : 'rgba(191, 90, 242, 0.15)';
                                const iconColor = isSuccess ? '#0071e3' : '#bf5af2';
                                
                                return `
                                    <div style="background: ${headerColor}; padding: 10px 16px; border-bottom: 1px solid ${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'};">
                                        <span style="font-weight:700; font-size: 14px; color: ${textColor}">${params.name}</span>
                                    </div>
                                    <div style="padding: 12px 16px;">
                                        <span style="font-weight: 600; font-size: 15px; color: ${iconColor};">
                                            ${isSuccess ? 'ğŸ›¡ï¸ ä»»åŠ¡æˆåŠŸ' : 'ğŸ—¡ï¸ ä»»åŠ¡å¤±è´¥'}
                                        </span>
                                    </div>`;
                            }
                        }.bind(this)
                    },
                    grid: { top: 80, bottom: 40, left: 90, right: 40 },
                    xAxis: { 
                        type: 'category', 
                        data: xAxisData, 
                        axisLine: { show: false },
                        axisTick: { show: false },
                        axisLabel: { color: '#86868b', fontWeight: 600, fontSize: 12, margin: 16 },
                        splitLine: { 
                            show: true, 
                            lineStyle: { type: 'dashed', color: this.isDarkMode() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)' } 
                        } 
                    },
                    yAxis: { 
                        type: 'category', 
                        data: players, 
                        axisLine: { show: false },
                        axisTick: { show: false },
                        axisLabel: { color: this.isDarkMode() ? '#d2d2d7' : '#1d1d1f', fontWeight: 600, fontSize: 14, margin: 20 },
                        splitLine: { show: false },
                        splitArea: { 
                            show: true, 
                            areaStyle: { color: [this.isDarkMode() ? 'rgba(255,255,255,0.02)' : 'rgba(0,0,0,0.02)', 'transparent'] } 
                        }
                    },
                    series: [
                        {
                            name: 'ç»„é˜ŸæŠ•ç¥¨', type: 'scatter', 
                            symbolSize: function(val) { return val[3] ? 24 : 14; },
                            itemStyle: {
                                color: function(params) { return params.value[2] === 1 ? '#34c759' : '#ff3b30'; },
                                opacity: function(params) { return params.value[3] ? 1 : 0.65; },
                                borderColor: function(params) { return params.value[3] ? (this.isDarkMode() ? '#ffffff' : '#ffffff') : 'transparent'; }.bind(this),
                                borderWidth: function(params) { return params.value[3] ? 2.5 : 0; },
                                shadowBlur: function(params) { return params.value[3] ? 12 : 4; },
                                shadowColor: function(params) { return params.value[2] === 1 ? 'rgba(52, 199, 89, 0.4)' : 'rgba(255, 59, 48, 0.4)'; },
                                shadowOffsetY: 2
                            },
                            data: seriesDataVotes
                        },
                        {
                            name: 'ä»»åŠ¡', type: 'scatter', symbol: 'path://M512 0c0 0-33.536 339.968-150.528 456.96C244.48 573.952 0 512 0 512s339.968 33.536 456.96 150.528C573.952 779.52 512 1024 512 1024s33.536-339.968 150.528-456.96C779.52 450.048 1024 512 1024 512s-339.968-33.536-456.96-150.528C450.048 244.48 512 0 512 0z', symbolSize: 28, zlevel: 2,
                            itemStyle: { 
                                color: '#0071e3',
                                shadowBlur: 16,
                                shadowColor: 'rgba(0, 113, 227, 0.6)',
                                shadowOffsetY: 4
                            },
                            data: seriesDataMissions
                        },
                        {
                            name: 'å…³é”®å¤±è´¥', type: 'effectScatter', symbol: 'path://M512 0c0 0-33.536 339.968-150.528 456.96C244.48 573.952 0 512 0 512s339.968 33.536 456.96 150.528C573.952 779.52 512 1024 512 1024s33.536-339.968 150.528-456.96C779.52 450.048 1024 512 1024 512s-339.968-33.536-456.96-150.528C450.048 244.48 512 0 512 0z', symbolSize: 32, zlevel: 3,
                            rippleEffect: {
                                brushType: 'stroke',
                                scale: 2.5,
                                period: 3
                            },
                            itemStyle: { 
                                color: '#bf5af2',
                                shadowBlur: 20,
                                shadowColor: 'rgba(191, 90, 242, 0.8)',
                                shadowOffsetY: 4
                            },
                            data: seriesDataMissionFails
                        }
                    ]
                });
            },
            isDarkMode() { return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
        }
    }).mount('#app');
</script>
</div>
{% endraw %}
{% endblock %}
