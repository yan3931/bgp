{% extends "base.html" %}

{% block title %}é˜¿ç“¦éš† - é˜µè¥æ¨ç† Â· èº«ä»½éšè—{% endblock %}

{% block extra_head %}
<style>
    body {
        padding-bottom: 80px;
    }

    /* ---- Page Hero ---- */

    .role-img {
        max-height: 280px;
        border-radius: 16px;
        margin-bottom: var(--space-md);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s;
    }

    .role-img:hover {
        transform: scale(1.03) translateY(-4px);
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.25);
    }

    .vision-list {
        list-style: none;
        padding: 0;
        margin: var(--space-sm) 0 0;
    }

    .vision-list li {
        font-size: 0.9rem;
        padding: 6px 0;
        color: var(--apple-gray);
        font-weight: 500;
    }

    .vision-list li.evil {
        color: var(--apple-red);
        font-weight: 600;
    }

    .team-display {
        background: var(--apple-bg);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        text-align: center;
        margin: var(--space-md) 0;
    }

    .team-display .names {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--apple-black);
        letter-spacing: -0.02em;
    }

    .vote-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: var(--space-lg);
    }

    .vote-overlay h2 {
        color: white;
        margin-bottom: var(--space-xl);
        font-size: 1.8rem;
        letter-spacing: -0.04em;
    }

    .vote-team-box,
    .lady-result-box {
        background: rgba(40, 40, 44, 0.85);
        backdrop-filter: blur(20px);
        padding: var(--space-lg) var(--space-xl);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-xl);
        text-align: center;
        width: 85%;
        max-width: 340px;
        box-shadow: var(--shadow-lg);
        color: white;
    }

    .vote-team-box strong {
        font-size: 1.4rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: white;
    }

    .lady-result-box .alignment-good {
        color: var(--apple-blue);
        font-size: 2rem;
        font-weight: 800;
        margin-top: 10px;
    }

    .lady-result-box .alignment-evil {
        color: var(--apple-red);
        font-size: 2rem;
        font-weight: 800;
        margin-top: 10px;
    }

    .vote-btn-big {
        width: 85%;
        max-width: 320px;
        padding: 16px;
        border-radius: var(--radius-xl);
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.01em;
        border: none;
        margin: 8px 0;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-family: var(--font-family);
        background: rgba(255, 255, 255, 0.15);
        color: white;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }

    .vote-btn-big.green {
        background: var(--apple-green);
    }

    .vote-btn-big.red {
        background: var(--apple-red);
    }

    .vote-btn-big.blue {
        background: var(--apple-blue);
    }

    .vote-btn-big:active {
        transform: scale(0.96);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .vote-btn-big:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    }

    .vote-btn-big:disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    .lady-target-btn {
        padding: 16px;
        border-radius: 20px;
        font-size: 1.15rem;
        font-weight: 700;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        color: white;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        width: 100%;
    }

    .lady-target-btn:not(:disabled):hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
    }

    .lady-target-btn:not(:disabled):active {
        transform: scale(0.96);
    }

    .lady-target-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 85%;
        max-width: 320px;
    }

    .error-toast {
        position: fixed;
        top: 24px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20000;
        padding: 14px 28px;
        border-radius: 30px;
        background: rgba(255, 59, 48, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 0.95rem;
        font-weight: 600;
        box-shadow: 0 12px 24px rgba(255, 59, 48, 0.3);
        letter-spacing: -0.01em;
    }

    .count-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-lg);
        margin: var(--space-lg) 0;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 24px;
        padding: 12px;
    }

    .count-control .count-display {
        font-size: 2.5rem;
        font-weight: 800;
        min-width: 60px;
        text-align: center;
        letter-spacing: -0.04em;
        color: var(--apple-black);
    }

    .count-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: var(--apple-white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        font-size: 1.5rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        color: var(--apple-blue);
    }

    .count-btn:active {
        transform: scale(0.9);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .config-preview {
        background: rgba(0, 0, 0, 0.03);
        border-radius: 16px;
        padding: var(--space-lg);
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--apple-gray);
        margin-bottom: var(--space-lg);
        line-height: 1.6;
    }

    .status-box {
        text-align: center;
        padding: var(--space-2xl) 0;
    }

    .status-count {
        font-size: 4rem;
        font-weight: 800;
        color: var(--apple-black);
        letter-spacing: -0.04em;
    }

    .status-count .total {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--apple-gray);
    }

    .chips-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .apple-chip {
        padding: 8px 16px;
        font-size: 0.9rem;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        font-weight: 600;
    }

    .lb-section {
        padding: var(--space-xl) 0;
    }

    .lb-title {
        font-size: 1.4rem;
        font-weight: 800;
        text-align: center;
        margin-bottom: var(--space-md);
        letter-spacing: -0.03em;
    }



    .lancelot-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        margin: var(--space-md) 0;
        font-size: 0.9rem;
    }

    .lancelot-toggle label {
        cursor: pointer;
        color: var(--apple-gray);
        font-weight: 600;
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        inset: 0;
        background: var(--apple-gray-light);
        border-radius: 30px;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked+.toggle-slider {
        background: var(--apple-blue);
    }

    .toggle-switch input:checked+.toggle-slider::before {
        transform: translateX(20px);
    }

    .swap-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        font-size: 0.6rem;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--apple-orange);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .swap-badge.no-swap {
        background: var(--apple-gray-light);
        color: var(--apple-gray);
    }

    .alignment-swap-indicator {
        display: inline-block;
        animation: pulse-glow 1.5s ease-in-out infinite;
    }

    @keyframes pulse-glow {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }
    }

    .reveal-list {
        list-style: none;
        padding: 0;
    }

    .reveal-list li {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.06);
        font-size: 1rem;
    }

    .reveal-list li:last-child {
        border-bottom: none;
    }

    .apple-toggle-input:checked+.apple-toggle-btn {
        background: var(--apple-blue);
        border-color: var(--apple-blue);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
    }

    .apple-btn-primary {
        box-shadow: 0 4px 14px rgba(0, 113, 227, 0.3);
    }

    .apple-btn-success {
        box-shadow: 0 4px 14px rgba(52, 199, 89, 0.3);
    }

    /* Transitions */
    .fade-enter-active,
    .fade-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .fade-enter-from,
    .fade-leave-to {
        opacity: 0;
        transform: translateY(12px) scale(0.98);
    }

    .overlay-enter-active,
    .overlay-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), backdrop-filter 0.4s;
    }

    .overlay-enter-from,
    .overlay-leave-to {
        opacity: 0;
        backdrop-filter: blur(0px);
    }

    .slide-up-enter-active,
    .slide-up-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .slide-up-enter-from,
    .slide-up-leave-to {
        opacity: 0;
        transform: translateY(20px);
    }
</style>
{% endblock %}

{% block nav_title %}
<i class="ph-fill ph-shield-check text-blue" style="margin-right: 4px;"></i> é˜¿ç“¦éš†
{% endblock %}

{% block content %}
{% raw %}
<div id="app" v-cloak>

    <!-- Hero -->
    <div class="apple-hero">
        <span class="apple-hero-emoji">ğŸ›¡ï¸</span>
        <h1>é˜¿ç“¦éš†</h1>
        <p>é˜µè¥æ¨ç† Â· èº«ä»½éšè—</p>
    </div>

    <!-- Error Toast -->
    <transition name="slide-up">
        <div v-if="errorMsg" class="error-toast">{{ errorMsg }}</div>
    </transition>

    <style>
        /* Setup switch style specific overrides */
        #lady-toggle-input:checked+.toggle-slider {
            background: var(--apple-purple, #af52de) !important;
        }
    </style>

    <!-- Step 1: Join / Setup -->
    <div v-if="step === 1" class="apple-section">

        <div class="apple-card">
            <h4 class="mb-md">åŠ å…¥æ¸¸æˆ</h4>
            <input v-model="myName" class="apple-input mb-md" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">

            <div v-if="status === 'joining'" class="apple-alert apple-alert-info mb-md">
                <div class="d-flex justify-between items-center">
                    <span class="apple-tag apple-tag-blue">ç­‰å¾…ä¸­</span>
                    <span class="fw-700">{{ currentCount }} / {{ targetCount }} äºº</span>
                </div>
                <div class="text-muted text-sm mt-sm">å·²åŠ å…¥: {{ allPlayers.join(', ') }}</div>
            </div>

            <div v-if="status === 'joining'">
                <button class="apple-btn apple-btn-primary apple-btn-block" @click="joinGame"
                    :disabled="!myName">åŠ å…¥æˆ¿é—´</button>
            </div>
            <div v-if="status === 'active' || status === 'assassin'">
                <div class="apple-alert apple-alert-info mb-md">æ¸¸æˆå·²å¼€å§‹ï¼Œè¾“å…¥åå­—é‡è¿</div>
                <button class="apple-btn apple-btn-primary apple-btn-block" style="background: var(--apple-orange);"
                    @click="joinGame" :disabled="!myName">é‡è¿</button>
            </div>
            <div v-if="status === 'empty'" class="text-center text-muted" style="padding: var(--space-lg) 0;">
                å½“å‰æ— æˆ¿é—´ï¼Œè¯·å…ˆåˆ›å»º
            </div>
        </div>

        <div v-if="status === 'empty'" class="apple-card">
            <h4 class="mb-md">åˆ›å»ºæ–°æˆ¿é—´</h4>
            <p class="text-sm text-muted mb-md">æ ‡å‡†åŒ…é…ç½®</p>

            <div class="count-control">
                <button class="count-btn" @click="decrementPlayerCount()">âˆ’</button>
                <div class="count-display">{{ playerCount }}</div>
                <button class="count-btn" @click="incrementPlayerCount()">+</button>
            </div>

            <!-- æ¹–ä¸­ä»™å¥³å¼€å…³ (8äººå±€åŠä»¥ä¸Š) -->
            <div v-if="playerCount >= 8" class="lancelot-toggle">
                <span>ğŸ§š å¯ç”¨æ¹–ä¸­ä»™å¥³</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="lady-toggle-input" v-model="ladyOfLakeEnabled">
                    <label for="lady-toggle-input" class="toggle-slider"></label>
                </div>
            </div>

            <!-- ç‹è€…ä¹‹å‰‘å¼€å…³ (8-12äººå±€å¯é€‰) -->
            <div v-if="playerCount >= 8" class="lancelot-toggle">
                <span>ğŸ—¡ï¸ å¯ç”¨ç‹è€…ä¹‹å‰‘</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="excalibur-toggle-input" v-model="excaliburEnabled">
                    <label for="excalibur-toggle-input" class="toggle-slider"></label>
                </div>
            </div>

            <!-- å…°æ–¯æ´›ç‰¹å¼€å…³ (10äººå’Œ12äººå±€) -->
            <div v-if="playerCount === 10 || playerCount === 12" class="lancelot-toggle">
                <span>âš”ï¸ å¯ç”¨å…°æ–¯æ´›ç‰¹</span>
                <div class="toggle-switch" :style="playerCount === 12 ? 'opacity: 0.6; pointer-events: none;' : ''">
                    <input type="checkbox" id="lancelot-toggle-input" v-model="lancelotEnabled"
                        :disabled="playerCount === 12">
                    <label for="lancelot-toggle-input" class="toggle-slider"></label>
                </div>
            </div>

            <div class="config-preview" v-html="getConfigPreview()"></div>

            <button class="apple-btn apple-btn-success apple-btn-block apple-btn-lg" @click="createGame">å¼€æ–°å±€</button>
        </div>
    </div>

    <!-- Avalon Leaderboard -->
    <div v-if="step === 1" id="inline-leaderboard-section">
        <div class="section-title" style="margin-top: var(--space-xl); margin-bottom: var(--space-md);">ğŸ† å†å²æ’è¡Œæ¦œ
        </div>
        <div class="apple-list mb-xl">
            <div v-if="lbData.length === 0" class="text-center text-muted" style="padding: var(--space-xl);">
                <div class="empty-state">
                    <span class="empty-icon">ğŸ‘»</span>
                    è¿˜æ²¡äººç©è¿‡å‘¢ï¼Œå¿«å»å¼€ä¸€å±€ï¼
                </div>
            </div>
            <div v-else>
                <div v-for="(p, i) in lbData" :key="p.name" class="apple-list-item">
                    <div class="rank-num"
                        :class="i === 0 ? 'rank-1' : (i === 1 ? 'rank-2' : (i === 2 ? 'rank-3' : 'rank-other'))">
                        {{ i === 0 ? 'ğŸ‘‘' : i + 1 }}
                    </div>

                    <div class="apple-list-item-content">
                        <div class="apple-list-item-title">{{ p.name }}</div>
                    </div>

                    <div style="text-align: right; display: flex; align-items: center; gap: 16px;">
                        <div style="text-align: right;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">èƒœè´Ÿ</div>
                            <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">{{ p.wins
                                }}-{{ p.total - p.wins }}</div>
                        </div>
                        <div style="text-align: right; width: 60px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">èƒœç‡</div>
                            <div class="score-badge" style="font-size: 1.2rem; color: var(--apple-green);">{{ p.win_rate
                                }}%</div>
                        </div>
                        <div style="text-align: right; width: 40px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">åœºæ¬¡</div>
                            <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">{{ p.total }}å±€
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Lobby -->
    <div v-if="step === 2" class="apple-section">
        <div class="apple-card">
            <div v-if="status === 'joining'" class="status-box">
                <p class="text-muted mb-sm">ç­‰å¾…ç©å®¶åŠ å…¥...</p>
                <div class="status-count">{{ currentCount }} <span class="total">/ {{ targetCount }}</span>
                </div>
                <div class="d-flex justify-center mt-md">
                    <div class="apple-spinner"></div>
                </div>
                <p class="text-sm text-muted mt-md">æ»¡å‘˜åè‡ªåŠ¨å‘ç‰Œå¼€å§‹</p>
            </div>
            <div v-else-if="status === 'active'" class="status-box">
                <h3 class="text-green">æ¸¸æˆå¼€å§‹!</h3>
            </div>

            <div class="chips-wrap mt-md">
                <span v-for="p in allPlayers" class="apple-chip" :class="{me: p===myName}">{{ p }}</span>
            </div>

            <div class="text-center mt-lg"
                style="border-top: 0.5px solid rgba(0,0,0,0.06); padding-top: var(--space-md);">
                <button class="apple-btn apple-btn-sm apple-btn-outline"
                    style="color: var(--apple-red); border-color: rgba(255,59,48,0.3);" @click="resetGame">é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <!-- Step 3: Main Game -->
    <div v-if="step === 3" class="apple-section" style="padding-top: var(--space-md);">

        <!-- Identity -->
        <div class="apple-card mb-md">
            <div class="d-flex justify-between items-center mb-md">
                <h5 style="margin:0;">ä½ çš„èº«ä»½</h5>
                <button class="apple-btn apple-btn-sm apple-btn-secondary" @click="showRole=!showRole">{{
                    showRole?'éšè—':'æ˜¾ç¤º' }}</button>
            </div>
            <div v-if="showRole">
                <div class="apple-role" :class="isCurrentlyEvil() ? 'evil' : 'good'">
                    <img :src="getRoleImage(myRole)" class="role-img" v-if="myRole"
                        style="display:block; margin:0 auto;">
                    <div style="font-size:1.2rem;">{{ roleMap[myRole] || myRole }}</div>
                    <!-- å…°æ–¯æ´›ç‰¹é˜µè¥çŠ¶æ€ -->
                    <div v-if="currentAlignment" class="mt-sm text-sm"
                        :class="currentAlignment === 'evil' ? 'text-red' : 'text-blue'">
                        <span :class="{'alignment-swap-indicator': lancelotSwapped}">
                            {{ currentAlignment === 'evil' ? 'âš¡ å½“å‰é˜µè¥: é‚ªæ¶' : 'ğŸ›¡ï¸ å½“å‰é˜µè¥: æ­£ä¹‰' }}
                        </span>
                    </div>
                </div>
                <div v-if="visionData.length" class="mt-md"
                    style="background:var(--apple-bg); padding:var(--space-md); border-radius:var(--radius-md);">
                    <div class="fw-600 text-sm mb-sm">ä½ çš„è§†é‡</div>
                    <ul class="vision-list">
                        <li v-for="v in visionData"
                            :class="{'evil': v.identity.includes('å') || v.identity.includes('åŒ')}">
                            {{ v.name }}: {{ v.identity }}
                        </li>
                    </ul>
                </div>
                <div v-else class="text-center text-muted text-sm mt-md">(ä½ æ²¡æœ‰ç‰¹æ®Šè§†é‡)</div>
            </div>
        </div>

        <!-- Mission Progress -->
        <div class="apple-card mb-md text-center">
            <div class="apple-dots mb-md">
                <div v-for="i in 5" class="apple-dot"
                    :class="[getMissionStatusClass(i), {current: i === missionHistory.length + 1}]">
                    <span>{{ i }}</span>
                    <span class="sub" v-if="missionHistory[i-1]">{{ missionHistory[i-1].fail_count }}å</span>
                    <!-- å…°æ–¯æ´›ç‰¹è½¬æ¢ç‰Œå¾½æ ‡ -->
                    <span
                        v-if="lancelotEnabled && lancelotSwapReveal[i-1] !== null && lancelotSwapReveal[i-1] !== undefined"
                        class="swap-badge" :class="{'no-swap': !lancelotSwapReveal[i-1]}">
                        {{ lancelotSwapReveal[i-1] ? 'âš¡' : 'â€”' }}
                    </span>
                </div>
            </div>
            <div class="text-sm text-muted">
                æµå±€: <span class="fw-700 text-red">{{ voteFailCount }}/5</span>
                &nbsp;|&nbsp; ç¬¬ {{ missionHistory.length + 1 }} è½®éœ€ <span class="fw-700">{{ requiredTeamSize
                    }}</span> äºº
            </div>
            <div class="text-sm mt-xs" v-if="captain">
                ğŸ‘‘ å½“å‰é˜Ÿé•¿: <span class="fw-700 text-orange">{{ captain }}</span>
            </div>
            <!-- æ¹–ä¸­ä»™å¥³æŒæœ‰è€… -->
            <div class="text-sm mt-xs" v-if="ladyOfLakeHolder">
                ğŸ§š æ¹–ä¸­ä»™å¥³: <span class="fw-700" style="color: var(--apple-purple, #af52de);">{{ ladyOfLakeHolder
                    }}</span>
            </div>
        </div>

        <!-- Lady of the Lake Result (ä»…æŒæœ‰è€…å¯è§) -->
        <div v-if="ladyOfLakeResult && ladyOfLakeInspector === myName" class="apple-card mb-md"
            style="border: 2px solid var(--apple-purple, #af52de);">
            <h6 class="text-center mb-sm" style="color: var(--apple-purple, #af52de);">ğŸ§š æŸ¥éªŒç»“æœ</h6>
            <div class="text-center">
                <strong>{{ ladyOfLakeResult.target }}</strong> çš„é˜µè¥æ˜¯:
                <span :class="ladyOfLakeResult.alignment === 'good' ? 'text-blue fw-700' : 'text-red fw-700'">
                    {{ ladyOfLakeResult.alignment === 'good' ? 'ğŸ›¡ï¸ å¥½äºº' : 'ğŸ—¡ï¸ åäºº' }}
                </span>
            </div>
            <div class="text-sm text-muted text-center mt-sm">ä½ å¯ä»¥é€‰æ‹©å…¬å¸ƒçœŸç›¸æˆ–è¿›è¡Œä¼ªè£…</div>
        </div>

        <!-- Last Vote Snapshot -->
        <div v-if="Object.keys(lastVoteSnapshot).length" class="apple-card mb-md">
            <h6 class="mb-sm text-sm text-muted fw-600">ä¸Šè½®æŠ•ç¥¨ç¥¨å‹</h6>
            <div class="chips-wrap">
                <span v-for="(vote, name) in lastVoteSnapshot" class="apple-chip"
                    :class="{'approve': vote==='approve', 'reject': vote==='reject'}">
                    {{ name }} <i class="fas" :class="vote==='approve'?'fa-check text-green':'fa-times text-red'"
                        style="margin-left:4px;"></i>
                </span>
            </div>
        </div>

        <!-- Vote Team Phase -->
        <div v-if="voteTeamActive" class="apple-card mb-md" style="border: 2px solid var(--apple-blue);">
            <h5 class="text-center text-blue mb-md">ğŸ—³ï¸ ç»„é˜ŸæŠ•ç¥¨ä¸­</h5>
            <div class="team-display">
                <div class="text-sm text-muted">æè®®é˜Ÿä¼</div>
                <div class="names">{{ missionTeam.join('ã€') }}</div>
            </div>
            <div class="chips-wrap mt-md">
                <span v-for="p in allPlayers" class="apple-chip"
                    :class="{'approve': teamVotes[p]==='approve', 'reject': teamVotes[p]==='reject'}"
                    :style="!teamVotes[p] ? 'opacity:0.4' : ''">
                    {{ p }} <i v-if="teamVotes[p]" class="fas" :class="teamVotes[p]==='approve'?'fa-check':'fa-times'"
                        style="margin-left:4px;"></i>
                </span>
            </div>
            <div v-if="lastVoteResult" class="mt-md apple-alert"
                :class="lastVoteResult==='approved'?'apple-alert-success':'apple-alert-danger'">
                æŠ•ç¥¨ç»“æœ: {{ lastVoteResult==='approved'?'âœ… é€šè¿‡':'âŒ æ‹’ç»' }}
            </div>
        </div>

        <!-- Propose Team -->
        <div v-if="!voteTeamActive && !missionActive && !ladyOfLakeActive && status==='active'"
            class="apple-card mb-md">
            <div class="d-flex justify-between items-center mb-md">
                <h5 style="margin:0;">å‘èµ·ç»„é˜Ÿ</h5>
                <span class="apple-tag apple-tag-orange">éœ€ {{ requiredTeamSize }} äºº</span>
            </div>
            <div class="apple-toggle-grid mb-md">
                <template v-for="p in allPlayers" :key="p">
                    <input type="checkbox" :id="'chk-'+p" :value="p" v-model="selectedTeam" class="apple-toggle-input">
                    <label :for="'chk-'+p" class="apple-toggle-btn">
                        {{ p === captain ? 'ğŸ‘‘' : '' }}{{ p }}
                    </label>
                </template>
            </div>
            <button class="apple-btn apple-btn-primary apple-btn-block apple-btn-lg" @click="proposeTeam"
                :disabled="selectedTeam.length !== requiredTeamSize">
                ğŸš€ å‘è½¦ ({{ selectedTeam.length }}/{{ requiredTeamSize }})
            </button>
        </div>

        <!-- Mission Execution -->
        <div v-if="missionActive" class="apple-card mb-md" style="border: 2px solid var(--apple-green);">
            <h5 class="text-center text-green mb-md">âš”ï¸ ä»»åŠ¡æ‰§è¡Œä¸­</h5>
            <p class="text-center">é˜Ÿå‘˜: <strong>{{ missionTeam.join('ã€') }}</strong></p>
            <div v-if="!missionTeam.includes(myName)" class="text-center text-muted text-sm mt-md">ç­‰å¾…é˜Ÿå‘˜å‡ºç¥¨...
            </div>
        </div>

        <!-- Lady of the Lake Active (ç­‰å¾…ä»™å¥³æŸ¥éªŒ) -->
        <div v-if="ladyOfLakeActive && ladyOfLakeHolder !== myName" class="apple-card mb-md"
            style="border: 2px solid var(--apple-purple, #af52de);">
            <h5 class="text-center mb-md" style="color: var(--apple-purple, #af52de);">ğŸ§š æ¹–ä¸­ä»™å¥³æŸ¥éªŒä¸­</h5>
            <p class="text-center text-muted">ç­‰å¾… <strong>{{ ladyOfLakeHolder }}</strong> é€‰æ‹©æŸ¥éªŒç›®æ ‡...</p>
        </div>

        <!-- Overlay: Vote Team -->
        <transition name="overlay">
            <div v-if="voteTeamActive && !teamVotes[myName]" class="vote-overlay">
                <h2>åŒæ„è¿™ä¸ªé˜Ÿä¼å—?</h2>
                <div class="vote-team-box"><strong>{{ missionTeam.join('ã€') }}</strong></div>
                <button class="vote-btn-big green" @click="submitTeamVote('approve')">ğŸ‘ åŒæ„</button>
                <button class="vote-btn-big red" @click="submitTeamVote('reject')">ğŸ‘ åå¯¹</button>
            </div>
        </transition>

        <!-- Overlay: Mission Vote -->
        <transition name="overlay">
            <div v-if="missionActive && missionTeam.includes(myName) && !hasActed" class="vote-overlay">
                <h2>æ‰§è¡Œä»»åŠ¡</h2>
                <button class="vote-btn-big blue" @click="voteMission('success')" :disabled="isLancelotMustFail()"
                    :style="isLancelotMustFail()?'opacity:0.35':''">ğŸ›¡ï¸
                    æˆåŠŸ</button>
                <button class="vote-btn-big red" @click="voteMission('fail')" :disabled="!isCurrentlyEvil()"
                    :style="!isCurrentlyEvil()?'opacity:0.35':''">ğŸ—¡ï¸ å¤±è´¥</button>
                <div v-if="!isCurrentlyEvil()"
                    style="color: rgba(255,255,255,0.5); margin-top: var(--space-sm); font-size: 0.85rem;">
                    å¥½äººåªèƒ½æŠ•æˆåŠŸ
                </div>
                <div v-if="isLancelotMustFail()"
                    style="color: rgba(255,255,255,0.5); margin-top: var(--space-sm); font-size: 0.85rem;">
                    å½“å‰é˜µè¥ä¸ºé‚ªæ¶çš„å…°æ–¯æ´›ç‰¹å¿…é¡»æŠ•å¤±è´¥
                </div>
            </div>
        </transition>

        <!-- Overlay: Lady of the Lake -->
        <transition name="overlay">
            <div v-if="ladyOfLakeActive && ladyOfLakeHolder === myName" class="vote-overlay">
                <h2>ğŸ§š æ¹–ä¸­ä»™å¥³</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: var(--space-lg); text-align: center;">
                    é€‰æ‹©ä¸€åç©å®¶æŸ¥éªŒå…¶é˜µè¥
                </p>
                <div class="lady-target-list">
                    <button v-for="p in allPlayers" :key="'lady-'+p" class="lady-target-btn"
                        :disabled="ladyOfLakeHistory.includes(p) || p === myName" @click="inspectPlayer(p)">
                        {{ p }}
                        <span v-if="ladyOfLakeHistory.includes(p)" style="font-size:0.75rem; opacity:0.5;">
                            (å·²æŸ¥éªŒ)</span>
                    </button>
                </div>
            </div>
        </transition>

        <!-- Overlay: Lady of Lake Result -->
        <transition name="overlay">
            <div v-if="showLadyResult" class="vote-overlay" @click="showLadyResult = false">
                <h2>ğŸ§š æŸ¥éªŒç»“æœ</h2>
                <div class="lady-result-box">
                    <div class="fw-700 mb-md" style="font-size:1.1rem;">{{ ladyResultData.target }}</div>
                    <div :class="ladyResultData.alignment === 'good' ? 'alignment-good' : 'alignment-evil'">
                        {{ ladyResultData.alignment === 'good' ? 'ğŸ›¡ï¸ å¥½äºº' : 'ğŸ—¡ï¸ åäºº' }}
                    </div>
                    <p class="text-sm text-muted mt-md">ä½ å¯ä»¥è‡ªç”±é€‰æ‹©å…¬å¸ƒæˆ–éšç’æ­¤ç»“æœ</p>
                </div>
                <p style="color: rgba(255,255,255,0.4); margin-top: var(--space-lg); font-size: 0.85rem;">
                    ç‚¹å‡»ä»»æ„å¤„å…³é—­
                </p>
            </div>
        </transition>

        <!-- Overlay: Excalibur Assign (é˜Ÿé•¿åˆ†é…ç‹è€…ä¹‹å‰‘) -->
        <transition name="overlay">
            <div v-if="excaliburPhase === 'assign' && myName === captain" class="vote-overlay">
                <h2>ğŸ—¡ï¸ åˆ†é…ç‹è€…ä¹‹å‰‘</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: var(--space-lg); text-align: center;">
                    é€‰æ‹©ä¸€åé˜Ÿå‘˜æŒæœ‰ç‹è€…ä¹‹å‰‘
                </p>
                <div class="lady-target-list">
                    <button v-for="p in missionTeam" :key="'exc-'+p" class="lady-target-btn" :disabled="p === myName"
                        @click="assignExcalibur(p)">
                        {{ p }}
                        <span v-if="p === myName" style="font-size:0.75rem; opacity:0.5;">(è‡ªå·±)</span>
                    </button>
                </div>
            </div>
        </transition>

        <!-- Excalibur Assign waiting (non-captain sees waiting) -->
        <div v-if="excaliburPhase === 'assign' && myName !== captain" class="apple-card mb-md"
            style="border: 2px solid var(--apple-orange);">
            <h5 class="text-center mb-md" style="color: var(--apple-orange);">ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘åˆ†é…ä¸­</h5>
            <p class="text-center text-muted">ç­‰å¾…é˜Ÿé•¿ <strong>{{ captain }}</strong> åˆ†é…ç‹è€…ä¹‹å‰‘...</p>
        </div>

        <!-- Excalibur holder badge during mission -->
        <div v-if="excaliburHolder && excaliburPhase === 'mission' && !missionActive"
            class="apple-card mb-md text-center" style="border: 2px solid var(--apple-orange);">
            <p>ğŸ—¡ï¸ <strong>{{ excaliburHolder }}</strong> æŒæœ‰ç‹è€…ä¹‹å‰‘</p>
        </div>

        <!-- Overlay: Excalibur Decide (æŒå‰‘è€…å†³ç­–) -->
        <transition name="overlay">
            <div v-if="excaliburPhase === 'decide' && myName === excaliburHolder" class="vote-overlay">
                <h2>ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: var(--space-lg); text-align: center;">
                    é€‰æ‹©ä¸€åé˜Ÿå‘˜æ›¿æ¢å…¶æŠ•ç¥¨å¹¶æŸ¥çœ‹ç»“æœï¼Œæˆ–è·³è¿‡
                </p>
                <div class="lady-target-list">
                    <button v-for="p in missionTeam" :key="'excu-'+p" class="lady-target-btn" @click="useExcalibur(p)">
                        ğŸ—¡ï¸ {{ p }}
                    </button>
                    <button class="lady-target-btn" style="background: rgba(255,255,255,0.08); margin-top: 8px;"
                        @click="useExcalibur(null)">
                        âœ• ä¸ä½¿ç”¨
                    </button>
                </div>
            </div>
        </transition>

        <!-- Excalibur decide waiting (non-holder) -->
        <div v-if="excaliburPhase === 'decide' && myName !== excaliburHolder" class="apple-card mb-md"
            style="border: 2px solid var(--apple-orange);">
            <h5 class="text-center mb-md" style="color: var(--apple-orange);">ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘å†³ç­–ä¸­</h5>
            <p class="text-center text-muted">ç­‰å¾… <strong>{{ excaliburHolder }}</strong> å†³å®šæ˜¯å¦ä½¿ç”¨ç‹è€…ä¹‹å‰‘...</p>
        </div>

        <!-- Overlay: Excalibur Result (æŒå‰‘è€…æŸ¥çœ‹ç»“æœ) -->
        <transition name="overlay">
            <div v-if="showExcaliburResult" class="vote-overlay" @click="showExcaliburResult = false">
                <h2>ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘ç»“æœ</h2>
                <div class="lady-result-box">
                    <div class="fw-700 mb-md" style="font-size:1.1rem;">{{ excaliburResultData.target }}</div>
                    <div :class="excaliburResultData.original_vote === 'fail' ? 'alignment-evil' : 'alignment-good'">
                        {{ excaliburResultData.original_vote === 'fail' ? 'ğŸ—¡ï¸ åŸå§‹æŠ•ç¥¨ï¼šå¤±è´¥' : 'ğŸ›¡ï¸ åŸå§‹æŠ•ç¥¨ï¼šæˆåŠŸ' }}
                    </div>
                    <div style="margin-top: var(--space-md); font-size: 0.85rem; color: rgba(255,255,255,0.5);">
                        å·²æ›¿æ¢ä¸º{{ excaliburResultData.original_vote === 'fail' ? 'æˆåŠŸ' : 'å¤±è´¥' }}ç¥¨ï¼Œç‚¹å‡»ä»»æ„å¤„å…³é—­
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <!-- Assassin Phase -->
    <div v-if="status === 'assassin'" class="apple-section">
        <div class="apple-card text-center">
            <h3 class="text-red mb-lg"><i class="ph-fill ph-skull"></i> åˆºæ€é˜¶æ®µ</h3>
            <p class="text-muted mb-lg">å¥½äººå®Œæˆäº†3ä¸ªä»»åŠ¡ï¼{{ getAssassinRoleName() }}æ­£åœ¨é€‰æ‹©åˆºæ€ç›®æ ‡...</p>

            <div v-if="canAssassinate()">
                <h5 class="mb-md">é€‰æ‹©åˆºæ€ç›®æ ‡ (çŒœæµ‹æ¢…æ—)</h5>
                <div class="apple-toggle-grid">
                    <template v-for="p in allPlayers" :key="'kill-'+p">
                        <button class="apple-btn apple-btn-outline"
                            style="color: var(--apple-red); border-color: rgba(255,59,48,0.3);" @click="assassinate(p)">
                            {{ p }}
                        </button>
                    </template>
                </div>
            </div>
            <div v-else class="text-muted">ç­‰å¾…{{ getAssassinRoleName() }}é€‰æ‹©...</div>
        </div>
    </div>

    <!-- Game Over -->
    <div v-if="status === 'ended'" class="apple-section">
        <div class="apple-card text-center">
            <h2 class="mb-lg" :class="gameWinner==='good'?'text-blue':'text-red'" style="font-size:1.8rem;">
                {{ gameWinner === 'good' ? 'ğŸ›¡ï¸ å¥½äººèƒœåˆ©!' : 'ğŸ—¡ï¸ åäººèƒœåˆ©!' }}
            </h2>
            <div v-if="assassinTarget" class="text-muted mb-lg">
                åˆºå®¢åˆºæ€äº†: <strong class="text-red">{{ assassinTarget }}</strong>
            </div>
            <ul class="reveal-list mb-lg" style="padding: 0 var(--space-md);">
                <li v-for="p in revealedPlayers">
                    <span>{{ p.name }}</span>
                    <span :class="isEvil(p.role)?'text-red fw-600':'text-blue fw-600'">{{ roleMap[p.role]
                        }}</span>
                </li>
            </ul>
            <button class="apple-btn apple-btn-primary apple-btn-block apple-btn-lg mb-sm" @click="quickRestart">ğŸ”„
                ä¸€é”®é‡å¼€</button>
            <button class="apple-btn apple-btn-secondary apple-btn-block" @click="resetGame">âš™ï¸ æ›´æ¢äººæ•°</button>
        </div>
    </div>

    <!-- Game Controls -->
    <div v-if="step === 3 || status === 'assassin' || status === 'active'" class="apple-card text-center"
        style="background: var(--apple-bg); box-shadow: none; margin-top: var(--space-lg);">
        <div class="game-controls">
            <button class="apple-btn apple-btn-sm" style="background: var(--apple-orange); color: white;"
                @click="quickRestart">ğŸ”„ é‡å¼€</button>
            <button class="apple-btn apple-btn-sm apple-btn-outline"
                style="color: var(--apple-red); border-color: rgba(255,59,48,0.3);" @click="endGame">ğŸšª ç»“æŸ
        </div>

        <footer class="apple-footer">
            <p>Avalon Â© 2026</p>
        </footer>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    const {
        createApp
    } = Vue;
    createApp({
        data() {
            return {
                step: 1,
                status: 'empty',
                errorMsg: '',
                myName: localStorage.getItem('avalon_name') || '',
                playerCount: 5,
                lancelotEnabled: false,
                ladyOfLakeEnabled: true,
                targetCount: 0,
                currentCount: 0,
                allPlayers: [],
                missionHistory: [],
                voteFailCount: 0,
                missionActive: false,
                missionTeam: [],
                hasActed: false,
                myRole: '',
                visionData: [],
                showRole: true,
                voteTeamActive: false,
                teamVotes: {},
                lastVoteResult: null,
                lastVoteSnapshot: {},
                selectedTeam: [],
                revealedPlayers: [],
                captain: null,
                requiredTeamSize: 2,
                gameWinner: null,
                assassinTarget: null,
                // æ¹–ä¸­ä»™å¥³
                ladyOfLakeHolder: null,
                ladyOfLakeActive: false,
                ladyOfLakeResult: null,
                ladyOfLakeInspector: null,
                ladyOfLakeHistory: [],
                showLadyResult: false,
                ladyResultData: {},
                // å…°æ–¯æ´›ç‰¹
                lancelotSwapped: false,
                lancelotSwapReveal: [],
                currentAlignment: null,
                // åˆºæ€è§’è‰²
                assassinRole: null,
                // ç‹è€…ä¹‹å‰‘
                excaliburEnabled: false,
                excaliburHolder: null,
                excaliburPhase: 'none',
                excaliburResult: null,
                showExcaliburResult: false,
                excaliburResultData: {},
                // æ’è¡Œæ¦œ
                lbData: [],
                roleMap: {
                    'Merlin': 'æ¢…æ—',
                    'Percival': 'æ´¾è¥¿ç»´å°”',
                    'Loyal Servant': 'å¿ è‡£',
                    'Morgana': 'è«ç”˜å¨œ',
                    'Assassin': 'åˆºå®¢',
                    'Mordred': 'è«å¾·é›·å¾·',
                    'Oberon': 'å¥¥ä¼¯ä¼¦',
                    'Minion': 'çˆªç‰™',
                    'Lancelot Good': 'å…°æ–¯æ´›ç‰¹(æ­£ä¹‰)',
                    'Lancelot Evil': 'å…°æ–¯æ´›ç‰¹(é‚ªæ¶)'
                },
                configPresets: {
                    5: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢',
                    6: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—2<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢',
                    7: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—2<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, å¥¥ä¼¯ä¼¦',
                    8: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—3<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, çˆªç‰™',
                    9: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—4<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, è«å¾·é›·å¾·',
                    10: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—4<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, å¥¥ä¼¯ä¼¦, è«å¾·é›·å¾·',
                    '10_lancelot': 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—3, å…°æ–¯æ´›ç‰¹(æ­£ä¹‰)<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, è«å¾·é›·å¾·, å¥¥ä¼¯ä¼¦, å…°æ–¯æ´›ç‰¹(é‚ªæ¶)<br><br><small style="color:var(--apple-orange)">âš ï¸ æ— åˆºå®¢ï¼Œè«ç”˜å¨œæ‰§è¡Œåˆºæ€</small>',
                    12: 'ğŸ›¡ï¸ å¥½äºº: æ¢…æ—, æ´¾è¥¿ç»´å°”, å¿ è‡£Ã—4, å…°æ–¯æ´›ç‰¹(æ­£ä¹‰)<br>ğŸ—¡ï¸ åäºº: è«ç”˜å¨œ, åˆºå®¢, è«å¾·é›·å¾·, å¥¥ä¼¯ä¼¦, å…°æ–¯æ´›ç‰¹(é‚ªæ¶)',
                }
            }
        },
        watch: {
            myName(val) {
                localStorage.setItem('avalon_name', val);
            }
        },
        mounted() {
            this.startPolling();
            this.fetchLeaderboard();
        },
        methods: {
            incrementPlayerCount() {
                if (this.playerCount === 10) {
                    this.playerCount = 12;
                    this.lancelotEnabled = true;
                } else if (this.playerCount < 10) {
                    this.playerCount++;
                }
            },
            decrementPlayerCount() {
                if (this.playerCount === 12) this.playerCount = 10;
                else if (this.playerCount > 5) this.playerCount--;
            },
            getConfigPreview() {
                let preview;
                if ((this.playerCount === 10 || this.playerCount === 12) && this.lancelotEnabled) {
                    preview = this.playerCount === 10 ? this.configPresets['10_lancelot'] : this
                        .configPresets[12];
                } else {
                    preview = this.configPresets[this.playerCount] || this.configPresets[6];
                }
                let extraProps = [];
                if (this.ladyOfLakeEnabled && this.playerCount >= 8) {
                    extraProps.push('<span style="color:var(--apple-purple,#af52de)">ğŸ§š æ¹–ä¸­ä»™å¥³</span>');
                }
                if (this.excaliburEnabled && this.playerCount >= 8) {
                    extraProps.push('<span style="color:var(--apple-orange)">ğŸ—¡ï¸ ç‹è€…ä¹‹å‰‘</span>');
                }
                if (this.lancelotEnabled && this.playerCount >= 10) {
                    extraProps.push('<span style="color:var(--apple-red)">âš”ï¸ å…°æ–¯æ´›ç‰¹</span>');
                }
                if (extraProps.length > 0) {
                    preview +=
                        '<br><div style="margin-top:8px; font-weight:600; font-size: 0.85em;">é™„åŠ é€‰é¡¹: ' +
                        extraProps.join(' | ') + '</div>';
                }
                return preview;
            },
            async createGame() {
                try {
                    await axios.post('/avalon/reset_game', {
                        player_count: this.playerCount,
                        lancelot_enabled: this.lancelotEnabled && (this.playerCount ===
                            10 || this.playerCount === 12),
                        excalibur_enabled: this.excaliburEnabled && this.playerCount >= 8,
                        lady_of_lake_enabled: this.ladyOfLakeEnabled && this.playerCount >=
                            8
                    });
                    this.joinGame();
                } catch (e) {
                    this.showError(e);
                }
            },
            async joinGame() {
                if (!this.myName) return;
                try {
                    await axios.post('/avalon/join', {
                        player_name: this.myName
                    });
                    this.step = 2;
                } catch (e) {
                    this.showError(e);
                }
            },
            async resetGame() {
                if (!confirm("ç¡®å®šé‡ç½®å¹¶æ›´æ¢äººæ•°?")) return;
                try {
                    await axios.post('/avalon/clear_game');
                    this.step = 1;
                    this.status = 'empty';
                    this.fetchLeaderboard();
                } catch (e) { }
            },
            async proposeTeam() {
                if (this.selectedTeam.length !== this.requiredTeamSize) {
                    return alert(`æœ¬è½®éœ€è¦ ${this.requiredTeamSize} äºº`);
                }
                try {
                    await axios.post('/avalon/propose_team', {
                        team: this.selectedTeam
                    });
                    this.selectedTeam = [];
                } catch (e) {
                    this.showError(e);
                }
            },
            async submitTeamVote(vote) {
                try {
                    await axios.post('/avalon/vote_team', {
                        player_name: this.myName,
                        vote
                    });
                } catch (e) {
                    this.showError(e);
                }
            },
            async voteMission(action) {
                try {
                    await axios.post('/avalon/vote_mission', {
                        player_name: this.myName,
                        action
                    });
                    this.hasActed = true;
                } catch (e) {
                    this.showError(e);
                }
            },
            async assassinate(target) {
                if (!confirm(`ç¡®å®šåˆºæ€ ${target}?`)) return;
                try {
                    await axios.post('/avalon/assassinate', {
                        target
                    });
                } catch (e) {
                    this.showError(e);
                }
            },
            async inspectPlayer(target) {
                if (!confirm(`ç¡®å®šæŸ¥éªŒ ${target}?`)) return;
                try {
                    const res = await axios.post('/avalon/lady_of_lake', {
                        target
                    });
                    this.ladyResultData = {
                        target,
                        alignment: res.data.alignment
                    };
                    this.showLadyResult = true;
                } catch (e) {
                    this.showError(e);
                }
            },
            async quickRestart() {
                if (!confirm("ç¡®å®šé‡å¼€ï¼Ÿæ‰€æœ‰ç©å®¶å°†è‡ªåŠ¨åŠ å…¥æ–°å±€")) return;
                try {
                    await axios.post('/avalon/reset_game', {
                        player_count: this.targetCount || this.playerCount,
                        lancelot_enabled: this.lancelotEnabled,
                        excalibur_enabled: this.excaliburEnabled,
                        lady_of_lake_enabled: this.ladyOfLakeEnabled
                    });
                    this.step = 1;
                } catch (e) {
                    this.showError(e);
                }
            },
            async endGame() {
                if (!confirm("ç¡®å®šç»“æŸå½“å‰æ¸¸æˆï¼Ÿ")) return;
                try {
                    await axios.post('/avalon/end_game');
                } catch (e) {
                    this.showError(e);
                }
            },
            isCurrentlyEvil() {
                if (this.currentAlignment) {
                    return this.currentAlignment === 'evil';
                }
                return this.isEvil(this.myRole);
            },
            isLancelotMustFail() {
                // å½“å‰å¤„äºé‚ªæ¶é˜µè¥çš„å…°æ–¯æ´›ç‰¹å¿…é¡»æŠ•å¤±è´¥
                if ((this.myRole === 'Lancelot Good' || this.myRole === 'Lancelot Evil') && this
                    .isCurrentlyEvil()) {
                    return true;
                }
                return false;
            },
            canAssassinate() {
                // åˆ¤æ–­å½“å‰ç©å®¶æ˜¯å¦å¯ä»¥æ‰§è¡Œåˆºæ€
                if (this.assassinRole === this.myRole) return true;
                // å…¼å®¹ï¼šåŸå§‹é€»è¾‘
                if (!this.assassinRole && this.myRole === 'Assassin') return true;
                return false;
            },
            getAssassinRoleName() {
                if (this.assassinRole) {
                    return this.roleMap[this.assassinRole] || this.assassinRole;
                }
                return 'åˆºå®¢';
            },
            async assignExcalibur(target) {
                try {
                    await axios.post('/avalon/assign_excalibur', {
                        target
                    });
                } catch (e) {
                    this.showError(e);
                }
            },
            async useExcalibur(target) {
                if (target && !confirm(`ç¡®å®šå¯¹ ${target} ä½¿ç”¨ç‹è€…ä¹‹å‰‘ï¼Ÿå°†æ›¿æ¢å…¶æŠ•ç¥¨å¹¶æŸ¥çœ‹ç»“æœ`)) return;
                try {
                    const res = await axios.post('/avalon/use_excalibur', {
                        target
                    });
                    if (res.data.excalibur_result) {
                        this.excaliburResultData = res.data.excalibur_result;
                        this.showExcaliburResult = true;
                    }
                } catch (e) {
                    this.showError(e);
                }
            },
            startPolling() {
                setInterval(async () => {
                    if (this.step === 1) {
                        try {
                            const res = await axios.get('/avalon/lobby');
                            const d = res.data;
                            this.status = d.status;
                            this.currentCount = d.current_count;
                            this.targetCount = d.target_count;
                            this.allPlayers = d.players || [];
                            if (d.status !== 'empty') {
                                this.lancelotEnabled = d.lancelot_enabled || false;
                                this.excaliburEnabled = d.excalibur_enabled || false;
                                if (d.lady_of_lake_enabled !== undefined) {
                                    this.ladyOfLakeEnabled = d.lady_of_lake_enabled;
                                }
                            }

                            const prevPlayers = d.previous_players || [];
                            if (this.myName && prevPlayers.includes(this.myName) && !d
                                .players.includes(this.myName) && d.status === 'joining') {
                                this.joinGame();
                            }

                            if (this.myName && d.players.includes(this.myName) && d
                                .status === 'active') {
                                this.step = 3;
                            }
                        } catch (e) { }
                        return;
                    }

                    if (!this.myName) return;
                    try {
                        const res = await axios.get(`/avalon/status/${this.myName}`);
                        const d = res.data;
                        this.status = d.status;

                        if (d.status === 'joining') {
                            const prevPlayers = d.last_vote_snapshot ? [] : (d
                                .previous_players || []);
                            if (this.myName && !d.players_list.includes(this.myName)) {
                                this.step = 1;
                                this.joinGame();
                            } else if (this.step > 2) {
                                this.step = 2;
                            }
                        } else if (d.status === 'active' || d.status === 'assassin') {
                            if (this.step === 2) this.step = 3;
                        } else if (d.status === 'ended') {
                            this.revealedPlayers = d.revealed_players;
                            this.gameWinner = d.game_winner;
                            this.assassinTarget = d.assassin_target;
                        } else if (d.status === 'empty') {
                            this.step = 1;
                            this.gameWinner = null;
                            this.assassinTarget = null;
                            this.revealedPlayers = [];
                        }

                        this.currentCount = d.current_count;
                        this.targetCount = d.target_count;
                        this.allPlayers = d.players_list;

                        if (d.status === 'active' || d.status === 'assassin') {
                            this.myRole = d.your_role;
                            this.visionData = d.vision || [];
                            this.missionHistory = d.mission_history || [];
                            this.voteFailCount = d.vote_fail_count;
                            this.missionActive = d.mission_active;
                            this.missionTeam = d.mission_team || [];
                            this.hasActed = d.has_acted;
                            this.voteTeamActive = d.vote_team_active;
                            this.teamVotes = d.team_votes || {};
                            this.lastVoteResult = d.last_vote_result;
                            this.lastVoteSnapshot = d.last_vote_snapshot || {};
                            this.captain = d.captain;
                            this.requiredTeamSize = d.required_team_size;

                            // æ¹–ä¸­ä»™å¥³
                            this.ladyOfLakeHolder = d.lady_of_lake_holder;
                            this.ladyOfLakeActive = d.lady_of_lake_active;
                            this.ladyOfLakeResult = d.lady_of_lake_result;
                            this.ladyOfLakeInspector = d.lady_of_lake_inspector || null;
                            this.ladyOfLakeHistory = d.lady_of_lake_history || [];

                            // å…°æ–¯æ´›ç‰¹
                            this.lancelotEnabled = d.lancelot_enabled;
                            this.lancelotSwapped = d.lancelot_swapped;
                            this.lancelotSwapReveal = d.lancelot_swap_reveal || [];
                            this.currentAlignment = d.current_alignment;

                            // åˆºæ€è§’è‰²
                            this.assassinRole = d.assassin_role;

                            // ç‹è€…ä¹‹å‰‘
                            this.excaliburEnabled = d.excalibur_enabled;
                            this.excaliburHolder = d.excalibur_holder;
                            this.excaliburPhase = d.excalibur_phase || 'none';
                            if (d.excalibur_result) {
                                this.excaliburResult = d.excalibur_result;
                            }
                        }

                    } catch (e) { }
                }, 1000);
            },
            getMissionStatusClass(i) {
                const r = this.missionHistory[i - 1];
                return r ? (r.result === 'success' ? 'success' : 'fail') : '';
            },
            isEvil(role) {
                return ['Morgana', 'Assassin', 'Mordred', 'Oberon', 'Minion', 'Lancelot Evil'].includes(
                    role);
            },
            getRoleImage(role) {
                if (!role) return '';
                const map = {
                    'Merlin': 'MERLIN.jpg',
                    'Percival': 'PERCIVAL.jpg',
                    'Loyal Servant': 'SERVANT.jpg',
                    'Morgana': 'MORGANA.jpg',
                    'Assassin': 'ASSASSIN.jpg',
                    'Mordred': 'MORDRED.jpg',
                    'Oberon': 'OBERON.jpg',
                    'Minion': 'MINION.jpg',
                    'Lancelot Good': 'LANCELOT(GOOD).png',
                    'Lancelot Evil': 'LANCELOT(EVIL).png'
                };
                return '/avalon/assets/' + (map[role] || 'SERVANT.jpg');
            },
            showError(e) {
                this.errorMsg = e.response?.data?.detail || "Error";
                setTimeout(() => this.errorMsg = '', 3000);
            },
            async fetchLeaderboard() {
                try {
                    const res = await axios.get('/avalon/leaderboard');
                    this.lbData = res.data.leaderboard || [];
                } catch (e) { }
            }
        }
    }).mount('#app');
</script>
</div>
{% endraw %}
{% endblock %}