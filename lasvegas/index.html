{% extends "base.html" %}

{% block title %}æ‹‰æ–¯ç»´åŠ æ–¯ - æ¬¢ä¹æ·éª° Â· åŒºåŸŸäº‰å¤º{% endblock %}

{% block extra_head %}
<style>
    /* ---- Page Hero (Customized gradient) ---- */
    .apple-hero h1 {
        background: linear-gradient(135deg, #00b894, #00cec9, #0984e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* ---- Section Title ---- */
    .section-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--apple-gray);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-sm);
        padding-left: 8px;
    }

    /* ---- Add Player ---- */
    .add-player-row {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .add-player-row .apple-input {
        flex: 1;
        font-size: 1.05rem;
        font-weight: 600;
    }

    .add-player-row .apple-input:focus {
        background: #fff;
        border-color: var(--apple-blue);
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
    }

    .add-player-row .apple-btn {
        box-shadow: 0 6px 16px rgba(0, 113, 227, 0.25);
        font-weight: 600;
        padding: 0 24px;
    }



    .lb-tie-badge {
        display: inline-block;
        font-size: 0.65rem;
        font-weight: 700;
        background: rgba(255, 149, 0, 0.15);
        color: var(--apple-orange);
        padding: 4px 8px;
        border-radius: var(--radius-pill);
        margin-left: 6px;
        vertical-align: middle;
    }

    /* ---- Player Cards ---- */
    .player-section {
        margin-bottom: var(--space-md);
    }

    .player-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .player-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-lg);
        cursor: pointer;
        transition: background var(--transition-fast);
        background: var(--apple-white);
    }

    .player-card-header:active {
        background: rgba(0, 0, 0, 0.05);
    }

    .player-card-left {
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .player-card-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .player-card-name {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
    }

    .player-card-summary {
        font-size: 0.85rem;
        color: var(--apple-gray);
        font-weight: 500;
        margin-top: 2px;
    }

    .player-card-chevron {
        color: var(--apple-gray);
        transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        font-size: 1rem;
    }

    .player-card-chevron.open {
        transform: rotate(90deg);
        color: var(--apple-blue);
    }

    .player-card-body {
        display: none;
        padding: 0 var(--space-lg) var(--space-lg);
        border-top: 1px solid rgba(0, 0, 0, 0.04);
        margin-top: 4px;
        padding-top: var(--space-md);
    }

    .player-card-body.open {
        display: block;
        animation: slideDown 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ---- Bill Buttons ---- */
    .bill-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .bill-btn {
        font-family: var(--font-family);
        font-size: 0.95rem;
        font-weight: 700;
        padding: 14px 6px;
        border: 1px solid var(--apple-gray-light);
        border-radius: var(--radius-md);
        background: var(--apple-white);
        color: var(--apple-black);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .bill-btn:hover {
        border-color: var(--apple-green);
        background: rgba(52, 199, 89, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(52, 199, 89, 0.2);
        color: var(--apple-green);
    }

    .bill-btn:active {
        transform: scale(0.94);
    }

    .bill-btn .bill-icon {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 4px;
    }

    /* ---- Bill List ---- */
    .bill-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--apple-bg);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        font-size: 0.95rem;
        animation: fadeSlideIn 0.3s var(--ease-apple);
    }

    @keyframes fadeSlideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .bill-value-tag {
        font-weight: 800;
        padding: 6px 16px;
        border-radius: var(--radius-pill);
        font-size: 0.95rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .bill-remove-btn {
        background: rgba(255, 59, 48, 0.1);
        border: 1.5px solid rgba(255, 59, 48, 0.2);
        border-radius: 12px;
        cursor: pointer;
        color: var(--apple-red);
        font-size: 0.85rem;
        font-weight: 600;
        font-family: var(--font-family);
        padding: 8px 16px;
        min-height: 44px;
        transition: all 0.3s var(--ease-apple);
        -webkit-tap-highlight-color: transparent;
    }

    .bill-remove-btn:hover {
        background: rgba(255, 59, 48, 0.18);
        border-color: var(--apple-red);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
    }

    .bill-remove-btn:active {
        transform: scale(0.95);
    }

    /* ---- Remove Player ---- */
    .remove-player-btn {
        font-family: var(--font-family);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--apple-red);
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--space-md) 0;
        margin-top: var(--space-sm);
        width: 100%;
        opacity: 0.8;
        transition: opacity var(--transition-fast);
        text-align: center;
    }

    .remove-player-btn:hover {
        opacity: 1;
        text-decoration: underline;
    }

    /* ---- Action Buttons Area ---- */
    .action-area {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        padding: var(--space-lg) 0;
        margin-bottom: var(--space-xl);
    }

    .action-area .apple-btn-success {
        box-shadow: 0 6px 20px rgba(52, 199, 89, 0.3);
        font-weight: 700;
        padding: 0 32px;
        border-radius: 30px;
    }

    /* ---- End Game Confirmation Overlay ---- */
    .end-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
    }

    .end-modal {
        background: var(--apple-bg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 380px;
        overflow: hidden;
    }

    .end-modal-header {
        text-align: center;
        padding: var(--space-xl) var(--space-lg) var(--space-md);
    }

    .end-modal-header h3 {
        font-size: 1.35rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 6px;
    }

    .end-modal-header p {
        font-size: 0.9rem;
        color: var(--apple-gray);
        font-weight: 500;
    }

    .end-modal-body {
        padding: 0 var(--space-lg) var(--space-lg);
    }

    .end-modal-result {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.08);
        font-size: 1rem;
    }

    .end-modal-result:last-child {
        border-bottom: none;
    }

    .end-modal-actions {
        display: flex;
        gap: var(--space-md);
        padding: 0 var(--space-lg) var(--space-xl);
    }

    .end-modal-actions .apple-btn {
        flex: 1;
        font-weight: 600;
        padding: 14px 0;
        border-radius: 20px;
        font-size: 1.05rem;
    }

    /* ---- Toast ---- */
    .toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(40, 40, 44, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 14px 28px;
        border-radius: 30px;
        font-size: 0.95rem;
        font-weight: 600;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        z-index: 9999;
        pointer-events: none;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* ---- Vue & custom animations ---- */
    .fade-enter-active,
    .fade-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .fade-enter-from,
    .fade-leave-to {
        opacity: 0;
    }

    .modal-up-enter-active,
    .modal-up-leave-active {
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .modal-up-enter-from,
    .modal-up-leave-to {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
    }

    /* Bill Color overrides */
    .bill-30 {
        background: rgba(175, 82, 222, 0.12);
        color: #7d3c98;
    }

    .bill-40 {
        background: rgba(255, 149, 0, 0.12);
        color: #cc7700;
    }

    .bill-50 {
        background: rgba(255, 59, 48, 0.12);
        color: #cc2418;
    }

    .bill-60 {
        background: rgba(90, 200, 250, 0.15);
        color: #0891b2;
    }

    .bill-70 {
        background: rgba(255, 204, 0, 0.15);
        color: #b38600;
    }

    .bill-80 {
        background: rgba(52, 199, 89, 0.12);
        color: #1a9c4a;
    }

    .bill-90 {
        background: rgba(0, 113, 227, 0.12);
        color: #0059b3;
    }

    .bill-100 {
        background: rgba(255, 59, 48, 0.08);
        color: #e11d48;
    }

    /* .apple-home-btn already defined in common.css */

    /* ---- Tile Buttons Row ---- */
    .tile-btn-row {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        padding: var(--space-lg) 0;
        margin-bottom: var(--space-lg);
    }

    .tile-action-btn {
        font-family: var(--font-family);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        border: none;
        border-radius: 30px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.35s cubic-bezier(0.25, 1, 0.5, 1);
        letter-spacing: -0.01em;
    }

    .tile-action-btn:active {
        transform: scale(0.95);
    }

    .tile-btn-setup {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white;
        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.35);
    }

    .tile-btn-setup:hover {
        box-shadow: 0 8px 28px rgba(108, 92, 231, 0.45);
        transform: translateY(-2px);
    }

    .tile-btn-info {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        box-shadow: 0 6px 20px rgba(0, 184, 148, 0.35);
    }

    .tile-btn-info:hover {
        box-shadow: 0 8px 28px rgba(0, 184, 148, 0.45);
        transform: translateY(-2px);
    }

    /* ---- Tile Modal ---- */
    .tile-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
        opacity: 0;
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .tile-modal {
        background: var(--apple-bg);
        border-radius: var(--radius-xl);
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 480px;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: scale(0.95) translateY(20px);
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .tile-modal-header {
        text-align: center;
        padding: var(--space-xl) var(--space-lg) var(--space-md);
        flex-shrink: 0;
    }

    .tile-modal-header h3 {
        font-size: 1.35rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 4px;
    }

    .tile-modal-header p {
        font-size: 0.9rem;
        color: var(--apple-gray);
        font-weight: 500;
    }

    .tile-modal-body {
        padding: 0 var(--space-lg) var(--space-md);
        overflow-y: auto;
        flex: 1;
        -webkit-overflow-scrolling: touch;
    }

    .tile-modal-body::-webkit-scrollbar {
        width: 4px;
    }

    .tile-modal-body::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 4px;
    }

    .tile-card {
        background: var(--apple-white);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.04);
        transition: all 0.3s var(--ease-apple);
    }

    .tile-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .tile-card-top {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: 10px;
    }

    .tile-casino-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 800;
        color: white;
        flex-shrink: 0;
    }

    .tile-casino-1 {
        background: linear-gradient(135deg, #e17055, #d63031);
    }

    .tile-casino-2 {
        background: linear-gradient(135deg, #fdcb6e, #f39c12);
    }

    .tile-casino-3 {
        background: linear-gradient(135deg, #00b894, #00a085);
    }

    .tile-casino-4 {
        background: linear-gradient(135deg, #0984e3, #0652DD);
    }

    .tile-casino-5 {
        background: linear-gradient(135deg, #6c5ce7, #5b4bd5);
    }

    .tile-casino-6 {
        background: linear-gradient(135deg, #e84393, #c44569);
    }

    .tile-name-block {
        flex: 1;
    }

    .tile-name {
        font-size: 1.05rem;
        font-weight: 800;
        letter-spacing: -0.01em;
        color: var(--apple-black);
    }

    .tile-id-tag {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--apple-gray);
        margin-top: 1px;
    }

    .tile-trigger {
        display: inline-block;
        padding: 4px 10px;
        border-radius: var(--radius-pill);
        background: rgba(108, 92, 231, 0.1);
        color: #6c5ce7;
        font-size: 0.75rem;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .tile-desc {
        font-size: 0.88rem;
        color: #444;
        line-height: 1.6;
        font-weight: 500;
    }

    .tile-bills-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .tile-bills-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--apple-gray);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        flex-shrink: 0;
    }

    .tile-bill-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 12px;
        border-radius: var(--radius-pill);
        font-size: 0.85rem;
        font-weight: 800;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .tile-bills-total {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--apple-blue);
        margin-left: auto;
        flex-shrink: 0;
    }

    .tile-modal-footer {
        padding: var(--space-md) var(--space-lg) var(--space-xl);
        flex-shrink: 0;
        text-align: center;
    }

    .tile-modal-close-btn {
        font-family: var(--font-family);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 12px 32px;
        border: none;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        background: var(--apple-bg);
        color: var(--apple-gray);
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: all 0.3s var(--ease-apple);
    }

    .tile-modal-close-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--apple-black);
    }

    .tile-modal-close-btn:active {
        transform: scale(0.96);
    }
</style>
{% endblock %}

{% block nav_title %}
<i class="ph-fill ph-dice-six text-green" style="margin-right: 4px;"></i> æ‹‰æ–¯ç»´åŠ æ–¯
{% endblock %}

{% block content %}
<!-- Hero -->
<div class="apple-hero">
    <span class="apple-hero-emoji">ğŸ°</span>
    <h1>æ‹‰æ–¯ç»´åŠ æ–¯</h1>
    <p>é‡‘é’±è®¡ç®— Â· å¼ æ•°å†³èƒœ</p>
</div>

<!-- Add Player -->
<div class="section-title">æ·»åŠ ç©å®¶</div>
<div class="add-player-row">
    <input id="playerNameInput" class="apple-input" type="text" placeholder="è¾“å…¥ç©å®¶åç§°" maxlength="12" autocomplete="off">
    <button class="apple-btn apple-btn-primary" onclick="addPlayer()">
        <i class="ph-bold ph-plus"></i> æ·»åŠ 
    </button>
</div>

<!-- Current Game Leaderboard -->
<div class="section-title">ğŸ’° æœ¬å±€æ’è¡Œ</div>
<div id="leaderboard">
    <div class="apple-list mb-md">
        <div class="empty-state">
            <span class="empty-icon">ğŸƒ</span>
            æ·»åŠ ç©å®¶å¼€å§‹è®¡ç®—
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-area" id="actionArea" style="display:none;">
    <button class="apple-btn apple-btn-success apple-btn-lg" onclick="showEndConfirm()">
        <i class="ph-fill ph-flag-checkered" style="margin-right:6px;"></i> ç»“æŸæœ¬å±€
    </button>
    <button class="apple-btn apple-btn-secondary" onclick="resetGame()"
        style="padding:0 24px; border-radius:30px; font-weight:600;">
        <i class="ph-bold ph-arrow-clockwise"></i> é‡ç½®
    </button>
</div>

<!-- Player Cards -->
<div class="section-title">ğŸƒ ç©å®¶é’ç¥¨</div>
<div id="playerCards" class="player-section"></div>

<!-- Historical Leaderboard -->
<div id="inline-leaderboard-section">
    <div class="section-title" style="margin-top: var(--space-xl); margin-bottom: var(--space-md);">ğŸ† å†å²æ’è¡Œæ¦œ
    </div>
    <div id="histLeaderboard">
        <div class="apple-list mb-xl">
            <div class="empty-state">
                <span class="empty-icon">ğŸ‘»</span>
                è¿˜æ²¡äººç©è¿‡å‘¢ï¼Œå¿«å»å¼€ä¸€å±€ï¼
            </div>
        </div>
    </div>
</div>

<!-- Tile Action Buttons -->
<div class="tile-btn-row">
    <button class="tile-action-btn tile-btn-setup" onclick="setupField()">
        <i class="ph-fill ph-dice-five"></i> å¸ƒç½®åœºåœ°
    </button>
    <button class="tile-action-btn tile-btn-info" onclick="showFieldInfo()">
        <i class="ph-bold ph-book-open"></i> åœºåœ°è¯´æ˜
    </button>
</div>
{% endblock %}

{% block extra_body %}
<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- End Game Overlay (hidden) -->
<div id="endOverlay" class="end-overlay"
    style="display:none; transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1); opacity: 0;"
    onclick="hideEndConfirm(event)">
    <div class="end-modal" onclick="event.stopPropagation()"
        style="transform: scale(0.95) translateY(20px); transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);">
        <div class="end-modal-header">
            <h3>ğŸ ç»“æŸæœ¬å±€</h3>
            <p>ä»¥ä¸‹ç»“æœå°†è®°å½•åˆ°æ’è¡Œæ¦œ</p>
        </div>
        <div class="end-modal-body" id="endModalBody"></div>
        <div class="end-modal-actions">
            <button class="apple-btn apple-btn-secondary" onclick="hideEndConfirm()">å–æ¶ˆ</button>
            <button class="apple-btn apple-btn-success" onclick="confirmEndGame()">
                <i class="ph-bold ph-check"></i> ç¡®è®¤ç»“æŸ
            </button>
        </div>
    </div>
</div>

<!-- Setup Field Modal -->
<div id="setupOverlay" class="tile-overlay" style="display:none;" onclick="closeTileModal('setupOverlay', event)">
    <div class="tile-modal" onclick="event.stopPropagation()">
        <div class="tile-modal-header">
            <h3>ğŸ² åœºåœ°å¸ƒç½®ç»“æœ</h3>
            <p>æ¯ä¸ªèµŒåœºå·²éšæœºåˆ†é…ä¸€å—æ‹“å±•æ¿å—</p>
        </div>
        <div class="tile-modal-body" id="setupModalBody"></div>
        <div class="tile-modal-footer">
            <button class="tile-modal-close-btn" onclick="closeTileModal('setupOverlay')">
                <i class="ph-bold ph-x"></i> å…³é—­
            </button>
        </div>
    </div>
</div>

<!-- Field Info Modal -->
<div id="infoOverlay" class="tile-overlay" style="display:none;" onclick="closeTileModal('infoOverlay', event)">
    <div class="tile-modal" onclick="event.stopPropagation()">
        <div class="tile-modal-header">
            <h3>ğŸ“– åœºåœ°è¯´æ˜</h3>
            <p>å½“å‰å„èµŒåœºæ‹“å±•æ¿å—çš„è¯¦ç»†è§„åˆ™</p>
        </div>
        <div class="tile-modal-body" id="infoModalBody"></div>
        <div class="tile-modal-footer">
            <button class="tile-modal-close-btn" onclick="closeTileModal('infoOverlay')">
                <i class="ph-bold ph-x"></i> å…³é—­
            </button>
        </div>
    </div>
</div>

<script>
    const BASE = '/lasvegas';
    const DENOMINATIONS = [30, 40, 50, 60, 70, 80, 90, 100];
    const AVATAR_COLORS = [
        '#0984e3', '#00b894', '#e17055', '#6c5ce7',
        '#fdcb6e', '#e84393', '#00cec9', '#d63031',
        '#a29bfe', '#55a3e8'
    ];

    let expandedPlayers = new Set();
    let currentPlayers = []; // cache for end game modal
    let currentSetup = null; // current tile assignment: [{casino, tile}, ...]

    // ---- Tile Data ----
    const TILES = [{
        id: 'A1',
        name: 'Lucky Punch',
        group: 'A',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'ç©å®¶åœ¨æ¡Œä¸‹æ‰‹é‡Œæš—è— 1~3 ä¸ªæŒ‡ç¤ºç‰©ï¼Œç”±å·¦æ‰‹è¾¹ç©å®¶çŒœæ•°é‡ã€‚çŒœé”™ï¼Œå¯åŠ¨ç©å®¶è·å¾—é¢æ¿å¯¹åº”å¥–åŠ±ï¼ˆåœ†ç‰‡æˆ–ç°é‡‘ï¼‰ï¼›çŒœå¯¹ï¼Œæ— äº‹å‘ç”Ÿã€‚'
    },
    {
        id: 'A2',
        name: 'Jackpot',
        group: 'A',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'æ· 2 é¢—é»‘éª°å­ã€‚è‹¥æ€»å’Œä¸º 7 æˆ–æ·å‡ºè±¹å­ï¼ˆåŒç‚¹æ•°ï¼‰ï¼Œç›´æ¥æ‹¿èµ°å¤§å¥–æŒ‡ç¤ºç‰©å½“å‰ç›–ä½çš„å¥–é‡‘ï¼Œå¹¶å°†æŒ‡ç¤ºç‰©é‡ç½®å› $30,000ï¼›è‹¥æœªè¾¾æˆï¼Œå°†å¤§å¥–æŒ‡ç¤ºç‰©å‘å³æ¨ç§» 1 æ ¼ï¼ˆå¥–é‡‘å˜åšï¼‰ã€‚'
    },
    {
        id: 'B1',
        name: 'Prime-Time',
        group: 'B',
        trigger: 'é¢å‘å¥–é‡‘å‰',
        desc: 'è¯¥èµŒåœºæœ€å¤§èµ¢å®¶å¯æ· 2 é¢—é»‘éª°å­ï¼Œå¹¶å°† 0~2 é¢—é»‘éª°åˆ†é…åˆ°å¯¹åº”èµŒåœºã€‚åœ¨éšåçš„ç»“ç®—ä¸­ï¼Œè¿™äº›é»‘éª°è§†ä¸ºè¯¥èµ¢å®¶çš„æœ‰æ•ˆæˆ˜åŠ›ã€‚'
    },
    {
        id: 'B2',
        name: 'Fifty-Fifty',
        group: 'B',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'æ· 2 é¢—é»‘éª°å¹¶æ¨è¿›å¥–åŠ±æ ‡è®°ã€‚ç©å®¶å¯éšæ—¶è§å¥½å°±æ”¶æ‹¿èµ°å½“å‰å¥–é‡‘ï¼›è‹¥ç»§ç»­æŒ‘æˆ˜ï¼Œå¿…é¡»ç›²çŒœä¸‹ä¸€æ¬¡æ·éª°ç»“æœæ¯”è¿™æ¬¡é«˜æˆ–ä½ã€‚çŒœå¯¹å¯ç»§ç»­æˆ–æ‹¿å¥–é‡‘ï¼›çŒœé”™ï¼ˆæˆ–å¹³å±€ï¼‰ï¼Œç›´æ¥è¾“æ‰æŒ‘æˆ˜ï¼Œé¢—ç²’æ— æ”¶ã€‚'
    },
    {
        id: 'C1',
        name: 'High-Five',
        group: 'C',
        trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶',
        desc: 'å½“ä½ åœ¨æ­¤èµŒåœºæ”¾æ»¡ç¬¬ 5 ä¸ªéª°å­ï¼ˆå¤§éª°å­ç®— 2 ä¸ªï¼‰æ—¶ï¼Œæ‹¿å–"å‡»æŒæ ‡è®°"ã€‚ç»“ç®—æ—¶å¯ç›´æ¥å…‘æ¢æˆé’ç¥¨ã€‚'
    },
    {
        id: 'C2',
        name: 'Bad-Luck',
        group: 'C',
        trigger: 'é¢å‘å¥–é‡‘å‰',
        desc: 'åœ¨æ­¤èµŒåœºæ”¾ç½®éª°å­æœ€å°‘ï¼ˆåŒ…æ‹¬ 0 ä¸ªï¼‰çš„ç©å®¶ï¼Œæœ¬è½®ç»“æŸæ—¶å¿…é¡»å‘é“¶è¡Œå€’æ‰£ $50,000ï¼ˆå¯ç”¨åœ†ç‰‡æŠµæ‰£ï¼Œé’±ä¸å¤Ÿåˆ™å…¨æ‰£å…‰ï¼‰ã€‚'
    },
    {
        id: 'D1',
        name: 'Pay-Day',
        group: 'D',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'è®¡ç®—åœºä¸Šå…¨ç›˜æœ‰ä½ éª°å­çš„èµŒåœºæ•°é‡ï¼Œæ•°é‡ x $10,000 å³ä¸ºä½ çš„æ”¶ç›Šï¼ˆ$1ä¸‡~$2ä¸‡å‘åœ†ç‰‡ï¼Œ$3ä¸‡~$6ä¸‡å‘é’ç¥¨ï¼‰ã€‚'
    },
    {
        id: 'D2',
        name: 'Power-Play',
        group: 'D',
        trigger: 'å¯åŠ¨æ¿å—æ—¶ / ä¸‹å›åˆå¼€å§‹å‰',
        desc: 'æ”¾éª°å­åè‹¥ä½ åœ¨æ­¤å¤„éª°å­æ•°å…¨åœºæœ€å¤šï¼Œå¤ºå¾—ç‰¹æƒæ ‡è®°ã€‚è‹¥æŠŠæ ‡è®°ä¿æŒåˆ°ä½ çš„ä¸‹ä¸ªå›åˆï¼Œä½ å¯ä»¥ä¸æ·éª°å­ï¼Œç›´æ¥å°†æ‰‹é‡Œ 1 é¢—éª°å­è½¬åˆ°ä»»æ„ç‚¹æ•°æ”¾è¿›å¯¹åº”èµŒåœºã€‚å¤±å»æ•°é‡ä¼˜åŠ¿åˆ™éœ€äº¤è¿˜æ ‡è®°ã€‚'
    },
    {
        id: 'E1',
        name: 'No-Entry!',
        group: 'E',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'å°†"ç¦æ­¢è¿›å…¥"æ ‡è®°æ”¾åˆ°å…¶ä»–ä»»æ„èµŒåœºï¼Œå½»åº•å°æ­»è¯¥åŒºåŸŸï¼ˆä¸èƒ½è¿›å‡ºéª°å­ï¼Œæ¿å—å¤±æ•ˆï¼‰ã€‚åŒæ—¶ä½ åœ¨æœ¬æ¿å—çš„å¥–åŠ±è¿›åº¦æ¡å‰è¿›å¹¶æ‹¿å¥–ã€‚åç»­å¯åŠ¨æ­¤æ¿å—çš„ç©å®¶å¯é€‰æ‹©æ˜¯å¦è½¬ç§»è¯¥å°é”æ ‡è®°ã€‚'
    },
    {
        id: 'E2',
        name: 'Knockout',
        group: 'E',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'æ‰€æœ‰äººå¿…é¡»å¾€æ­¤æ¿å—æ”¾ 1 é¢—å‰©éª°ï¼ˆæœ€å¤šæ”¾ 2 é¢—ï¼Œå¤§éª°ç®— 1 é¢—ï¼Œæ­¤æ¿å—ä¸å‚ä¸åˆ†é’±ï¼‰ã€‚éšåï¼Œä½ å¯ä»¥æŠŠè¢«åˆ«äººå¼ºåˆ¶å¡åˆ°è¿™é‡Œçš„è‡ªå·±çš„éª°å­æ‹¿å›æ¥ã€‚'
    },
    {
        id: 'F1',
        name: 'Block-It!',
        group: 'F',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'æ‹¿å–æ¿å—ä¸Šé¢„è®¾çš„ä¸€ç»„ç°éª°å­ï¼ˆå……å½“ä¸­ç«‹ç©å®¶ï¼‰ï¼Œç©ºé™åˆ°ä»»æ„èµŒåœºå»ç ´ååˆ«äººçš„æ•°é‡ä¼˜åŠ¿ï¼ˆåˆ¶é€ å¹³å±€ï¼‰ã€‚'
    },
    {
        id: 'F2',
        name: 'Handicap',
        group: 'F',
        trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶',
        desc: 'æ¸¸æˆåˆå§‹å„èµŒåœºæœ‰ç°éª°ï¼ˆä¸­ç«‹åŠ¿åŠ›ï¼‰ã€‚å¯åŠ¨æ—¶ï¼Œä½ å¯ä»¥ä»ä»»æ„èµŒåœºæ‹¿ 1 é¢—ç°éª°æ”¾åˆ°æœ¬æ¿å—çš„åœ†åœˆå†…ï¼Œæ¢å–å¯¹åº”å¥–åŠ±ï¼ˆåœ†ç‰‡ã€é’±ã€æˆ–æ”¹ç‚¹æ•°æ”¾éª°/æ”¶å›éª°å­ï¼‰ã€‚ç•™åœ¨èµŒåœºçš„ç°éª°ç»“ç®—æ—¶ä¾ç„¶ä¼šé˜»ç¢ç©å®¶æ‹¿é’±ã€‚'
    },
    {
        id: 'G1',
        name: 'Black-Box',
        group: 'G',
        trigger: 'é¢å‘å¥–é‡‘æ—¶',
        desc: 'è¯¥èµŒåœºæœ€å¤§èµ¢å®¶çš„å·¦æ‰‹è¾¹ç©å®¶ï¼Œå°† 6 ä¸ªé¢æœä¸Šçš„å¥–åŠ±æ ‡è®°æš—ä¸­åˆ†ä¸ºä¸¤å †ã€‚æœ€å¤§èµ¢å®¶ç›²é€‰å…¶ä¸­ä¸€å †æ‹¿èµ°å¥–åŠ±ï¼ˆå……æ»¡å¿ƒç†åšå¼ˆçš„"ä½ åˆ†æˆ‘é€‰"ï¼‰ã€‚'
    },
    {
        id: 'G2',
        name: 'Double-Down',
        group: 'G',
        trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶',
        desc: 'å¯åŠ¨æ—¶ï¼Œå¯å°†è‡ªå·±åœ¨æ­¤èµŒåœºçš„éª°å­ç§»åˆ°æœ¬æ¿å—ä¸Šã€‚ç»“ç®—æ—¶ï¼Œæœ¬æ¿å—å¦‚åŒä¸€ä¸ªç‹¬ç«‹çš„å°èµŒåœºå•ç‹¬å‘é’±ï¼ˆç¬¬ä¸€å 6 ä¸‡ï¼Œç¬¬äºŒå 3 ä¸‡ï¼‰ï¼Œä¸”ä¸å—å…¶ä»–è¡ŒåŠ¨å¹²æ‰°ã€‚'
    },
    {
        id: 'H1',
        name: 'Nice-Dice',
        group: 'H',
        trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶',
        desc: 'å°†åˆšæ·å‡ºæˆ–æ”¾å…¥çš„éª°å­æŒ‰ç‚¹æ•°æ”¾è¿›æœ¬æ¿å—æ ¼å­ã€‚å¦‚æœæ ¼å­é‡Œæœ‰åˆ«äººçš„éª°å­ï¼Œç›´æ¥æŠŠä»–"æŒ¤"å›å¯¹åº”ç‚¹æ•°çš„æ™®é€šèµŒåœºå»ã€‚ç»“ç®—æ—¶ï¼Œç•™åœ¨æ ¼å­é‡Œçš„éª°å­ä¸»äººæ‹¿å¯¹åº”å¥–åŠ±ã€‚'
    },
    {
        id: 'H2',
        name: 'My-Choice',
        group: 'H',
        trigger: 'å¯åŠ¨æ¿å—æ—¶',
        desc: 'æ· 2 é¢—é»‘éª°ï¼Œé€‰ 1 ä¸ªç»“æœæ‰§è¡ŒåŠ¨ä½œï¼šæ‹¿ç­¹ç ã€æ‹¿é’±ã€ç™½å«–ä¸€æ¬¡å…¶ä»–æ¿å—èƒ½åŠ›ã€æ”¹ 1 é¢—éª°å­ç‚¹æ•°æ”¾å›åœºä¸Š/æ”¶å›æ‰‹é‡Œï¼Œæˆ–è€…æŠŠéª°å­æ”¾è¿›"é‡‘æ¡†"ï¼ˆä¼šæŠŠåˆ«äººçš„æŒ¤å‡ºå»ï¼‰ï¼Œç»“ç®—æ—¶ç‹¬èµ¢ 6 ä¸‡ã€‚'
    },
    ];

    const GROUPS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

    // ---- Bill Pool ----
    const BILL_POOL = {
        30: 11,
        40: 11,
        50: 13,
        60: 15,
        70: 13,
        80: 11,
        90: 9,
        100: 7
    };

    function getRemainingPool(players) {
        // Clone the full pool
        const remaining = {
            ...BILL_POOL
        };
        // Subtract bills held by all players
        players.forEach(p => {
            if (p.bills) {
                p.bills.forEach(b => {
                    if (remaining[b.value] !== undefined) {
                        remaining[b.value] = Math.max(0, remaining[b.value] - 1);
                    }
                });
            }
        });
        return remaining;
    }

    function drawBillFromPool(pool) {
        // Weighted random draw: each denomination's weight = remaining count
        const entries = Object.entries(pool)
            .filter(([, count]) => count > 0)
            .map(([val, count]) => ({
                value: parseInt(val),
                count
            }));
        if (!entries.length) return null;

        const totalWeight = entries.reduce((s, e) => s + e.count, 0);
        let r = Math.random() * totalWeight;
        for (const e of entries) {
            r -= e.count;
            if (r <= 0) {
                pool[e.value]--;
                return e.value;
            }
        }
        // Fallback
        const last = entries[entries.length - 1];
        pool[last.value]--;
        return last.value;
    }

    function distributeBills(players) {
        const pool = getRemainingPool(players);
        const pairs = [];
        for (let i = 0; i < 6; i++) {
            const b1 = drawBillFromPool(pool);
            const b2 = drawBillFromPool(pool);
            const bills = [b1, b2].filter(v => v !== null).sort((a, b) => b - a);
            pairs.push(bills);
        }
        // Sort pairs: highest total first; tie â†’ highest single bill first
        pairs.sort((a, b) => {
            const totalA = a.reduce((s, v) => s + v, 0);
            const totalB = b.reduce((s, v) => s + v, 0);
            if (totalB !== totalA) return totalB - totalA;
            return (b[0] || 0) - (a[0] || 0);
        });
        // Assign: highest total â†’ casino 6, next â†’ 5, ... lowest â†’ 1
        const result = new Array(6);
        for (let i = 0; i < pairs.length; i++) {
            result[5 - i] = pairs[i]; // pairs[0] (highest) â†’ index 5 (casino 6)
        }
        return result;
    }

    // ---- Tile Setup Logic ----
    async function setupField() {
        // Fetch current player data to compute remaining bill pool
        const statusData = await apiGet('/api/status');
        const players = statusData.players || [];

        // Step 1: From each group pick 1 tile randomly -> 8 candidates
        const candidates = GROUPS.map(g => {
            const groupTiles = TILES.filter(t => t.group === g);
            return groupTiles[Math.floor(Math.random() * groupTiles.length)];
        });
        // Step 2: Shuffle and pick 6
        const shuffled = [...candidates].sort(() => Math.random() - 0.5);
        const chosen = shuffled.slice(0, 6);

        // Step 3: Draw & sort bills for each casino (highest total â†’ casino 6)
        const casinoBills = distributeBills(players);

        // Step 4: Assign to casinos 1-6
        currentSetup = chosen.map((tile, i) => ({
            casino: i + 1,
            tile,
            bills: casinoBills[i]
        }));

        // Render setup modal
        renderSetupModal();
        openTileModal('setupOverlay');
    }

    function renderBillTags(bills) {
        if (!bills || !bills.length) return '';
        const tags = bills.map(v =>
            `<span class="tile-bill-tag bill-${v}">$${v}k</span>`
        ).join('');
        const total = bills.reduce((s, v) => s + v, 0);
        return `<div class="tile-bills-row">
                <span class="tile-bills-label">å¥–é‡‘</span>
                ${tags}
                <span class="tile-bills-total">åˆè®¡ ${total}ä¸‡</span>
            </div>`;
    }

    function renderSetupModal() {
        const body = document.getElementById('setupModalBody');
        let html = '';
        currentSetup.forEach(({
            casino,
            tile,
            bills
        }) => {
            html += `<div class="tile-card">
                    <div class="tile-card-top">
                        <div class="tile-casino-badge tile-casino-${casino}">${casino}</div>
                        <div class="tile-name-block">
                            <div class="tile-name">${escHtml(tile.name)}</div>
                            <div class="tile-id-tag">${tile.id} Â· ${tile.group}ç»„</div>
                        </div>
                    </div>
                    <div class="tile-trigger">${escHtml(tile.trigger)}</div>
                    ${renderBillTags(bills)}
                </div>`;
        });
        body.innerHTML = html;
    }

    function showFieldInfo() {
        if (!currentSetup) {
            showToast('è¯·å…ˆå¸ƒç½®åœºåœ°');
            return;
        }
        const body = document.getElementById('infoModalBody');
        let html = '';
        currentSetup.forEach(({
            casino,
            tile,
            bills
        }) => {
            html += `<div class="tile-card">
                    <div class="tile-card-top">
                        <div class="tile-casino-badge tile-casino-${casino}">${casino}</div>
                        <div class="tile-name-block">
                            <div class="tile-name">${escHtml(tile.name)}</div>
                            <div class="tile-id-tag">${tile.id} Â· ${tile.group}ç»„</div>
                        </div>
                    </div>
                    <div class="tile-trigger">${escHtml(tile.trigger)}</div>
                    <div class="tile-desc">${escHtml(tile.desc)}</div>
                    ${renderBillTags(bills)}
                </div>`;
        });
        body.innerHTML = html;
        openTileModal('infoOverlay');
    }

    function openTileModal(id) {
        const overlay = document.getElementById(id);
        const modal = overlay.querySelector('.tile-modal');
        overlay.style.display = 'flex';
        void overlay.offsetWidth; // trigger reflow
        overlay.style.opacity = '1';
        modal.style.transform = 'scale(1) translateY(0)';
    }

    function closeTileModal(id, e) {
        if (e && e.target !== e.currentTarget) return;
        const overlay = document.getElementById(id);
        const modal = overlay.querySelector('.tile-modal');
        overlay.style.opacity = '0';
        modal.style.transform = 'scale(0.95) translateY(20px)';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 400);
    }

    // ---- API helpers ----
    async function apiPost(path, body = {}) {
        const res = await fetch(BASE + path, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        return res.json();
    }
    async function apiGet(path) {
        const res = await fetch(BASE + path);
        return res.json();
    }

    // ---- Toast ----
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 1800);
    }

    // ---- Player Management ----
    async function addPlayer() {
        const input = document.getElementById('playerNameInput');
        const name = input.value.trim();
        if (!name) return;
        const res = await apiPost('/api/add_player', {
            name
        });
        if (res.status === 'exists') {
            showToast('ç©å®¶å·²å­˜åœ¨');
            return;
        }
        input.value = '';
        expandedPlayers.add(name);
        showToast(`${name} å·²åŠ å…¥`);
        refresh();
    }

    async function removePlayer(name) {
        if (!confirm(`ç¡®å®šç§»é™¤ ${name}ï¼Ÿ`)) return;
        await apiPost('/api/remove_player', {
            name
        });
        expandedPlayers.delete(name);
        showToast(`${name} å·²ç§»é™¤`);
        refresh();
    }

    // ---- Bill Management ----
    async function addBill(playerName, value) {
        const pool = getRemainingPool(currentPlayers);
        if (pool[value] > 0) {
            await apiPost('/api/add_bill', {
                player_name: playerName,
                value
            });
            refresh();
            return;
        }

        const player = currentPlayers.find(p => p.name === playerName);
        if (!player) return;

        const playerBills = player.bills || [];
        const uniquePlayerValues = [...new Set(playerBills.map(b => b.value))].sort((a, b) => a - b);

        // Strategy A: Give larger bill from pool, take smaller bill from player
        for (const v_have of uniquePlayerValues) {
            const v_new = value + v_have;
            if (pool[v_new] > 0) {
                const billToRemove = playerBills.find(b => b.value === v_have);
                await apiPost('/api/remove_bill', {
                    player_name: playerName,
                    bill_id: billToRemove.id
                });
                await apiPost('/api/add_bill', {
                    player_name: playerName,
                    value: v_new
                });
                showToast(`${value}ä¸‡å·²ç”¨å®Œï¼Œç»™ ${v_new}ä¸‡æ‰¾é›¶ ${v_have}ä¸‡`);
                refresh();
                return;
            }
        }

        // Strategy B: Give two smaller bills from pool
        const availablePoolValues = Object.keys(pool).map(Number).filter(v => pool[v] > 0).sort((a, b) => a -
            b);
        for (const v1 of availablePoolValues) {
            const v2 = value - v1;
            if (pool[v2] > 0) {
                if (v1 === v2 && pool[v1] < 2) continue;
                await apiPost('/api/add_bill', {
                    player_name: playerName,
                    value: v1
                });
                await apiPost('/api/add_bill', {
                    player_name: playerName,
                    value: v2
                });
                showToast(`${value}ä¸‡å·²ç”¨å®Œï¼Œæ‹†åˆ†ä¸º ${v1}ä¸‡å’Œ ${v2}ä¸‡`);
                refresh();
                return;
            }
        }

        showToast(`âš ï¸ ${value}ä¸‡å·²è¢«ç”¨å®Œï¼Œä¸”æ— æ³•æ‰¾é›¶ï¼`);
    }
    async function removeBill(playerName, billId) {
        await apiPost('/api/remove_bill', {
            player_name: playerName,
            bill_id: billId
        });
        refresh();
    }

    // ---- End Game ----
    function showEndConfirm() {
        if (!currentPlayers.length) return;
        const body = document.getElementById('endModalBody');
        let html = '';
        currentPlayers.forEach((p, i) => {
            html += `<div class="end-modal-result">
            <span style="font-weight:600">${i + 1}. ${escHtml(p.name)}</span>
            <span style="font-weight:800;color:var(--apple-green)">${p.total_amount}ä¸‡ <span style="font-weight:600; font-size: 0.85rem; color: var(--apple-gray)">Â· ${p.bill_count}å¼ </span></span>
        </div>`;
        });
        body.innerHTML = html;
        const overlay = document.getElementById('endOverlay');
        const modal = overlay.querySelector('.end-modal');
        overlay.style.display = 'flex';
        // Trigger reflow for animation
        void overlay.offsetWidth;
        overlay.style.opacity = '1';
        modal.style.transform = 'scale(1) translateY(0)';
    }

    function hideEndConfirm(e) {
        if (e && e.target !== e.currentTarget) return;
        const overlay = document.getElementById('endOverlay');
        const modal = overlay.querySelector('.end-modal');
        overlay.style.opacity = '0';
        modal.style.transform = 'scale(0.95) translateY(20px)';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 400); // Wait for transition
    }

    async function confirmEndGame() {
        hideEndConfirm();
        const res = await apiPost('/api/end_game');
        if (res.status === 'error') {
            showToast(res.msg || 'æ— æ³•ç»“æŸ');
            return;
        }
        expandedPlayers.clear();
        showToast('ğŸ æœ¬å±€å·²ç»“æŸï¼Œç»“æœå·²è®°å½•ï¼');
        refresh();
    }

    // ---- Reset ----
    async function resetGame() {
        if (!confirm('ç¡®å®šé‡ç½®ï¼Ÿå½“å‰æ•°æ®å°†æ¸…é™¤ï¼ˆä¸å½±å“å†å²è®°å½•ï¼‰ã€‚')) return;
        await apiPost('/api/reset');
        expandedPlayers.clear();
        showToast('æ¸¸æˆå·²é‡ç½®');
        refresh();
    }

    // ---- Render ----
    function getAvatarColor(i) {
        return AVATAR_COLORS[i % AVATAR_COLORS.length];
    }

    function getBillColorClass(v) {
        return `bill-${v}`;
    }

    function renderLeaderboard(players) {
        const container = document.getElementById('leaderboard');
        const actionArea = document.getElementById('actionArea');
        if (!players.length) {
            container.innerHTML = `
                <div class="apple-list mb-md">
                    <div class="empty-state">
                        <span class="empty-icon">ğŸƒ</span>
                        æ·»åŠ ç©å®¶å¼€å§‹è®¡ç®—
                    </div>
                </div>`;
            actionArea.style.display = 'none';
            return;
        }
        actionArea.style.display = 'flex';

        const amountGroups = {};
        players.forEach(p => {
            if (!amountGroups[p.total_amount]) amountGroups[p.total_amount] = [];
            amountGroups[p.total_amount].push(p.name);
        });

        let html = '<div class="apple-list mb-md">';
        players.forEach((p, i) => {
            const rank = i + 1;
            let rankClass = (rank === 1 && p.total_amount > 0) ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : 'rank-other'));
            let rankIcon = (rank === 1 && p.total_amount > 0) ? 'ğŸ‘‘' : rank;
            const isTied = amountGroups[p.total_amount].length > 1 && p.total_amount > 0;

            html += `<div class="apple-list-item">
                <div class="rank-num ${rankClass}">${rankIcon}</div>
                <div class="apple-list-item-content">
                    <div class="apple-list-item-title">${escHtml(p.name)}${isTied ? '<span class="lb-tie-badge">å¹³å±€</span>' : ''}</div>
                </div>
                <div style="text-align: right; display: flex; align-items: center; gap: 16px;">
                    <div style="text-align: right; width: 40px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">å¼ æ•°</div>
                        <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">${p.bill_count}å¼ </div>
                    </div>
                    <div style="text-align: right; width: 60px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">é‡‘é¢</div>
                        <div class="score-badge" style="font-size: 1.2rem; color: var(--apple-green);">${p.total_amount}ä¸‡</div>
                    </div>
                </div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function renderPlayerCards(players) {
        const container = document.getElementById('playerCards');
        if (!players.length) {
            container.innerHTML = '';
            return;
        }

        let html = '';
        players.forEach((p, idx) => {
            const color = getAvatarColor(idx);
            const isOpen = expandedPlayers.has(p.name);
            const initial = p.name.charAt(0).toUpperCase();

            let billBtnsHtml = DENOMINATIONS.map(v =>
                `<button class="bill-btn" onclick="addBill('${escAttr(p.name)}', ${v})">
                <span class="bill-icon">ğŸ’µ</span>${v}ä¸‡
            </button>`
            ).join('');

            let billListHtml = '';
            if (p.bills && p.bills.length) {
                billListHtml = p.bills.map(b =>
                    `<div class="bill-item">
                    <span class="bill-value-tag ${getBillColorClass(b.value)}">${b.value}ä¸‡</span>
                    <button class="bill-remove-btn" onclick="removeBill('${escAttr(p.name)}', '${b.id}')">
                        <i class="ph-bold ph-x"></i> ç§»é™¤
                    </button>
                </div>`
                ).join('');
            } else {
                billListHtml =
                    '<div style="text-align:center;color:var(--apple-gray);font-size:0.9rem;font-weight:500;padding:var(--space-md) 0;">æš‚æ— é’ç¥¨</div>';
            }

            html += `<div class="player-card">
            <div class="player-card-header" onclick="togglePlayer('${escAttr(p.name)}')">
                <div class="player-card-left">
                    <div class="player-card-avatar" style="background:${color}">${initial}</div>
                    <div>
                        <div class="player-card-name">${escHtml(p.name)}</div>
                        <div class="player-card-summary">${p.total_amount}ä¸‡ Â· ${p.bill_count}å¼ é’ç¥¨</div>
                    </div>
                </div>
                <i class="ph-bold ph-caret-right player-card-chevron ${isOpen ? 'open' : ''}"></i>
            </div>
            <div class="player-card-body ${isOpen ? 'open' : ''}">
                <div class="section-title" style="margin-top:var(--space-xs)">æ·»åŠ é’ç¥¨</div>
                <div class="bill-grid">${billBtnsHtml}</div>
                <div class="section-title">é’ç¥¨æ˜ç»†</div>
                <div class="bill-list">${billListHtml}</div>
                <button class="remove-player-btn" onclick="removePlayer('${escAttr(p.name)}')">
                    <i class="ph-bold ph-trash" style="margin-right: 4px;"></i>ç§»é™¤æ­¤ç©å®¶
                </button>
            </div>
        </div>`;
        });
        container.innerHTML = html;
    }

    function renderHistLeaderboard(lb) {
        const container = document.getElementById('histLeaderboard');
        if (!lb.length) {
            container.innerHTML = `
                    <div class="apple-list mb-xl">
                        <div class="empty-state">
                            <span class="empty-icon">ğŸ‘»</span>
                            è¿˜æ²¡äººç©è¿‡å‘¢ï¼Œå¿«å»å¼€ä¸€å±€ï¼
                        </div>
                    </div>`;
            return;
        }

        let html = '<div class="apple-list mb-xl">';
        lb.forEach((p, i) => {
            const rank = i + 1;
            let rankClass = (rank === 1 && p.total_amount > 0) ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : 'rank-other'));
            let rankIcon = (rank === 1 && p.total_amount > 0) ? 'ğŸ‘‘' : rank;

            const lastAmtStr = p.last_game_amount > 0 ? `+${p.last_game_amount}ä¸‡` : '--';
            const avgAmtStr = p.avg_amount > 0 ? `${p.avg_amount}ä¸‡` : '--';

            html += `<div class="apple-list-item">
                <div class="rank-num ${rankClass}">${rankIcon}</div>
                <div class="apple-list-item-content">
                    <div class="apple-list-item-title">${escHtml(p.name)}</div>
                </div>
                <div style="text-align: right; display: flex; align-items: center; gap: 16px;">
                    <div style="text-align: right; width: 60px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">æ€»è®¡</div>
                        <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">${p.total_amount}ä¸‡</div>
                    </div>
                    <div style="text-align: right; width: 60px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">åœºå‡</div>
                        <div class="score-badge" style="font-size: 1.2rem; color: var(--apple-green);">${avgAmtStr}</div>
                    </div>
                    <div style="text-align: right; width: 60px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">ä¸Šåœº</div>
                        <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);">${lastAmtStr}</div>
                    </div>
                </div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function togglePlayer(name) {
        if (expandedPlayers.has(name)) expandedPlayers.delete(name);
        else expandedPlayers.add(name);
        refresh();
    }

    // ---- Helpers ----
    function escHtml(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function escAttr(s) {
        return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    // ---- Refresh ----
    async function refresh() {
        const [statusData, lbData] = await Promise.all([
            apiGet('/api/status'),
            apiGet('/api/leaderboard')
        ]);
        currentPlayers = statusData.ranked;
        renderLeaderboard(statusData.ranked);
        renderPlayerCards(statusData.players);
        renderHistLeaderboard(lbData.leaderboard);
    }

    // ---- Init ----
    document.getElementById('playerNameInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') addPlayer();
    });
    refresh();
</script>
</script>
{% endblock %}