{% extends "base.html" %}

{% block title %}æ‹‰æ–¯ç»´åŠ æ–¯ - æ¬¢ä¹æ·éª° Â· åŒºåŸŸäº‰å¤º{% endblock %}

{% block extra_head %}
<style>
    [x-cloak] { display: none !important; }

    /* ---- Page Hero (Customized gradient) ---- */
    .apple-hero h1 {
        background: linear-gradient(135deg, #00b894, #00cec9, #0984e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* ---- Section Title ---- */
    .section-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--apple-gray);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-sm);
        padding-left: 8px;
    }

    /* ---- Add Player ---- */
    .add-player-row {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .add-player-row .apple-input {
        flex: 1;
        font-size: 1.05rem;
        font-weight: 600;
    }

    .add-player-row .apple-input:focus {
        background: #fff;
        border-color: var(--apple-blue);
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
    }

    .add-player-row .apple-btn {
        box-shadow: 0 6px 16px rgba(0, 113, 227, 0.25);
        font-weight: 600;
        padding: 0 24px;
    }

    .lb-tie-badge {
        display: inline-block;
        font-size: 0.65rem;
        font-weight: 700;
        background: rgba(255, 149, 0, 0.15);
        color: var(--apple-orange);
        padding: 4px 8px;
        border-radius: var(--radius-pill);
        margin-left: 6px;
        vertical-align: middle;
    }

    /* ---- Player Cards ---- */
    .player-section {
        margin-bottom: var(--space-md);
    }

    .player-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .player-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-lg);
        cursor: pointer;
        transition: background var(--transition-fast);
        background: var(--apple-white);
    }

    .player-card-header:active {
        background: rgba(0, 0, 0, 0.05);
    }

    .player-card-left {
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .player-card-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .player-card-name {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
    }

    .player-card-summary {
        font-size: 0.85rem;
        color: var(--apple-gray);
        font-weight: 500;
        margin-top: 2px;
    }

    .player-card-chevron {
        color: var(--apple-gray);
        transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        font-size: 1rem;
    }

    .player-card-chevron.open {
        transform: rotate(90deg);
        color: var(--apple-blue);
    }

    .player-card-body {
        display: none;
        padding: 0 var(--space-lg) var(--space-lg);
        border-top: 1px solid rgba(0, 0, 0, 0.04);
        margin-top: 4px;
        padding-top: var(--space-md);
    }

    .player-card-body.open {
        display: block;
        animation: slideDown 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ---- Bill Buttons ---- */
    .bill-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
    }

    .bill-btn {
        font-family: var(--font-family);
        font-size: 0.95rem;
        font-weight: 700;
        padding: 14px 6px;
        border: 1px solid var(--apple-gray-light);
        border-radius: var(--radius-md);
        background: var(--apple-white);
        color: var(--apple-black);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .bill-btn:hover {
        border-color: var(--apple-green);
        background: rgba(52, 199, 89, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(52, 199, 89, 0.2);
        color: var(--apple-green);
    }

    .bill-btn:active {
        transform: scale(0.94);
    }

    .bill-btn .bill-icon {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 4px;
    }

    /* ---- Bill List ---- */
    .bill-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--apple-bg);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        font-size: 0.95rem;
        animation: fadeSlideIn 0.3s var(--ease-apple);
    }

    @keyframes fadeSlideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .bill-value-tag {
        font-weight: 800;
        padding: 6px 16px;
        border-radius: var(--radius-pill);
        font-size: 0.95rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .bill-remove-btn {
        background: rgba(255, 59, 48, 0.1);
        border: 1.5px solid rgba(255, 59, 48, 0.2);
        border-radius: 12px;
        cursor: pointer;
        color: var(--apple-red);
        font-size: 0.85rem;
        font-weight: 600;
        font-family: var(--font-family);
        padding: 8px 16px;
        min-height: 44px;
        transition: all 0.3s var(--ease-apple);
        -webkit-tap-highlight-color: transparent;
    }

    .bill-remove-btn:hover {
        background: rgba(255, 59, 48, 0.18);
        border-color: var(--apple-red);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
    }

    .bill-remove-btn:active {
        transform: scale(0.95);
    }

    /* ---- Remove Player ---- */
    .remove-player-btn {
        font-family: var(--font-family);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--apple-red);
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--space-md) 0;
        margin-top: var(--space-sm);
        width: 100%;
        opacity: 0.8;
        transition: opacity var(--transition-fast);
        text-align: center;
    }

    .remove-player-btn:hover {
        opacity: 1;
        text-decoration: underline;
    }

    /* ---- Action Buttons Area ---- */
    .action-area {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        padding: var(--space-lg) 0;
        margin-bottom: var(--space-xl);
    }

    .action-area .apple-btn-success {
        box-shadow: 0 6px 20px rgba(52, 199, 89, 0.3);
        font-weight: 700;
        padding: 0 32px;
        border-radius: 30px;
    }

    /* ---- End Game Overlay ---- */
    .end-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .end-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }

    .end-modal {
        background: var(--apple-bg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 380px;
        overflow: hidden;
        transform: scale(0.95) translateY(20px);
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .end-overlay.show .end-modal {
        transform: scale(1) translateY(0);
    }

    .end-modal-header {
        text-align: center;
        padding: var(--space-xl) var(--space-lg) var(--space-md);
    }

    .end-modal-header h3 {
        font-size: 1.35rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 6px;
    }

    .end-modal-header p {
        font-size: 0.9rem;
        color: var(--apple-gray);
        font-weight: 500;
    }

    .end-modal-body {
        padding: 0 var(--space-lg) var(--space-lg);
    }

    .end-modal-result {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.08);
        font-size: 1rem;
    }

    .end-modal-result:last-child {
        border-bottom: none;
    }

    .end-modal-actions {
        display: flex;
        gap: var(--space-md);
        padding: 0 var(--space-lg) var(--space-xl);
    }

    .end-modal-actions .apple-btn {
        flex: 1;
        font-weight: 600;
        padding: 14px 0;
        border-radius: 20px;
        font-size: 1.05rem;
    }

    /* ---- Tile Buttons Row ---- */
    .tile-btn-row {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        padding: var(--space-lg) 0;
        margin-bottom: var(--space-lg);
    }

    .tile-action-btn {
        font-family: var(--font-family);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        border: none;
        border-radius: 30px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.35s cubic-bezier(0.25, 1, 0.5, 1);
        letter-spacing: -0.01em;
    }

    .tile-action-btn:active {
        transform: scale(0.95);
    }

    .tile-btn-setup {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white;
        box-shadow: 0 6px 20px rgba(108, 92, 231, 0.35);
    }

    .tile-btn-setup:hover {
        box-shadow: 0 8px 28px rgba(108, 92, 231, 0.45);
        transform: translateY(-2px);
    }

    .tile-btn-info {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        box-shadow: 0 6px 20px rgba(0, 184, 148, 0.35);
    }

    .tile-btn-info:hover {
        box-shadow: 0 8px 28px rgba(0, 184, 148, 0.45);
        transform: translateY(-2px);
    }

    /* ---- Tile Modal ---- */
    .tile-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .tile-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }

    .tile-modal {
        background: var(--apple-bg);
        border-radius: var(--radius-xl);
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 480px;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: scale(0.95) translateY(20px);
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .tile-overlay.show .tile-modal {
        transform: scale(1) translateY(0);
    }

    .tile-modal-header {
        text-align: center;
        padding: var(--space-xl) var(--space-lg) var(--space-md);
        flex-shrink: 0;
    }

    .tile-modal-header h3 {
        font-size: 1.35rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 4px;
    }

    .tile-modal-header p {
        font-size: 0.9rem;
        color: var(--apple-gray);
        font-weight: 500;
    }

    .tile-modal-body {
        padding: 0 var(--space-lg) var(--space-md);
        overflow-y: auto;
        flex: 1;
        -webkit-overflow-scrolling: touch;
    }

    .tile-modal-body::-webkit-scrollbar {
        width: 4px;
    }

    .tile-modal-body::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 4px;
    }

    .tile-card {
        background: var(--apple-white);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.04);
        transition: all 0.3s var(--ease-apple);
    }

    .tile-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .tile-card-top {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: 10px;
    }

    .tile-casino-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 800;
        color: white;
        flex-shrink: 0;
    }

    .tile-casino-1 {
        background: linear-gradient(135deg, #e17055, #d63031);
    }

    .tile-casino-2 {
        background: linear-gradient(135deg, #fdcb6e, #f39c12);
    }

    .tile-casino-3 {
        background: linear-gradient(135deg, #00b894, #00a085);
    }

    .tile-casino-4 {
        background: linear-gradient(135deg, #0984e3, #0652DD);
    }

    .tile-casino-5 {
        background: linear-gradient(135deg, #6c5ce7, #5b4bd5);
    }

    .tile-casino-6 {
        background: linear-gradient(135deg, #e84393, #c44569);
    }

    .tile-name-block {
        flex: 1;
    }

    .tile-name {
        font-size: 1.05rem;
        font-weight: 800;
        letter-spacing: -0.01em;
        color: var(--apple-black);
    }

    .tile-id-tag {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--apple-gray);
        margin-top: 1px;
    }

    .tile-trigger {
        display: inline-block;
        padding: 4px 10px;
        border-radius: var(--radius-pill);
        background: rgba(108, 92, 231, 0.1);
        color: #6c5ce7;
        font-size: 0.75rem;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .tile-desc {
        font-size: 0.88rem;
        color: #444;
        line-height: 1.6;
        font-weight: 500;
    }

    .tile-bills-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .tile-bills-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--apple-gray);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        flex-shrink: 0;
    }

    .tile-bill-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 12px;
        border-radius: var(--radius-pill);
        font-size: 0.85rem;
        font-weight: 800;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .tile-bills-total {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--apple-blue);
        margin-left: auto;
        flex-shrink: 0;
    }

    .tile-modal-footer {
        padding: var(--space-md) var(--space-lg) var(--space-xl);
        flex-shrink: 0;
        text-align: center;
    }

    .tile-modal-close-btn {
        font-family: var(--font-family);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 12px 32px;
        border: none;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        background: var(--apple-bg);
        color: var(--apple-gray);
        border: 1px solid rgba(0, 0, 0, 0.1);
        transition: all 0.3s var(--ease-apple);
    }

    .tile-modal-close-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--apple-black);
    }

    .tile-modal-close-btn:active {
        transform: scale(0.96);
    }

    /* Bill Color overrides */
    .bill-30 {
        background: rgba(175, 82, 222, 0.12);
        color: #7d3c98;
    }

    .bill-40 {
        background: rgba(255, 149, 0, 0.12);
        color: #cc7700;
    }

    .bill-50 {
        background: rgba(255, 59, 48, 0.12);
        color: #cc2418;
    }

    .bill-60 {
        background: rgba(90, 200, 250, 0.15);
        color: #0891b2;
    }

    .bill-70 {
        background: rgba(255, 204, 0, 0.15);
        color: #b38600;
    }

    .bill-80 {
        background: rgba(52, 199, 89, 0.12);
        color: #1a9c4a;
    }

    .bill-90 {
        background: rgba(0, 113, 227, 0.12);
        color: #0059b3;
    }

    .bill-100 {
        background: rgba(255, 59, 48, 0.08);
        color: #e11d48;
    }
</style>
{% endblock %}

{% block nav_title %}
<i class="ph-fill ph-dice-six text-green" style="margin-right: 4px;"></i> æ‹‰æ–¯ç»´åŠ æ–¯
{% endblock %}

{% block content %}
<div id="app" x-data="lvApp()" x-init="init()" x-cloak>

    <!-- Hero -->
    <div class="apple-hero">
        <span class="apple-hero-emoji">ğŸ°</span>
        <h1>æ‹‰æ–¯ç»´åŠ æ–¯</h1>
        <p>æ¬¢ä¹æ·éª° Â· åŒºåŸŸäº‰å¤º</p>
    </div>

    <!-- Add Player -->
    <div class="section-title">æ·»åŠ ç©å®¶</div>
    <div class="add-player-row">
        <input class="apple-input" type="text" placeholder="è¾“å…¥ç©å®¶åç§°" maxlength="12" autocomplete="off"
            x-model="newPlayerName" @keydown.enter="addPlayer()">
        <button class="apple-btn apple-btn-primary" @click="addPlayer()">
            <i class="ph-bold ph-plus"></i> æ·»åŠ 
        </button>
    </div>

    <!-- Current Game Leaderboard -->
    <div class="section-title">ğŸ’° æœ¬å±€æ’è¡Œ</div>
    <div class="apple-list mb-md" x-show="ranked.length === 0">
        <div class="empty-state">
            <span class="empty-icon">ğŸƒ</span>
            æ·»åŠ ç©å®¶å¼€å§‹è®¡ç®—
        </div>
    </div>
    <div class="apple-list mb-md" x-show="ranked.length > 0">
        <template x-for="(p, idx) in ranked" :key="p.name">
            <div class="apple-list-item">
                <div class="rank-num" :class="getRankClass(idx, p)">
                    <span x-text="getRankIcon(idx, p)"></span>
                </div>
                <div class="apple-list-item-content">
                    <div class="apple-list-item-title">
                        <span x-text="p.name"></span>
                        <span class="lb-tie-badge" x-show="isTied(p)">å¹³å±€</span>
                    </div>
                </div>
                <div style="text-align: right; display: flex; align-items: center; gap: 16px;">
                    <div style="text-align: right; width: 40px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">å¼ æ•°</div>
                        <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);"
                            x-text="p.bill_count + 'å¼ '"></div>
                    </div>
                    <div style="text-align: right; width: 60px;">
                        <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">é‡‘é¢</div>
                        <div class="score-badge" style="font-size: 1.2rem; color: var(--apple-green);"
                            x-text="p.total_amount + 'ä¸‡'"></div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Action Buttons -->
    <div class="action-area" x-show="ranked.length > 0">
        <button class="apple-btn apple-btn-success apple-btn-lg" @click="showEndOverlay = true">
            <i class="ph-fill ph-flag-checkered" style="margin-right:6px;"></i> ç»“æŸæœ¬å±€
        </button>
        <button class="apple-btn apple-btn-secondary" @click="resetGame()"
            style="padding:0 24px; border-radius:30px; font-weight:600;">
            <i class="ph-bold ph-arrow-clockwise"></i> é‡ç½®
        </button>
    </div>

    <!-- Player Cards -->
    <div class="section-title">ğŸƒ ç©å®¶é’ç¥¨</div>
    <div class="player-section">
        <template x-for="(p, idx) in players" :key="p.name">
            <div class="player-card">
                <div class="player-card-header" @click="togglePlayer(p.name)">
                    <div class="player-card-left">
                        <div class="player-card-avatar" :style="'background:' + getAvatarColor(idx)"
                            x-text="p.name.charAt(0).toUpperCase()"></div>
                        <div>
                            <div class="player-card-name" x-text="p.name"></div>
                            <div class="player-card-summary"
                                x-text="p.total_amount + 'ä¸‡ Â· ' + p.bill_count + 'å¼ é’ç¥¨'"></div>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right player-card-chevron"
                        :class="{ open: isExpanded(p.name) }"></i>
                </div>
                <div class="player-card-body" :class="{ open: isExpanded(p.name) }">
                    <div class="section-title" style="margin-top:var(--space-xs)">æ·»åŠ é’ç¥¨</div>
                    <div class="bill-grid">
                        <template x-for="v in DENOMINATIONS" :key="v">
                            <button class="bill-btn" @click="addBill(p.name, v)">
                                <span class="bill-icon">ğŸ’µ</span>
                                <span x-text="v + 'ä¸‡'"></span>
                            </button>
                        </template>
                    </div>
                    <div class="section-title">é’ç¥¨æ˜ç»†</div>
                    <div class="bill-list">
                        <div x-show="!p.bills || !p.bills.length"
                            style="text-align:center;color:var(--apple-gray);font-size:0.9rem;font-weight:500;padding:var(--space-md) 0;">
                            æš‚æ— é’ç¥¨</div>
                        <template x-for="b in (p.bills || [])" :key="b.id">
                            <div class="bill-item">
                                <span class="bill-value-tag" :class="'bill-' + b.value"
                                    x-text="b.value + 'ä¸‡'"></span>
                                <button class="bill-remove-btn" @click="removeBill(p.name, b.id)">
                                    <i class="ph-bold ph-x"></i> ç§»é™¤
                                </button>
                            </div>
                        </template>
                    </div>
                    <button class="remove-player-btn" @click="removePlayer(p.name)">
                        <i class="ph-bold ph-trash" style="margin-right: 4px;"></i>ç§»é™¤æ­¤ç©å®¶
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Historical Leaderboard -->
    <div id="inline-leaderboard-section">
        <div class="section-title" style="margin-top: var(--space-xl); margin-bottom: var(--space-md);">ğŸ† å†å²æ’è¡Œæ¦œ
        </div>
        <div class="apple-list mb-xl" x-show="histLeaderboard.length === 0">
            <div class="empty-state">
                <span class="empty-icon">ğŸ‘»</span>
                è¿˜æ²¡äººç©è¿‡å‘¢ï¼Œå¿«å»å¼€ä¸€å±€ï¼
            </div>
        </div>
        <div class="apple-list mb-xl" x-show="histLeaderboard.length > 0">
            <template x-for="(p, idx) in histLeaderboard" :key="p.name">
                <div class="apple-list-item">
                    <div class="rank-num" :class="getRankClass(idx, p)">
                        <span x-text="getRankIcon(idx, p)"></span>
                    </div>
                    <div class="apple-list-item-content">
                        <div class="apple-list-item-title" x-text="p.name"></div>
                    </div>
                    <div style="text-align: right; display: flex; align-items: center; gap: 16px;">
                        <div style="text-align: right; width: 60px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">æ€»è®¡</div>
                            <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);"
                                x-text="p.total_amount + 'ä¸‡'"></div>
                        </div>
                        <div style="text-align: right; width: 60px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">åœºå‡</div>
                            <div class="score-badge" style="font-size: 1.2rem; color: var(--apple-green);"
                                x-text="p.avg_amount > 0 ? p.avg_amount + 'ä¸‡' : '--'"></div>
                        </div>
                        <div style="text-align: right; width: 60px;">
                            <div class="history-trail" style="font-size: 0.7rem; margin-bottom: 2px;">ä¸Šåœº</div>
                            <div class="score-badge" style="font-size: 1.1rem; color: var(--apple-gray);"
                                x-text="p.last_game_amount > 0 ? '+' + p.last_game_amount + 'ä¸‡' : '--'"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Tile Action Buttons -->
    <div class="tile-btn-row">
        <button class="tile-action-btn tile-btn-setup" @click="setupField()">
            <i class="ph-fill ph-dice-five"></i> å¸ƒç½®åœºåœ°
        </button>
        <button class="tile-action-btn tile-btn-info" @click="openFieldInfo()">
            <i class="ph-bold ph-book-open"></i> åœºåœ°è¯´æ˜
        </button>
    </div>

    <!-- ===== MODALS (position:fixed, inside Alpine scope) ===== -->

    <!-- End Game Overlay -->
    <div class="end-overlay" :class="{ show: showEndOverlay }" @click.self="showEndOverlay = false">
        <div class="end-modal" @click.stop>
            <div class="end-modal-header">
                <h3>ğŸ ç»“æŸæœ¬å±€</h3>
                <p>ä»¥ä¸‹ç»“æœå°†è®°å½•åˆ°æ’è¡Œæ¦œ</p>
            </div>
            <div class="end-modal-body">
                <template x-for="(p, idx) in ranked" :key="'end-' + p.name">
                    <div class="end-modal-result">
                        <span style="font-weight:600" x-text="(idx + 1) + '. ' + p.name"></span>
                        <span>
                            <span style="font-weight:800;color:var(--apple-green)" x-text="p.total_amount + 'ä¸‡'"></span>
                            <span
                                style="font-weight:600; font-size: 0.85rem; color: var(--apple-gray)"
                                x-text="' Â· ' + p.bill_count + 'å¼ '"></span>
                        </span>
                    </div>
                </template>
            </div>
            <div class="end-modal-actions">
                <button class="apple-btn apple-btn-secondary" @click="showEndOverlay = false">å–æ¶ˆ</button>
                <button class="apple-btn apple-btn-success" @click="confirmEndGame()">
                    <i class="ph-bold ph-check"></i> ç¡®è®¤ç»“æŸ
                </button>
            </div>
        </div>
    </div>

    <!-- Setup Field Modal -->
    <div class="tile-overlay" :class="{ show: showSetupOverlay }" @click.self="showSetupOverlay = false">
        <div class="tile-modal" @click.stop>
            <div class="tile-modal-header">
                <h3>ğŸ² åœºåœ°å¸ƒç½®ç»“æœ</h3>
                <p>æ¯ä¸ªèµŒåœºå·²éšæœºåˆ†é…ä¸€å—æ‹“å±•æ¿å—</p>
            </div>
            <div class="tile-modal-body">
                <template x-if="field">
                    <div>
                        <template x-for="item in field" :key="item.casino">
                            <div class="tile-card">
                                <div class="tile-card-top">
                                    <div class="tile-casino-badge" :class="'tile-casino-' + item.casino"
                                        x-text="item.casino"></div>
                                    <div class="tile-name-block">
                                        <div class="tile-name" x-text="item.tile.name"></div>
                                        <div class="tile-id-tag"
                                            x-text="item.tile.id + ' Â· ' + item.tile.group + 'ç»„'"></div>
                                    </div>
                                </div>
                                <div class="tile-trigger" x-text="item.tile.trigger"></div>
                                <template x-if="item.bills && item.bills.length > 0">
                                    <div class="tile-bills-row">
                                        <span class="tile-bills-label">å¥–é‡‘</span>
                                        <template x-for="v in item.bills" :key="$id('bill')">
                                            <span class="tile-bill-tag" :class="'bill-' + v"
                                                x-text="'$' + v + 'k'"></span>
                                        </template>
                                        <span class="tile-bills-total"
                                            x-text="'åˆè®¡ ' + billsTotal(item.bills) + 'ä¸‡'"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            <div class="tile-modal-footer">
                <button class="tile-modal-close-btn" @click="showSetupOverlay = false">
                    <i class="ph-bold ph-x"></i> å…³é—­
                </button>
            </div>
        </div>
    </div>

    <!-- Field Info Modal -->
    <div class="tile-overlay" :class="{ show: showInfoOverlay }" @click.self="showInfoOverlay = false">
        <div class="tile-modal" @click.stop>
            <div class="tile-modal-header">
                <h3>ğŸ“– åœºåœ°è¯´æ˜</h3>
                <p>å½“å‰å„èµŒåœºæ‹“å±•æ¿å—çš„è¯¦ç»†è§„åˆ™</p>
            </div>
            <div class="tile-modal-body">
                <template x-if="field">
                    <div>
                        <template x-for="item in field" :key="item.casino">
                            <div class="tile-card">
                                <div class="tile-card-top">
                                    <div class="tile-casino-badge" :class="'tile-casino-' + item.casino"
                                        x-text="item.casino"></div>
                                    <div class="tile-name-block">
                                        <div class="tile-name" x-text="item.tile.name"></div>
                                        <div class="tile-id-tag"
                                            x-text="item.tile.id + ' Â· ' + item.tile.group + 'ç»„'"></div>
                                    </div>
                                </div>
                                <div class="tile-trigger" x-text="item.tile.trigger"></div>
                                <div class="tile-desc" x-text="item.tile.desc"></div>
                                <template x-if="item.bills && item.bills.length > 0">
                                    <div class="tile-bills-row">
                                        <span class="tile-bills-label">å¥–é‡‘</span>
                                        <template x-for="v in item.bills" :key="$id('bill')">
                                            <span class="tile-bill-tag" :class="'bill-' + v"
                                                x-text="'$' + v + 'k'"></span>
                                        </template>
                                        <span class="tile-bills-total"
                                            x-text="'åˆè®¡ ' + billsTotal(item.bills) + 'ä¸‡'"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            <div class="tile-modal-footer">
                <button class="tile-modal-close-btn" @click="showInfoOverlay = false">
                    <i class="ph-bold ph-x"></i> å…³é—­
                </button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_body %}
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
    // ---- Tile Data (static) ----
    const TILES = [
        { id: 'A1', name: 'Lucky Punch', group: 'A', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'ç©å®¶åœ¨æ¡Œä¸‹æ‰‹é‡Œæš—è— 1~3 ä¸ªæŒ‡ç¤ºç‰©ï¼Œç”±å·¦æ‰‹è¾¹ç©å®¶çŒœæ•°é‡ã€‚çŒœé”™ï¼Œå¯åŠ¨ç©å®¶è·å¾—é¢æ¿å¯¹åº”å¥–åŠ±ï¼ˆåœ†ç‰‡æˆ–ç°é‡‘ï¼‰ï¼›çŒœå¯¹ï¼Œæ— äº‹å‘ç”Ÿã€‚' },
        { id: 'A2', name: 'Jackpot', group: 'A', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'æ· 2 é¢—é»‘éª°å­ã€‚è‹¥æ€»å’Œä¸º 7 æˆ–æ·å‡ºè±¹å­ï¼ˆåŒç‚¹æ•°ï¼‰ï¼Œç›´æ¥æ‹¿èµ°å¤§å¥–æŒ‡ç¤ºç‰©å½“å‰ç›–ä½çš„å¥–é‡‘ï¼Œå¹¶å°†æŒ‡ç¤ºç‰©é‡ç½®å› $30,000ï¼›è‹¥æœªè¾¾æˆï¼Œå°†å¤§å¥–æŒ‡ç¤ºç‰©å‘å³æ¨ç§» 1 æ ¼ï¼ˆå¥–é‡‘å˜åšï¼‰ã€‚' },
        { id: 'B1', name: 'Prime-Time', group: 'B', trigger: 'é¢å‘å¥–é‡‘å‰', desc: 'è¯¥èµŒåœºæœ€å¤§èµ¢å®¶å¯æ· 2 é¢—é»‘éª°å­ï¼Œå¹¶å°† 0~2 é¢—é»‘éª°åˆ†é…åˆ°å¯¹åº”èµŒåœºã€‚åœ¨éšåçš„ç»“ç®—ä¸­ï¼Œè¿™äº›é»‘éª°è§†ä¸ºè¯¥èµ¢å®¶çš„æœ‰æ•ˆæˆ˜åŠ›ã€‚' },
        { id: 'B2', name: 'Fifty-Fifty', group: 'B', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'æ· 2 é¢—é»‘éª°å¹¶æ¨è¿›å¥–åŠ±æ ‡è®°ã€‚ç©å®¶å¯éšæ—¶è§å¥½å°±æ”¶æ‹¿èµ°å½“å‰å¥–é‡‘ï¼›è‹¥ç»§ç»­æŒ‘æˆ˜ï¼Œå¿…é¡»ç›²çŒœä¸‹ä¸€æ¬¡æ·éª°ç»“æœæ¯”è¿™æ¬¡é«˜æˆ–ä½ã€‚çŒœå¯¹å¯ç»§ç»­æˆ–æ‹¿å¥–é‡‘ï¼›çŒœé”™ï¼ˆæˆ–å¹³å±€ï¼‰ï¼Œç›´æ¥è¾“æ‰æŒ‘æˆ˜ï¼Œé¢—ç²’æ— æ”¶ã€‚' },
        { id: 'C1', name: 'High-Five', group: 'C', trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶', desc: 'å½“ä½ åœ¨æ­¤èµŒåœºæ”¾æ»¡ç¬¬ 5 ä¸ªéª°å­ï¼ˆå¤§éª°å­ç®— 2 ä¸ªï¼‰æ—¶ï¼Œæ‹¿å–"å‡»æŒæ ‡è®°"ã€‚ç»“ç®—æ—¶å¯ç›´æ¥å…‘æ¢æˆé’ç¥¨ã€‚' },
        { id: 'C2', name: 'Bad-Luck', group: 'C', trigger: 'é¢å‘å¥–é‡‘å‰', desc: 'åœ¨æ­¤èµŒåœºæ”¾ç½®éª°å­æœ€å°‘ï¼ˆåŒ…æ‹¬ 0 ä¸ªï¼‰çš„ç©å®¶ï¼Œæœ¬è½®ç»“æŸæ—¶å¿…é¡»å‘é“¶è¡Œå€’æ‰£ $50,000ï¼ˆå¯ç”¨åœ†ç‰‡æŠµæ‰£ï¼Œé’±ä¸å¤Ÿåˆ™å…¨æ‰£å…‰ï¼‰ã€‚' },
        { id: 'D1', name: 'Pay-Day', group: 'D', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'è®¡ç®—åœºä¸Šå…¨ç›˜æœ‰ä½ éª°å­çš„èµŒåœºæ•°é‡ï¼Œæ•°é‡ x $10,000 å³ä¸ºä½ çš„æ”¶ç›Šï¼ˆ$1ä¸‡~$2ä¸‡å‘åœ†ç‰‡ï¼Œ$3ä¸‡~$6ä¸‡å‘é’ç¥¨ï¼‰ã€‚' },
        { id: 'D2', name: 'Power-Play', group: 'D', trigger: 'å¯åŠ¨æ¿å—æ—¶ / ä¸‹å›åˆå¼€å§‹å‰', desc: 'æ”¾éª°å­åè‹¥ä½ åœ¨æ­¤å¤„éª°å­æ•°å…¨åœºæœ€å¤šï¼Œå¤ºå¾—ç‰¹æƒæ ‡è®°ã€‚è‹¥æŠŠæ ‡è®°ä¿æŒåˆ°ä½ çš„ä¸‹ä¸ªå›åˆï¼Œä½ å¯ä»¥ä¸æ·éª°å­ï¼Œç›´æ¥å°†æ‰‹é‡Œ 1 é¢—éª°å­è½¬åˆ°ä»»æ„ç‚¹æ•°æ”¾è¿›å¯¹åº”èµŒåœºã€‚å¤±å»æ•°é‡ä¼˜åŠ¿åˆ™éœ€äº¤è¿˜æ ‡è®°ã€‚' },
        { id: 'E1', name: 'No-Entry!', group: 'E', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'å°†"ç¦æ­¢è¿›å…¥"æ ‡è®°æ”¾åˆ°å…¶ä»–ä»»æ„èµŒåœºï¼Œå½»åº•å°æ­»è¯¥åŒºåŸŸï¼ˆä¸èƒ½è¿›å‡ºéª°å­ï¼Œæ¿å—å¤±æ•ˆï¼‰ã€‚åŒæ—¶ä½ åœ¨æœ¬æ¿å—çš„å¥–åŠ±è¿›åº¦æ¡å‰è¿›å¹¶æ‹¿å¥–ã€‚åç»­å¯åŠ¨æ­¤æ¿å—çš„ç©å®¶å¯é€‰æ‹©æ˜¯å¦è½¬ç§»è¯¥å°é”æ ‡è®°ã€‚' },
        { id: 'E2', name: 'Knockout', group: 'E', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'æ‰€æœ‰äººå¿…é¡»å¾€æ­¤æ¿å—æ”¾ 1 é¢—å‰©éª°ï¼ˆæœ€å¤šæ”¾ 2 é¢—ï¼Œå¤§éª°ç®— 1 é¢—ï¼Œæ­¤æ¿å—ä¸å‚ä¸åˆ†é’±ï¼‰ã€‚éšåï¼Œä½ å¯ä»¥æŠŠè¢«åˆ«äººå¼ºåˆ¶å¡åˆ°è¿™é‡Œçš„è‡ªå·±çš„éª°å­æ‹¿å›æ¥ã€‚' },
        { id: 'F1', name: 'Block-It!', group: 'F', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'æ‹¿å–æ¿å—ä¸Šé¢„è®¾çš„ä¸€ç»„ç°éª°å­ï¼ˆå……å½“ä¸­ç«‹ç©å®¶ï¼‰ï¼Œç©ºé™åˆ°ä»»æ„èµŒåœºå»ç ´ååˆ«äººçš„æ•°é‡ä¼˜åŠ¿ï¼ˆåˆ¶é€ å¹³å±€ï¼‰ã€‚' },
        { id: 'F2', name: 'Handicap', group: 'F', trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶', desc: 'æ¸¸æˆåˆå§‹å„èµŒåœºæœ‰ç°éª°ï¼ˆä¸­ç«‹åŠ¿åŠ›ï¼‰ã€‚å¯åŠ¨æ—¶ï¼Œä½ å¯ä»¥ä»ä»»æ„èµŒåœºæ‹¿ 1 é¢—ç°éª°æ”¾åˆ°æœ¬æ¿å—çš„åœ†åœˆå†…ï¼Œæ¢å–å¯¹åº”å¥–åŠ±ï¼ˆåœ†ç‰‡ã€é’±ã€æˆ–æ”¹ç‚¹æ•°æ”¾éª°/æ”¶å›éª°å­ï¼‰ã€‚ç•™åœ¨èµŒåœºçš„ç°éª°ç»“ç®—æ—¶ä¾ç„¶ä¼šé˜»ç¢ç©å®¶æ‹¿é’±ã€‚' },
        { id: 'G1', name: 'Black-Box', group: 'G', trigger: 'é¢å‘å¥–é‡‘æ—¶', desc: 'è¯¥èµŒåœºæœ€å¤§èµ¢å®¶çš„å·¦æ‰‹è¾¹ç©å®¶ï¼Œå°† 6 ä¸ªé¢æœä¸Šçš„å¥–åŠ±æ ‡è®°æš—ä¸­åˆ†ä¸ºä¸¤å †ã€‚æœ€å¤§èµ¢å®¶ç›²é€‰å…¶ä¸­ä¸€å †æ‹¿èµ°å¥–åŠ±ï¼ˆå……æ»¡å¿ƒç†åšå¼ˆçš„"ä½ åˆ†æˆ‘é€‰"ï¼‰ã€‚' },
        { id: 'G2', name: 'Double-Down', group: 'G', trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶', desc: 'å¯åŠ¨æ—¶ï¼Œå¯å°†è‡ªå·±åœ¨æ­¤èµŒåœºçš„éª°å­ç§»åˆ°æœ¬æ¿å—ä¸Šã€‚ç»“ç®—æ—¶ï¼Œæœ¬æ¿å—å¦‚åŒä¸€ä¸ªç‹¬ç«‹çš„å°èµŒåœºå•ç‹¬å‘é’±ï¼ˆç¬¬ä¸€å 6 ä¸‡ï¼Œç¬¬äºŒå 3 ä¸‡ï¼‰ï¼Œä¸”ä¸å—å…¶ä»–è¡ŒåŠ¨å¹²æ‰°ã€‚' },
        { id: 'H1', name: 'Nice-Dice', group: 'H', trigger: 'å¯åŠ¨æ¿å—æ—¶ / é¢å‘å¥–é‡‘æ—¶', desc: 'å°†åˆšæ·å‡ºæˆ–æ”¾å…¥çš„éª°å­æŒ‰ç‚¹æ•°æ”¾è¿›æœ¬æ¿å—æ ¼å­ã€‚å¦‚æœæ ¼å­é‡Œæœ‰åˆ«äººçš„éª°å­ï¼Œç›´æ¥æŠŠä»–"æŒ¤"å›å¯¹åº”ç‚¹æ•°çš„æ™®é€šèµŒåœºå»ã€‚ç»“ç®—æ—¶ï¼Œç•™åœ¨æ ¼å­é‡Œçš„éª°å­ä¸»äººæ‹¿å¯¹åº”å¥–åŠ±ã€‚' },
        { id: 'H2', name: 'My-Choice', group: 'H', trigger: 'å¯åŠ¨æ¿å—æ—¶', desc: 'æ· 2 é¢—é»‘éª°ï¼Œé€‰ 1 ä¸ªç»“æœæ‰§è¡ŒåŠ¨ä½œï¼šæ‹¿ç­¹ç ã€æ‹¿é’±ã€ç™½å«–ä¸€æ¬¡å…¶ä»–æ¿å—èƒ½åŠ›ã€æ”¹ 1 é¢—éª°å­ç‚¹æ•°æ”¾å›åœºä¸Š/æ”¶å›æ‰‹é‡Œï¼Œæˆ–è€…æŠŠéª°å­æ”¾è¿›"é‡‘æ¡†"ï¼ˆä¼šæŠŠåˆ«äººçš„æŒ¤å‡ºå»ï¼‰ï¼Œç»“ç®—æ—¶ç‹¬èµ¢ 6 ä¸‡ã€‚' },
    ];
    const TILE_BY_ID = Object.fromEntries(TILES.map(t => [t.id, t]));

    function lvApp() {
        const BASE = '/lasvegas';
        const BILL_POOL = { 30: 11, 40: 11, 50: 13, 60: 15, 70: 13, 80: 11, 90: 9, 100: 7 };
        const AVATAR_COLORS = [
            '#0984e3', '#00b894', '#e17055', '#6c5ce7',
            '#fdcb6e', '#e84393', '#00cec9', '#d63031',
            '#a29bfe', '#55a3e8'
        ];

        return {
            // ---- Reactive State ----
            players: [],
            ranked: [],
            histLeaderboard: [],
            field: null,
            expandedPlayers: [],
            newPlayerName: '',
            showEndOverlay: false,
            showSetupOverlay: false,
            showInfoOverlay: false,
            lvSocket: null,
            DENOMINATIONS: [30, 40, 50, 60, 70, 80, 90, 100],

            // ---- Computed Helpers ----
            getRankClass(idx, p) {
                const rank = idx + 1;
                if (rank === 1 && p.total_amount > 0) return 'rank-1';
                if (rank === 2) return 'rank-2';
                if (rank === 3) return 'rank-3';
                return 'rank-other';
            },
            getRankIcon(idx, p) {
                return (idx === 0 && p.total_amount > 0) ? 'ğŸ‘‘' : idx + 1;
            },
            isTied(p) {
                return this.ranked.filter(r => r.total_amount === p.total_amount).length > 1 && p.total_amount > 0;
            },
            getAvatarColor(idx) {
                return AVATAR_COLORS[idx % AVATAR_COLORS.length];
            },
            isExpanded(name) {
                return this.expandedPlayers.includes(name);
            },
            billsTotal(bills) {
                return bills ? bills.reduce((s, v) => s + v, 0) : 0;
            },

            // ---- UI Actions ----
            togglePlayer(name) {
                const i = this.expandedPlayers.indexOf(name);
                if (i >= 0) this.expandedPlayers.splice(i, 1);
                else this.expandedPlayers.push(name);
            },

            // ---- API Helpers ----
            async apiPost(path, body = {}) {
                const res = await fetch(BASE + path, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return res.json();
            },
            async apiGet(path) {
                const res = await fetch(BASE + path);
                return res.json();
            },

            // ---- Bill Pool Logic ----
            getRemainingPool() {
                const remaining = { ...BILL_POOL };
                this.players.forEach(p => {
                    if (p.bills) {
                        p.bills.forEach(b => {
                            if (remaining[b.value] !== undefined) {
                                remaining[b.value] = Math.max(0, remaining[b.value] - 1);
                            }
                        });
                    }
                });
                return remaining;
            },

            // ---- Player Management ----
            async addPlayer() {
                const name = this.newPlayerName.trim();
                if (!name) return;
                const res = await this.apiPost('/api/add_player', { name });
                if (res.status === 'exists') {
                    showToast('ç©å®¶å·²å­˜åœ¨', 'error');
                    return;
                }
                this.newPlayerName = '';
                this.expandedPlayers.push(name);
                showToast(`${name} å·²åŠ å…¥`, 'success');
                await this.refresh();
            },

            async removePlayer(name) {
                if (!confirm(`ç¡®å®šç§»é™¤ ${name}ï¼Ÿ`)) return;
                await this.apiPost('/api/remove_player', { name });
                const i = this.expandedPlayers.indexOf(name);
                if (i >= 0) this.expandedPlayers.splice(i, 1);
                showToast(`${name} å·²ç§»é™¤`);
                await this.refresh();
            },

            // ---- Bill Management ----
            async addBill(playerName, value) {
                const pool = this.getRemainingPool();
                if (pool[value] > 0) {
                    await this.apiPost('/api/add_bill', { player_name: playerName, value });
                    await this.refresh();
                    return;
                }

                const player = this.players.find(p => p.name === playerName);
                if (!player) return;

                const playerBills = player.bills || [];
                const uniquePlayerValues = [...new Set(playerBills.map(b => b.value))].sort((a, b) => a - b);

                // Strategy A: larger bill from pool, return smaller to player
                for (const v_have of uniquePlayerValues) {
                    const v_new = value + v_have;
                    if (pool[v_new] > 0) {
                        const billToRemove = playerBills.find(b => b.value === v_have);
                        await this.apiPost('/api/remove_bill', { player_name: playerName, bill_id: billToRemove.id });
                        await this.apiPost('/api/add_bill', { player_name: playerName, value: v_new });
                        showToast(`${value}ä¸‡å·²ç”¨å®Œï¼Œç»™ ${v_new}ä¸‡æ‰¾é›¶ ${v_have}ä¸‡`);
                        await this.refresh();
                        return;
                    }
                }

                // Strategy B: two smaller bills from pool
                const availablePoolValues = Object.keys(pool).map(Number).filter(v => pool[v] > 0).sort((a, b) => a - b);
                for (const v1 of availablePoolValues) {
                    const v2 = value - v1;
                    if (pool[v2] > 0) {
                        if (v1 === v2 && pool[v1] < 2) continue;
                        await this.apiPost('/api/add_bill', { player_name: playerName, value: v1 });
                        await this.apiPost('/api/add_bill', { player_name: playerName, value: v2 });
                        showToast(`${value}ä¸‡å·²ç”¨å®Œï¼Œæ‹†åˆ†ä¸º ${v1}ä¸‡å’Œ ${v2}ä¸‡`);
                        await this.refresh();
                        return;
                    }
                }

                showToast(`âš ï¸ ${value}ä¸‡å·²è¢«ç”¨å®Œï¼Œä¸”æ— æ³•æ‰¾é›¶ï¼`, 'error');
            },

            async removeBill(playerName, billId) {
                await this.apiPost('/api/remove_bill', { player_name: playerName, bill_id: billId });
                await this.refresh();
            },

            // ---- End Game ----
            async confirmEndGame() {
                this.showEndOverlay = false;
                const res = await this.apiPost('/api/end_game');
                if (res.status === 'error') {
                    showToast(res.msg || 'æ— æ³•ç»“æŸ', 'error');
                    return;
                }
                this.expandedPlayers = [];
                showToast('ğŸ æœ¬å±€å·²ç»“æŸï¼Œç»“æœå·²è®°å½•ï¼', 'success');
                await this.refresh();
            },

            async resetGame() {
                if (!confirm('ç¡®å®šé‡ç½®ï¼Ÿå½“å‰æ•°æ®å°†æ¸…é™¤ï¼ˆä¸å½±å“å†å²è®°å½•ï¼‰ã€‚')) return;
                await this.apiPost('/api/reset');
                this.expandedPlayers = [];
                showToast('æ¸¸æˆå·²é‡ç½®');
                await this.refresh();
            },

            // ---- Field / Tile ----
            hydrateFieldItem(item) {
                const tile = TILE_BY_ID[item.tile_id] || {
                    id: item.tile_id, name: item.tile_id,
                    group: '-', trigger: '', desc: ''
                };
                return { casino: item.casino, tile, bills: item.bills || [] };
            },

            async setupField() {
                const res = await this.apiPost('/api/setup_field');
                if (res.status !== 'ok') {
                    showToast(res.msg || 'å¸ƒç½®å¤±è´¥', 'error');
                    return;
                }
                this.field = (res.field || []).map(i => this.hydrateFieldItem(i));
                this.showSetupOverlay = true;
            },

            async openFieldInfo() {
                if (!this.field) {
                    const data = await this.apiGet('/api/field');
                    this.field = data.field ? data.field.map(i => this.hydrateFieldItem(i)) : null;
                    if (!this.field) {
                        showToast('è¯·å…ˆå¸ƒç½®åœºåœ°');
                        return;
                    }
                }
                this.showInfoOverlay = true;
            },

            // ---- Refresh ----
            async refresh() {
                const [statusData, lbData] = await Promise.all([
                    this.apiGet('/api/status'),
                    this.apiGet('/api/leaderboard')
                ]);
                this.ranked = statusData.ranked;
                this.players = statusData.players;
                this.histLeaderboard = lbData.leaderboard;
                if (statusData.field) {
                    this.field = statusData.field.map(i => this.hydrateFieldItem(i));
                }
            },

            // ---- Init ----
            async init() {
                await this.refresh();
                if (typeof io !== 'undefined') {
                    this.lvSocket = io('/', {
                        path: '/socket.io',
                        transports: ['websocket', 'polling']
                    });
                    this.lvSocket.on('state_update', payload => {
                        if (!payload || payload.game === 'lasvegas') this.refresh();
                    });
                }
            }
        };
    }
</script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
{% endblock %}
